<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI å¡«å ±èˆ‡è¦–è¦ºåŒ–ç¸½è¡¨ï¼ˆæœ¬æ©Ÿç‰ˆï¼‰</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #1e88e5;
      --primary-600: #1565c0;
      --border: #e5e7eb;

      --row-amber: #fffbeb;
      --row-blue:  #e8f4fd;
      --row-green: #e6f4ea;

      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;

      --chip: #e3f2fd;
      --banner-bg: linear-gradient(90deg,#e0f2fe, #f0f9ff);
      --banner-fg: #075985;
    }
    body[data-role="admin"]{
      --primary:#818cf8;
      --primary-600:#6366f1;
      --bg:#eef2ff;
      --banner-bg: linear-gradient(90deg,#e0e7ff,#f3e8ff);
      --banner-fg:#3730a3;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); line-height: 1.6; transition: background .25s ease; }
    .wrap { max-width: 1220px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:12px; }
    h1 { font-size: 24px; margin: 0; color: var(--primary); transition: color .25s ease; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .btn, .btn-secondary, .btn-ghost, .btn-outline, .btn-danger, .btn-login{
      border-radius:10px; padding:10px 14px; font-weight:600; border:1px solid transparent; cursor:pointer; outline:none; box-shadow:none;
      transition: background .2s, color .2s, transform .05s, opacity .2s, filter .2s, border-color .2s;
    }
    .btn, .btn:focus, .btn:focus-visible,
    .btn-secondary, .btn-secondary:focus, .btn-secondary:focus-visible,
    .btn-ghost, .btn-ghost:focus, .btn-ghost:focus-visible,
    .btn-outline, .btn-outline:focus, .btn-outline:focus-visible,
    .btn-danger, .btn-danger:focus, .btn-danger:focus-visible,
    .btn-login, .btn-login:focus, .btn-login:focus-visible { outline:none; box-shadow:none; }

    .btn { background: var(--primary); color:#fff; }
    .btn:hover{ background: var(--primary-600); }
    .btn:active{ transform: translateY(1px); }

    .btn-secondary{ background:#eef2ff; color:#4f46e5; }
    .btn-secondary:hover{ filter: brightness(.96); }

    .btn-ghost{ background:#ffffff; color:#374151; border:1px solid var(--border); }
    .btn-ghost:hover{ filter: brightness(.98); }

    .btn-outline{ background:#fff; color:#4f46e5; border:1px solid #c7d2fe; }
    .btn-outline:hover{ border-color:#a78bfa; }

    .btn-danger{ background:#ef5350; color:#fff; }
    .btn-danger:hover{ background:#d32f2f; }

    .btn-login{
      border-radius:999px; padding:8px 14px; font-weight:800;
      background: linear-gradient(#fff,#fff) padding-box, linear-gradient(90deg,#93c5fd,#c4b5fd) border-box;
      color:#334155; border:1px solid transparent;
    }
    .btn-login:hover{ filter: brightness(.98); }
    .btn-login:active{ transform: translateY(0); }
    body[data-role="admin"] .btn-login{ background: linear-gradient(90deg,#818cf8,#a78bfa); color:#fff; }

    .btn-s{ height:32px; padding:0 10px; font-size:12px; border-radius:10px; border:1px solid transparent; outline:none; box-shadow:none; }
    .btn-edit{ background:#fff; color: var(--primary); border:1px solid #c7d2fe; }
    .btn-edit:hover{ color: var(--primary-600); border-color:#a78bfa; background:#fff; }
    .btn-delete{ background:#fff; color:#c2185b; border:1px solid #f8bbd0; }
    .btn-delete:hover{ color:#ad1457; border-color:#f48fb1; background:#fff; }

    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 1080px){ .grid-2 { grid-template-columns: 1.1fr 1fr; } .grid-3 { grid-template-columns: 1.1fr 1fr 1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; }
    .card h2 { margin: 0 0 12px; font-size:18px; color:#111827; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:#fff; }
    textarea{ min-height:72px; }
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 720px){ .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 1fr 1fr 1fr; } .row-4 { grid-template-columns: repeat(4,1fr); } }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom: 1px solid var(--border); text-align:center; }
    thead th { background:#f8fafc; font-size:13px; color:#374151; font-weight:600; }
    tbody td { font-size:14px; font-weight:400; }
    tbody tr:not([data-stage]):hover { background:#f9fafb; }
    tfoot td { background:#f8fafc; font-weight:700; }

    .tag { padding:4px 8px; border-radius:8px; font-weight:600; font-size:12px; }
    .tag.ok{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .tag.warn{ background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .tag.bad{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    .actions { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .tiny { font-size:12px; color:#6b7280; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#f3f4f6; border:1px solid var(--border); border-radius:999px; }

    .scroll-area{ max-height: 320px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; }
    .scroll-area thead th{ position: sticky; top: 0; z-index: 1; background: #f8fafc; box-shadow: 0 1px 0 var(--border); }

    #chips { display: none; }

    /* æ¬Šé™ */
    body[data-role="user"] [data-admin-action] { display: none !important; }
    body[data-role="user"] #threshold { opacity:.6; pointer-events:none; }
    body[data-role="user"] [data-admin-section] { display:none !important; }
    body[data-role="user"] .col-log { display:none; }

    .login-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid var(--primary); color:var(--primary-600); border-radius:999px; }
    body[data-role="admin"] .login-pill{ background:linear-gradient(90deg,#e0e7ff,#f3e8ff); color:#3730a3; border-color:#a78bfa; }

    .role-banner { display:none; position:sticky; top:0; z-index:50; padding:8px 16px; text-align:center; font-weight:800; letter-spacing:.5px; background: var(--banner-bg); color: var(--banner-fg); border-bottom:1px solid var(--border); }
    body[data-role="admin"] .role-banner{ display:block; }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px; }
    .tab-btn { background:#fff; border:1px solid var(--border); color:#374151; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; }
    .tab-btn.active { background: var(--primary); color:#fff; border-color: transparent; }
    .tab { display:none; gap:16px; }
    .tab.active { display:block; }

    /* Modal */
    .kpi-modal.hidden { display:none; }
    .kpi-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; padding:16px; }
    .kpi-modal .panel { background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; width:min(780px,92vw); }
    .kpi-modal h3{ margin:0 0 14px; font-size:20px; color:#111827; }
    .kpi-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    /* æ˜ç´°åˆ—åº•è‰² */
    tbody tr[data-stage="NOT_STARTED"] { background-color: transparent; color: inherit; }
    tbody tr[data-stage="IN_PROGRESS"] { background-color: var(--row-blue);  color: #1565c0; }
    tbody tr[data-stage="DONE"]        { background-color: var(--row-green); color: #2e7d32; }

    #chartByTask{ display:block; margin:0 auto; transform: scale(0.85); transform-origin: top center; }
  </style>
</head>
<body>
  <div class="role-banner">ç›®å‰ç‚ºã€Œç®¡ç†è€…æ¨¡å¼ã€</div>

  <div class="wrap">
    <header>
      <h1>KPI å¡«å ±èˆ‡è¦–è¦ºåŒ–ç¸½è¡¨</h1>
      <div class="toolbar">
        <span id="roleBadge" class="login-pill">è§’è‰²ï¼šä½¿ç”¨è€…</span>
        <button class="btn-login" id="loginBtn">ğŸ” ç™»å…¥</button>
        <button class="btn" id="exportCsv" data-admin-action>åŒ¯å‡º CSV</button>
        <button class="btn-danger" id="clearAll" data-admin-action>æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
      </div>
    </header>

    <!-- Tabs å°è¦½ -->
    <nav class="tabs" id="tabs">
      <button class="tab-btn active" data-tab-target="tab-dashboard">ç¸½è¦½</button>
      <button class="tab-btn" data-tab-target="tab-business">æ¥­å‹™ç´€éŒ„</button>
      <button class="tab-btn" data-tab-target="tab-behavior">è¡Œç‚ºæ—¥èªŒ</button>
      <button class="tab-btn" data-tab-target="tab-worklog">å·¥ä½œæ—¥èªŒ</button>
      <button class="tab-btn" data-tab-target="tab-calllog">é€šè¯ç´€éŒ„</button>
    </nav>

    <!-- ç¸½è¦½ -->
    <section id="tab-dashboard" class="tab active">
      <div class="grid grid-2">
        <section class="card">
          <h2>è¦–è¦ºåŒ–ç¸½è¦½</h2>
          <div class="row row-2" style="margin-bottom:8px;">
            <div>
              <label for="month">æœˆä»½</label>
              <input type="month" id="month" />
            </div>
            <div>
              <label for="filterName">å§“å</label>
              <input type="text" id="filterName" placeholder="ç¯©é¸å§“åï¼ˆå¯ç•™ç©ºï¼‰" />
            </div>
          </div>
          <canvas id="chartByPerson" height="140"></canvas>
          <canvas id="chartByTask" height="140"></canvas>
        </section>

        <section class="card">
          <h2>æ¯æœˆç¸½è¡¨ï¼ˆä¾äººå½™ç¸½ï¼‰èˆ‡è¨­å®š</h2>
          <div class="row row-2">
            <div>
              <label>é”æ¨™é–€æª»ï¼ˆ%ï¼‰</label>
              <input type="number" id="threshold" min="0" max="100" step="1" />
              <div class="tiny">å„ªç§€ â‰¥ é–€æª»Ã—1.333ï¼›é”æ¨™ â‰¥ é–€æª»ï¼›å…¶é¤˜æœªé”æ¨™ã€‚</div>
            </div>
            <div>
              <label>å¿«é€Ÿæ“ä½œ</label>
              <div class="pill"><span>ç•¶å‰æœˆä»½ï¼š</span><span id="pillMonth">â€”</span></div>
              <div style="margin-top:8px;">
                <input type="checkbox" id="onlyUnder" />
                <label for="onlyUnder">åªé¡¯ç¤ºæœªé”æ¨™ï¼ˆä»¥ã€Œæœ€çµ‚%ã€åˆ¤æ–·ï¼‰</label>
              </div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <table>
              <thead id="thead-under">
                <tr>
                  <th>å§“å</th>
                  <th>å®Œæˆç‡</th>
                  <th>è¡Œç‚ºç­‰ç´š</th>
                  <th>æœ€çµ‚%</th>
                  <th>ç‹€æ…‹</th>
                  <th class="col-log">æ—¥èªŒ</th>
                </tr>
              </thead>
              <tbody id="tbody-under"></tbody>
            </table>
            <div class="tiny" style="margin-top:6px;">è¡Œç‚ºç­‰ç´šï¼šå„ª(+5%)ï¼æ­£å¸¸(0%)ï¼å¾…æ”¹å–„(-5%)ï¼è­¦ç¤º(-10%)ï¼›æ¯æœˆæ­¸é›¶ã€‚</div>
          </div>
        </section>
      </div>

      <!-- ä»»å‹™ç®¡ç† -->
      <section class="card" style="margin-top:16px;" data-admin-section>
        <h2>ä»»å‹™é¡å‹ç®¡ç†</h2>
        <div class="row row-3">
          <div><label>ä»»å‹™åç¨±</label><input type="text" id="mTaskName" placeholder="ä¾‹å¦‚ï¼šå½±ç‰‡å‰ªè¼¯" /></div>
          <div><label>å–®ä»¶åˆ†æ•¸</label><input type="number" id="mTaskScore" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š30" /></div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="btn" id="addTask" data-admin-action>æ–°å¢ / æ›´æ–°ä»»å‹™</button>
            <button class="btn-outline" id="resetDefaults" data-admin-action>æ¢å¾©é è¨­ä»»å‹™</button>
          </div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>ä»»å‹™</th><th>åˆ†æ•¸</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="tbody-tasks"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:8px;">æ­£è¦åŒ–åƒ…ç”¨æ–¼ KPI è¨ˆç®—ï¼›åœ–è¡¨èˆ‡æ˜ç´°ä»é¡¯ç¤ºåŸå§‹åˆ†ã€‚</div>
      </section>

      <!-- å“¡å·¥ & ç›®æ¨™ï¼ˆåˆä½µä¸€ä»½åå–®ï¼‰ -->
      <section class="card" style="margin-top:16px;" data-admin-section>
        <h2>å“¡å·¥èˆ‡ç›®æ¨™è¨­å®šï¼ˆå–®ä¸€åå–®ï¼‰</h2>
        <div class="row row-3">
          <div><label>å“¡å·¥å§“å</label><input type="text" id="tName" list="empList" placeholder="è¼¸å…¥æˆ–é¸æ“‡æ—¢æœ‰å§“å" /></div>
          <div><label>æ¯æœˆç›®æ¨™åˆ†</label><input type="number" id="tPoints" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š300" /></div>
          <div><label>è§’è‰²èªªæ˜ï¼ˆé¸å¡«ï¼‰</label><input type="text" id="tNote" placeholder="ä¾‹å¦‚ï¼šå‰ªè¼¯ä¸»åŠ›ã€ä»¶æ•¸å°‘é›£åº¦é«˜" /></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button class="btn" id="saveTarget" data-admin-action>å„²å­˜ / æ›´æ–°</button>
          <button class="btn-delete btn-s" id="deleteTarget" data-admin-action>åˆªé™¤è©²å“¡å·¥ç›®æ¨™</button>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>å§“å</th><th>ç›®æ¨™åˆ†</th><th>è§’è‰²èªªæ˜</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="tbody-targets"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:8px;">èªªæ˜ï¼šæ­¤è¡¨å³ç‚ºå”¯ä¸€åå–®ã€‚æœªè¨­å®šç›®æ¨™è€…ä¹‹ã€Œç›®æ¨™%ã€= 100%ï¼ˆç­‰æ–¼ä»¥ä»»å‹™åˆ†ç¸½å’Œä½œç‚ºç›®æ¨™ï¼‰ã€‚</div>
      </section>
    </section>

    <!-- æ¥­å‹™ç´€éŒ„ -->
    <section id="tab-business" class="tab">
      <section class="card">
        <h2>æ–°å¢ç´€éŒ„</h2>
        <form id="form">
          <div class="row row-4">
            <div><label>å–®è™Ÿ</label><input type="text" id="orderNo" placeholder="å¯ç•™ç©ºæˆ–è¼¸å…¥ã€Œç„¡ã€" /></div>
            <div><label>æ—¥æœŸ</label><input type="date" id="date" required /></div>
            <div><label>å§“å</label><input type="text" id="name" list="empList" placeholder="ä¾‹å¦‚ï¼šå“¡å·¥A" required /><datalist id="empList"></datalist></div>
            <div><label>ä»»å‹™é¡å‹</label><select id="task" required></select></div>
          </div>
          <div class="row row-4">
            <div><label>ä»¶æ•¸</label><input type="number" id="qty" min="1" value="1" required /></div>
            <div><label>è‡ªå‹•å¾—åˆ†</label><input type="text" id="autoScore" readonly placeholder="ç³»çµ±è¨ˆç®—" /></div>
            <div>
              <label>é€²åº¦</label>
              <select id="stage" required>
                <option value="NOT_STARTED">æœªé–‹å§‹ï¼ˆ0%ï¼‰</option>
                <option value="IN_PROGRESS">é€²è¡Œä¸­ï¼ˆ50%ï¼‰</option>
                <option value="DONE">å·²å®Œæˆï¼ˆ100%ï¼‰</option>
              </select>
            </div>
            <div><label>å‚™è¨»</label><input type="text" id="note" placeholder="å¯ç•™ç©º" /></div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <div class="tiny">KPI% ä»¥ã€Œä»»å‹™åˆ†æ•¸æ­£è¦åŒ–ï¼ˆç¸½å’Œ=100ï¼‰ã€è¨ˆç®—ï¼›å€‹äººç›®æ¨™äº¦æ›ç®—ç‚ºç™¾åˆ†æ¯”ï¼ˆæœªè¨­å®šè€…è¦–ç‚º 100%ï¼‰ã€‚</div>
            <div id="chips" class="chips"></div>
            <button class="btn" type="submit">å„²å­˜ç´€éŒ„</button>
          </div>
        </form>
      </section>

      <section class="card" style="margin-top:16px;">
        <h2>ç´€éŒ„æ˜ç´°</h2>
        <table>
          <thead id="thead-records">
            <tr>
              <th>å–®è™Ÿ</th><th>æ—¥æœŸ</th><th>å§“å</th><th>ä»»å‹™</th><th>ä»¶æ•¸</th><th>å–®ä»¶åˆ†</th><th>ç¸½åˆ†</th><th>é€²åº¦</th><th>å‚™è¨»</th><th data-admin-action>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
        <div id="pager" style="display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:8px;">
          <button id="prevPage" class="btn-outline btn-s">ä¸Šä¸€é </button>
          <span id="pageInfo" class="tiny">ç¬¬ 1 / 1 é </span>
          <button id="nextPage" class="btn-outline btn-s">ä¸‹ä¸€é </button>
        </div>
      </section>
    </section>

    <!-- è¡Œç‚ºæ—¥èªŒï¼ˆç¸½è¦½é¢æ¿ + åŸæœ‰ Modalï¼‰ -->
    <section id="tab-behavior" class="tab">
      <section class="card">
        <h2>è¡Œç‚ºæ—¥èªŒç¸½è¦½</h2>
        <div class="row row-3">
          <div>
            <label>æœˆä»½</label>
            <input type="month" id="bhv-month" />
          </div>
          <div>
            <label>å§“å</label>
            <input type="text" id="bhv-name-filter" list="empList" placeholder="é¸æ“‡æˆ–è¼¸å…¥å§“å" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="btn-outline" id="bhv-open-modal" data-admin-action>é–‹å•Ÿè©²äººä¹‹æ—¥èªŒç·¨è¼¯çª—</button>
          </div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>æ—¥æœŸ</th><th>å§“å</th><th>é¡åˆ¥</th><th>å½±éŸ¿</th><th>å–®è™Ÿ/ä»»å‹™</th><th style="text-align:left;">SBI æè¿°</th></tr></thead>
            <tbody id="bhv-overview-tbody"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:6px;">æç¤ºï¼šæ¬²æ–°å¢/ç·¨è¼¯ï¼Œè«‹å…ˆæ–¼ä¸Šæ–¹é¸æ“‡å§“åï¼Œé»ã€Œé–‹å•Ÿâ€¦ã€å°‡ä½¿ç”¨åŸæœ‰ Modal å®Œæ•´ç®¡ç†ã€‚</div>
      </section>
    </section>

    <!-- å·¥ä½œæ—¥èªŒ -->
    <section id="tab-worklog" class="tab">
      <section class="card">
        <h2>å·¥ä½œæ—¥èªŒ</h2>
        <form id="worklog-form">
          <div class="row row-4">
            <div><label>æ—¥æœŸ</label><input type="date" id="wl-date" required /></div>
            <div><label>å§“å</label><input type="text" id="wl-name" list="empList" required /></div>
            <div><label>æ™‚æ•¸</label><input type="number" id="wl-hours" min="0" step="0.5" placeholder="ä¾‹å¦‚ 2 æˆ– 0.5" /></div>
            <div><label>å‚™è¨»</label><input type="text" id="wl-note" placeholder="å¯ç•™ç©º" /></div>
          </div>
          <div class="row">
            <div><label>å…§å®¹ / é‡é»</label><textarea id="wl-content" placeholder="ä»Šå¤©å®Œæˆäº†å“ªäº›äº‹é …ã€é€²åº¦è¦é»â€¦"></textarea></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button class="btn" type="submit">æ–°å¢æ—¥èªŒ</button>
          </div>
        </form>
      </section>

      <section class="card" style="margin-top:16px;">
        <h2>å·¥ä½œæ—¥èªŒæ¸…å–®</h2>
        <div class="row row-3">
          <div><label>æœˆä»½</label><input type="month" id="wl-month" /></div>
          <div><label>å§“å</label><input type="text" id="wl-filter-name" list="empList" /></div>
          <div style="display:flex; align-items:flex-end;"><button id="wl-clear-filter" class="btn-ghost btn-s">æ¸…é™¤ç¯©é¸</button></div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>æ—¥æœŸ</th><th>å§“å</th><th>æ™‚æ•¸</th><th style="text-align:left;">å…§å®¹</th><th style="text-align:left;">å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="wl-tbody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- é€šè¯ç´€éŒ„ -->
    <section id="tab-calllog" class="tab">
      <section class="card">
        <h2>é€šè¯ç´€éŒ„</h2>
        <form id="call-form">
          <div class="row row-4">
            <div><label>æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="cl-dt" required /></div>
            <div><label>è¯çµ¡è€…</label><input type="text" id="cl-contact" placeholder="å§“åæˆ–å–®ä½" required /></div>
            <div>
              <label>ä¾†é›»/å»é›»</label>
              <select id="cl-type">
                <option value="ä¾†é›»">ä¾†é›»</option>
                <option value="å»é›»">å»é›»</option>
              </select>
            </div>
            <div><label>åˆ†æ©Ÿ</label><input type="text" id="cl-ext" placeholder="å¯ç•™ç©º" /></div>
          </div>
          <div class="row row-2">
            <div><label>äº‹é … / æ‘˜è¦</label><input type="text" id="cl-summary" placeholder="é‡é»æ‘˜è¦" /></div>
            <div>
              <label>è™•ç†ç‹€æ…‹</label>
              <select id="cl-status">
                <option>æœªè™•ç†</option>
                <option>è™•ç†ä¸­</option>
                <option>å·²å®Œæˆ</option>
                <option>æš«ç·©</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>å‚™è¨»</label><textarea id="cl-note" placeholder="å¯ç•™ç©º"></textarea></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button class="btn" type="submit">æ–°å¢é€šè¯</button>
          </div>
        </form>
      </section>

      <section class="card" style="margin-top:16px;">
        <h2>é€šè¯æ¸…å–®</h2>
        <div class="row row-3">
          <div><label>æœˆä»½</label><input type="month" id="cl-month" /></div>
          <div><label>é—œéµå­—</label><input type="text" id="cl-kw" placeholder="è¯çµ¡è€…/æ‘˜è¦/å‚™è¨»" /></div>
          <div style="display:flex; align-items:flex-end;"><button id="cl-clear-filter" class="btn-ghost btn-s">æ¸…é™¤ç¯©é¸</button></div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>æ—¥æœŸæ™‚é–“</th><th>è¯çµ¡è€…</th><th>ä¾†/å»</th><th>åˆ†æ©Ÿ</th><th>æ‘˜è¦</th><th>ç‹€æ…‹</th><th style="text-align:left;">å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="cl-tbody"></tbody>
          </table>
        </div>
      </section>
    </section>
  </div>

  <!-- ç™»å…¥ Modal -->
  <div id="kpi-login-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="ç™»å…¥">
      <h3>ç™»å…¥</h3>
      <div style="display:flex; gap:6px; background:#f3f4f6; padding:6px; border-radius:12px;">
        <label style="flex:1; position:relative;">
          <input type="radio" name="kpi-role" value="user" checked style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
          <div class="opt" style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; border-radius:10px; font-weight:800; color:#374151; border:1px solid transparent;">ğŸ‘¤ ä½¿ç”¨è€…</div>
        </label>
        <label style="flex:1; position:relative;">
          <input type="radio" name="kpi-role" value="admin" style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
          <div class="opt" style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; border-radius:10px; font-weight:800; color:#374151; border:1px solid transparent;">ğŸ› ï¸ ç®¡ç†è€…</div>
        </label>
      </div>
      <div class="kpi-row" id="kpi-pass-row" style="display:none;">
        <input id="kpi-admin-pass" type="password" placeholder="ç®¡ç†è€…å¯†ç¢¼ï¼ˆé è¨­ï¼š123ï¼‰" />
      </div>
      <div class="tiny" style="margin-top:4px;">ç®¡ç†è€…æ“æœ‰ï¼šä»»å‹™ï¼å“¡å·¥ï¼ç›®æ¨™ç¶­è­·ã€è¡Œç‚ºæ—¥èªŒã€ç·¨è¼¯/åˆªé™¤ç´€éŒ„ã€åŒ¯å‡ºèˆ‡æ¸…é™¤è³‡æ–™ç­‰æ¬Šé™ã€‚</div>
      <div class="kpi-actions">
        <button id="kpi-cancel" class="btn-ghost">å–æ¶ˆ</button>
        <button id="kpi-confirm" class="btn">ç™»å…¥</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯ç´€éŒ„ Modalï¼ˆæ¥­å‹™ï¼šåŸï¼‰ -->
  <div id="edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="ç·¨è¼¯ç´€éŒ„">
      <h3>ç·¨è¼¯ç´€éŒ„</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-id" />
        <div class="row row-2">
          <div><label>å–®è™Ÿ</label><input type="text" id="edit-orderNo" placeholder="å¯ç•™ç©ºæˆ–è¼¸å…¥ã€Œç„¡ã€" /></div>
          <div><label>æ—¥æœŸ</label><input type="date" id="edit-date" required /></div>
        </div>
        <div class="row row-2">
          <div><label>å§“å</label><input type="text" id="edit-name" list="empList" required /></div>
          <div><label>ä»»å‹™é¡å‹</label><select id="edit-task" required></select></div>
        </div>
        <div class="row row-3">
          <div><label>ä»¶æ•¸</label><input type="number" id="edit-qty" min="1" required /></div>
          <div><label>å–®ä»¶åˆ†ï¼ˆä¾ä»»å‹™ï¼‰</label><input type="text" id="edit-scorePerItem" readonly /></div>
          <div><label>å‚™è¨»</label><input type="text" id="edit-note" /></div>
        </div>
        <div class="row row-2">
          <div>
            <label>é€²åº¦</label>
            <select id="edit-stage" required>
              <option value="NOT_STARTED">æœªé–‹å§‹ï¼ˆ0%ï¼‰</option>
              <option value="IN_PROGRESS">é€²è¡Œä¸­ï¼ˆ50%ï¼‰</option>
              <option value="DONE">å·²å®Œæˆï¼ˆ100%ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="kpi-actions">
          <button type="button" id="edit-cancel" class="btn-ghost">å–æ¶ˆ</button>
          <button type="submit" class="btn">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- è¡Œç‚ºæ—¥èªŒ Modalï¼ˆåŸï¼‰ -->
  <div id="bhv-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="è¡Œç‚ºæ—¥èªŒ">
      <h3>ğŸ“ è¡Œç‚ºæ—¥èªŒï½œ<span id="bhv-title"></span></h3>
      <div class="tiny" id="bhv-suggest" style="margin-bottom:8px;"></div>

      <div class="row row-4">
        <div><label>æ—¥æœŸ</label><input type="date" id="bhv-date" /></div>
        <div>
          <label>é¡åˆ¥</label>
          <select id="bhv-type">
            <option value="éŒ¯èª¤">éŒ¯èª¤</option><option value="é²åˆ°">é²åˆ°</option><option value="é›¢ä½">é›¢ä½</option>
            <option value="æœªä¾æµç¨‹">æœªä¾æµç¨‹</option><option value="æºé€šä¸è‰¯">æºé€šä¸è‰¯</option>
            <option value="ä¸»å‹•æ”¯æ´">ä¸»å‹•æ”¯æ´ï¼ˆæ­£å‘ï¼‰</option><option value="æµç¨‹å„ªåŒ–">æµç¨‹å„ªåŒ–ï¼ˆæ­£å‘ï¼‰</option><option value="è·¨éƒ¨æ•‘æ´">è·¨éƒ¨æ•‘æ´ï¼ˆæ­£å‘ï¼‰</option>
          </select>
        </div>
        <div>
          <label>å½±éŸ¿ç­‰ç´š</label>
          <select id="bhv-impact">
            <option value="1">è¼•å¾®=1</option><option value="2">ä¸­=2</option><option value="3">é‡å¤§=3</option>
          </select>
        </div>
        <div><label>å–®è™Ÿ/ä»»å‹™</label><input type="text" id="bhv-order" placeholder="å¯ç•™ç©ºæˆ–ã€Œç„¡ã€" /></div>
      </div>
      <div class="row">
        <div><label>SBI æè¿°ï¼ˆäº‹å¯¦ï¼è¡Œç‚ºï¼å½±éŸ¿ï¼‰</label><textarea id="bhv-sbi" placeholder="ä¾‹ï¼šS: äº¤ä»˜å‰å¯©æŸ¥ï¼›B: æœªæ›´æ–°æ—¥æœŸï¼›I: å®¢è¨´1æ¬¡ï¼Œè¿”å·¥2hr"></textarea></div>
      </div>
      <div class="row row-2">
        <div><label>ä½è­‰ï¼ˆé€£çµæˆ–èªªæ˜ï¼Œå¯ç•™ç©ºï¼‰</label><input type="text" id="bhv-evidence" /></div>
        <div><label>æ¡å–è¡Œå‹•</label><input type="text" id="bhv-action" placeholder="æé†’/è¨“ç·´/èª¿æ•´æµç¨‹â€¦" /></div>
      </div>
      <div class="kpi-actions">
        <button id="bhv-cancel" class="btn-ghost">é—œé–‰</button>
        <button id="bhv-add" class="btn" data-admin-action>æ–°å¢æ—¥èªŒ</button>
        <button id="bhv-apply-suggest" class="btn-outline" data-admin-action>æ¡ç”¨ç³»çµ±å»ºè­°ç­‰ç´š</button>
      </div>

      <div class="scroll-area" style="margin-top:12px;">
        <table>
          <thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>å½±éŸ¿</th><th>å–®è™Ÿ</th><th style="text-align:left;">SBI æè¿°</th><th style="text-align:left;">ä½è­‰</th><th style="text-align:left;">è¡Œå‹•</th><th data-admin-action>æ“ä½œ</th></tr></thead>
          <tbody id="bhv-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ï¼šå·¥ä½œæ—¥èªŒç·¨è¼¯ Modal -->
  <div id="wl-edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="ç·¨è¼¯å·¥ä½œæ—¥èªŒ">
      <h3>ç·¨è¼¯å·¥ä½œæ—¥èªŒ</h3>
      <form id="wl-edit-form">
        <input type="hidden" id="wl-edit-id" />
        <div class="row row-4">
          <div><label>æ—¥æœŸ</label><input type="date" id="wl-edit-date" required /></div>
          <div><label>å§“å</label><input type="text" id="wl-edit-name" list="empList" required /></div>
          <div><label>æ™‚æ•¸</label><input type="number" id="wl-edit-hours" min="0" step="0.5" /></div>
          <div><label>å‚™è¨»</label><input type="text" id="wl-edit-note" /></div>
        </div>
        <div class="row">
          <div><label>å…§å®¹ / é‡é»</label><textarea id="wl-edit-content"></textarea></div>
        </div>
        <div class="kpi-actions">
          <button type="button" id="wl-edit-cancel" class="btn-ghost">å–æ¶ˆ</button>
          <button type="submit" class="btn">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ–°å¢ï¼šé€šè¯ç´€éŒ„ç·¨è¼¯ Modal -->
  <div id="cl-edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="ç·¨è¼¯é€šè¯ç´€éŒ„">
      <h3>ç·¨è¼¯é€šè¯ç´€éŒ„</h3>
      <form id="cl-edit-form">
        <input type="hidden" id="cl-edit-id" />
        <div class="row row-4">
          <div><label>æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="cl-edit-dt" required /></div>
          <div><label>è¯çµ¡è€…</label><input type="text" id="cl-edit-contact" required /></div>
          <div>
            <label>ä¾†é›»/å»é›»</label>
            <select id="cl-edit-type">
              <option value="ä¾†é›»">ä¾†é›»</option>
              <option value="å»é›»">å»é›»</option>
            </select>
          </div>
          <div><label>åˆ†æ©Ÿ</label><input type="text" id="cl-edit-ext" /></div>
        </div>
        <div class="row row-2">
          <div><label>äº‹é … / æ‘˜è¦</label><input type="text" id="cl-edit-summary" /></div>
          <div>
            <label>è™•ç†ç‹€æ…‹</label>
            <select id="cl-edit-status">
              <option>æœªè™•ç†</option>
              <option>è™•ç†ä¸­</option>
              <option>å·²å®Œæˆ</option>
              <option>æš«ç·©</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label>å‚™è¨»</label><textarea id="cl-edit-note"></textarea></div>
        </div>
        <div class="kpi-actions">
          <button type="button" id="cl-edit-cancel" class="btn-ghost">å–æ¶ˆ</button>
          <button type="submit" class="btn">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ===== Safari/èˆŠç‰ˆç›¸å®¹è£œä¸ï¼šè‹¥ç„¡ Object.hasOwnï¼Œæ”¹ç”¨ hasOwnProperty ===== */
    if (!Object.hasOwn) { Object.hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key); }

    // ===== keys =====
    const KEY = "kpiRecords_v1";
    const TASKS_KEY = "kpiTasks_v1";
    const THRESHOLD_KEY = "kpiThreshold_v1";
    const EMP_KEY = "kpiEmployees_v1";
    const TARGETS_KEY = "kpiTargets_v1";
    const BEHAVIOR_KEY = "kpiBehavior_v1";
    const BEHAVIOR_LOG_KEY = "kpiBehaviorLog_v1";
    // æ–°å¢ï¼šå·¥ä½œæ—¥èªŒ/é€šè¯ç´€éŒ„
    const WORKLOG_KEY = "kpiWorklog_v1";
    const CALLLOG_KEY = "kpiCalllog_v1";

    const STAGE = {
      NOT_STARTED: { idx: 0, pct: 0,   label: 'æœªé–‹å§‹' },
      IN_PROGRESS: { idx: 1, pct: 50,  label: 'é€²è¡Œä¸­' },
      DONE:        { idx: 2, pct: 100, label: 'å·²å®Œæˆ' }
    };

    const LEVEL = {
      EXCELLENT: { label:'å„ª(+5%)', adjust:  0.05 },
      NORMAL:    { label:'æ­£å¸¸(0%)', adjust:  0.00 },
      IMPROVE:   { label:'å¾…æ”¹å–„(-5%)', adjust: -0.05 },
      WARN:      { label:'è­¦ç¤º(-10%)', adjust: -0.10 },
    };
    const NEG_TYPES = new Set(['éŒ¯èª¤','é²åˆ°','é›¢ä½','æœªä¾æµç¨‹','æºé€šä¸è‰¯']);
    const POS_TYPES = new Set(['ä¸»å‹•æ”¯æ´','æµç¨‹å„ªåŒ–','è·¨éƒ¨æ•‘æ´']);

    const DEFAULT_TASKS = {
      "å½±ç‰‡å‰ªè¼¯": 30, "æµ·å ±è¨­è¨ˆ": 10, "è¡›æ•™å–®å¼µ": 5,
      "PodcastéŒ„éŸ³å‰ªè¼¯": 20, "ç¶²é ç¶­è­·": 10, "æœƒè­°å®¤ç®¡ç†": 5, "æ‹ç…§/æ‹æ”æ”¯æ´": 15
    };
    const DEFAULT_EMPS = ["å“¡å·¥A","å“¡å·¥B","å“¡å·¥C"];

    // DOM å–ç”¨ï¼ˆåŸï¼‰
    const form = document.getElementById('form');
    const orderNoEl = document.getElementById('orderNo');
    const dateEl = document.getElementById('date');
    const nameEl = document.getElementById('name');
    const taskEl = document.getElementById('task');
    const qtyEl = document.getElementById('qty');
    const noteEl = document.getElementById('note');
    const autoScoreEl = document.getElementById('autoScore');
    const stageEl = document.getElementById('stage');

    const tbody = document.getElementById('tbody');
    const tfoot = document.getElementById('tfoot');
    const theadRecords = document.getElementById('thead-records');
    const monthEl = document.getElementById('month');
    const filterNameEl = document.getElementById('filterName');
    const chips = document.getElementById('chips');

    const thresholdEl = document.getElementById('threshold');
    const tbodyUnder = document.getElementById('tbody-under');
    const pillMonth = document.getElementById('pillMonth');
    const onlyUnderEl = document.getElementById('onlyUnder');

    // ä»»å‹™ç®¡ç†
    const mTaskName = document.getElementById('mTaskName');
    const mTaskScore = document.getElementById('mTaskScore');
    const addTaskBtn = document.getElementById('addTask');
    const resetDefaultsBtn = document.getElementById('resetDefaults');
    const tbodyTasks = document.getElementById('tbody-tasks');

    // åˆä½µåå–®/ç›®æ¨™
    const empList = document.getElementById('empList');
    const tName = document.getElementById('tName');
    const tPoints = document.getElementById('tPoints');
    const tNote = document.getElementById('tNote');
    const tbodyTargets = document.getElementById('tbody-targets');

    // ç™»å…¥/è§’è‰²
    const ADMIN_PASS = '123';
    const ROLE_KEY = 'kpi_role_v2';
    const roleBadge = document.getElementById('roleBadge');
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('kpi-login-modal');
    const passRow = document.getElementById('kpi-pass-row');
    const passInput = document.getElementById('kpi-admin-pass');
    const modalConfirm = document.getElementById('kpi-confirm');

    // ç·¨è¼¯ç´€éŒ„ï¼ˆæ¥­å‹™ï¼šåŸï¼‰
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editId = document.getElementById('edit-id');
    const editOrderNo = document.getElementById('edit-orderNo');
    const editDate = document.getElementById('edit-date');
    const editName = document.getElementById('edit-name');
    const editTask = document.getElementById('edit-task');
    const editQty = document.getElementById('edit-qty');
    const editScorePerItem = document.getElementById('edit-scorePerItem');
    const editNote = document.getElementById('edit-note');
    const editStage = document.getElementById('edit-stage');
    const editCancel = document.getElementById('edit-cancel');

    // è¡Œç‚ºæ—¥èªŒï¼ˆModal æ—¢æœ‰ï¼‰
    const bhvModal = document.getElementById('bhv-modal');
    const bhvTitle = document.getElementById('bhv-title');
    const bhvSuggest = document.getElementById('bhv-suggest');
    const bhvApplySuggestBtn = document.getElementById('bhv-apply-suggest');
    const bhvDate = document.getElementById('bhv-date');
    const bhvType = document.getElementById('bhv-type');
    const bhvImpact = document.getElementById('bhv-impact');
    const bhvOrder = document.getElementById('bhv-order');
    const bhvSBI = document.getElementById('bhv-sbi');
    const bhvEvidence = document.getElementById('bhv-evidence');
    const bhvAction = document.getElementById('bhv-action');
    const bhvAdd = document.getElementById('bhv-add');
    const bhvCancel = document.getElementById('bhv-cancel');
    const bhvTbody = document.getElementById('bhv-tbody');
    let bhvEditingId = null; // ç·¨è¼¯ä¸­ id

    // è¡Œç‚ºæ—¥èªŒï¼ˆç¸½è¦½åˆ†é ï¼‰
    const bhvMonthInput = document.getElementById('bhv-month');
    const bhvNameFilter = document.getElementById('bhv-name-filter');
    const bhvOpenModalBtn = document.getElementById('bhv-open-modal');
    const bhvOverviewTbody = document.getElementById('bhv-overview-tbody');

    // åˆ†é ï¼ˆæ¥­å‹™ç´€éŒ„ï¼‰
    const PAGE_SIZE = 20;
    let currentPage = 1;
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoEl = document.getElementById('pageInfo');

    // å·¥ä½œæ—¥èªŒ DOM
    const wlForm = document.getElementById('worklog-form');
    const wlDate = document.getElementById('wl-date');
    const wlName = document.getElementById('wl-name');
    const wlHours = document.getElementById('wl-hours');
    const wlNote = document.getElementById('wl-note');
    const wlContent = document.getElementById('wl-content');
    const wlMonth = document.getElementById('wl-month');
    const wlFilterName = document.getElementById('wl-filter-name');
    const wlClearFilter = document.getElementById('wl-clear-filter');
    const wlTbody = document.getElementById('wl-tbody');

    // é€šè¯ç´€éŒ„ DOM
    const clForm = document.getElementById('call-form');
    const clDT = document.getElementById('cl-dt');
    const clContact = document.getElementById('cl-contact');
    const clType = document.getElementById('cl-type');
    const clExt = document.getElementById('cl-ext');
    const clSummary = document.getElementById('cl-summary');
    const clStatus = document.getElementById('cl-status');
    const clNote = document.getElementById('cl-note');
    const clMonth = document.getElementById('cl-month');
    const clKW = document.getElementById('cl-kw');
    const clClearFilter = document.getElementById('cl-clear-filter');
    const clTbody = document.getElementById('cl-tbody');

    // æ–°å¢ï¼šå·¥ä½œæ—¥èªŒç·¨è¼¯ Modal å…ƒä»¶
    const wlEditModal = document.getElementById('wl-edit-modal');
    const wlEditForm = document.getElementById('wl-edit-form');
    const wlEditId = document.getElementById('wl-edit-id');
    const wlEditDate = document.getElementById('wl-edit-date');
    const wlEditName = document.getElementById('wl-edit-name');
    const wlEditHours = document.getElementById('wl-edit-hours');
    const wlEditNote = document.getElementById('wl-edit-note');
    const wlEditContent = document.getElementById('wl-edit-content');
    const wlEditCancel = document.getElementById('wl-edit-cancel');

    // æ–°å¢ï¼šé€šè¯ç´€éŒ„ç·¨è¼¯ Modal å…ƒä»¶
    const clEditModal = document.getElementById('cl-edit-modal');
    const clEditForm = document.getElementById('cl-edit-form');
    const clEditId = document.getElementById('cl-edit-id');
    const clEditDT = document.getElementById('cl-edit-dt');
    const clEditContact = document.getElementById('cl-edit-contact');
    const clEditType = document.getElementById('cl-edit-type');
    const clEditExt = document.getElementById('cl-edit-ext');
    const clEditSummary = document.getElementById('cl-edit-summary');
    const clEditStatus = document.getElementById('cl-edit-status');
    const clEditNote = document.getElementById('cl-edit-note');
    const clEditCancel = document.getElementById('cl-edit-cancel');

    // å·¥å…·
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const read = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const load = ()=> read(KEY, []);
    const save = list => write(KEY, list);
    const readBehavior = ()=> read(BEHAVIOR_KEY, {}) || {};
    const writeBehavior = (obj)=> write(BEHAVIOR_KEY, obj);
    const readBehaviorLogs = ()=> read(BEHAVIOR_LOG_KEY, {}) || {};
    const writeBehaviorLogs = (obj)=> write(BEHAVIOR_LOG_KEY, obj);
    const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
    function isNoOrder(v){ const s=(v||'').trim(); return s==='' || s==='ç„¡' || s==='æ— '; }

    // Tabs åˆ‡æ›
    function setupTabs(){
      const buttons = $$('#tabs .tab-btn');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const target = btn.dataset.tabTarget;
          document.querySelectorAll('.tab').forEach(p=> p.classList.remove('active'));
          document.getElementById(target).classList.add('active');
          buttons.forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          if(target==='tab-dashboard'){ render(); }
          if(target==='tab-business'){ render(); }
          if(target==='tab-behavior'){ renderBehaviorOverview(); }
          if(target==='tab-worklog'){ renderWorklog(); }
          if(target==='tab-calllog'){ renderCalllog(); }
        });
      });
    }

    // åˆå§‹åŒ–
    function ensureInit(){
      const t = read(TASKS_KEY);
      if(!t || typeof t!=='object' || Object.keys(t).length===0) write(TASKS_KEY, DEFAULT_TASKS);
      if(read(THRESHOLD_KEY) == null) write(THRESHOLD_KEY, 80);
      const e = read(EMP_KEY);
      if(!Array.isArray(e) || e.length===0) write(EMP_KEY, DEFAULT_EMPS);
      if(!read(TARGETS_KEY)) write(TARGETS_KEY, {});
      if(!read(BEHAVIOR_KEY)) write(BEHAVIOR_KEY, {});
      if(!read(BEHAVIOR_LOG_KEY)) write(BEHAVIOR_LOG_KEY, {});
      if(!read(WORKLOG_KEY)) write(WORKLOG_KEY, []);
      if(!read(CALLLOG_KEY)) write(CALLLOG_KEY, []);
    }
    ensureInit();

    // åˆå€¼
    (function initDefaults(){
      monthEl.value = new Date().toISOString().slice(0,7);
      thresholdEl.value = read(THRESHOLD_KEY, 80);
      pillMonth.textContent = monthEl.value;
      dateEl.valueAsDate = new Date();
      stageEl.value = 'NOT_STARTED';
      bhvMonthInput.value = monthEl.value;
      wlDate.valueAsDate = new Date();
      wlMonth.value = monthEl.value;
      clDT.value = new Date().toISOString().slice(0,16);
      clMonth.value = monthEl.value;
    })();

    // è§’è‰²
    function getRole(){ return sessionStorage.getItem(ROLE_KEY) || 'user'; }
    function isAdmin(){ return getRole()==='admin'; }
    function applyRoleGate(){ thresholdEl.disabled = !isAdmin(); }
    function renderRecordsHead(){
      if(!theadRecords) return;
      theadRecords.innerHTML = `
        <tr>
          <th>å–®è™Ÿ</th><th>æ—¥æœŸ</th><th>å§“å</th><th>ä»»å‹™</th><th>ä»¶æ•¸</th><th>å–®ä»¶åˆ†</th><th>ç¸½åˆ†</th><th>é€²åº¦</th><th>å‚™è¨»</th>
          ${isAdmin() ? '<th>æ“ä½œ</th>' : ''}
        </tr>`;
    }
    function setRole(role){
      sessionStorage.setItem(ROLE_KEY, role);
      document.body.setAttribute('data-role', role);
      roleBadge.textContent = 'è§’è‰²ï¼š' + (role==='admin'?'ç®¡ç†è€…':'ä½¿ç”¨è€…');
      loginBtn.innerHTML = (role==='admin' ? 'ğŸšª ç™»å‡º' : 'ğŸ” ç™»å…¥');
      applyRoleGate(); renderRecordsHead(); currentPage = 1; render(); renderBehaviorOverview(); renderWorklog(); renderCalllog();
    }

    // ç™»å…¥ UI
    function openLogin(){
      loginModal.classList.remove('hidden'); loginModal.setAttribute('aria-hidden','false');
      const current = getRole();
      $$('input[name="kpi-role"]').forEach(r=> r.checked = (r.value===current) );
      document.getElementById('kpi-pass-row').style.display = (current==='admin') ? 'block' : 'none';
      if (current==='admin') document.getElementById('kpi-admin-pass').focus();
    }
    function closeLogin(){ loginModal.classList.add('hidden'); loginModal.setAttribute('aria-hidden','true'); document.getElementById('kpi-admin-pass').value=''; }
    $$('input[name="kpi-role"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        document.getElementById('kpi-pass-row').style.display = (r.value==='admin')?'block':'none';
        if(r.value==='admin') document.getElementById('kpi-admin-pass').focus();
      });
    });
    loginBtn.addEventListener('click', ()=>{
      if(isAdmin()){ setRole('user'); return; }
      openLogin();
    });
    document.getElementById('kpi-cancel').addEventListener('click', closeLogin);
    loginModal.addEventListener('click', (e)=>{ if(e.target===loginModal) closeLogin(); });
    modalConfirm.addEventListener('click', ()=>{
      const picked = ($$('input[name="kpi-role"]').find(x=>x.checked)||{}).value || 'user';
      if(picked==='admin' && document.getElementById('kpi-admin-pass').value!=='123'){ alert('ç®¡ç†è€…å¯†ç¢¼éŒ¯èª¤'); return; }
      setRole(picked); closeLogin();
    });

    // è‡ªå‹•å¾—åˆ†é¡¯ç¤º
    function updateAutoScore(){
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const s = tasks[taskEl.value] || 0;
      const q = Number(qtyEl.value || 0);
      autoScoreEl.value = (s && q) ? (s*q) : '';
    }
    taskEl.addEventListener('change', updateAutoScore);
    qtyEl.addEventListener('input', updateAutoScore);

    // ä»»å‹™ UI
    let editingTaskKey = null;
    function resetTaskEditState(){
      editingTaskKey = null;
      if(mTaskName) mTaskName.value = '';
      if(mTaskScore) mTaskScore.value = '';
      if(addTaskBtn){ addTaskBtn.textContent = 'æ–°å¢ / æ›´æ–°ä»»å‹™'; delete addTaskBtn.dataset.mode; }
    }
    function rebuildTaskUI(){
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      taskEl.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>' +
        Object.entries(tasks).map(([k,v])=>`<option value="${k}">${k}</option>`).join('');
      const editTaskEl = document.getElementById('edit-task');
      if (editTaskEl){
        editTaskEl.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>' +
          Object.entries(tasks).map(([k,v])=>`<option value="${k}">${k}</option>`).join('');
      }
      chips.innerHTML = Object.entries(tasks).map(([k,v])=>`<span class="chip">${k} ${v}</span>`).join('');
      if(tbodyTasks){
        tbodyTasks.innerHTML = Object.entries(tasks).map(([k,v])=>`
          <tr>
            <td>${k}</td><td>${v}</td>
            <td class="actions">
              <button class="btn-edit btn-s" data-edit="${k}" data-admin-action>ç·¨è¼¯</button>
              <button class="btn-delete btn-s" data-del="${k}" data-admin-action>åˆªé™¤</button>
            </td>
          </tr>`).join('');
        tbodyTasks.querySelectorAll('button[data-edit]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
            const t = read(TASKS_KEY, DEFAULT_TASKS);
            editingTaskKey = b.dataset.edit;
            mTaskName.value = editingTaskKey;
            mTaskScore.value = t[editingTaskKey];
            addTaskBtn.textContent = 'æ›´æ–°ä»»å‹™';
            addTaskBtn.dataset.mode = 'edit';
            mTaskName.focus();
          });
        });
        tbodyTasks.querySelectorAll('button[data-del]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
            const key=b.dataset.del;
            if(!confirm(`ç¢ºå®šåˆªé™¤ä»»å‹™ã€Œ${key}ã€ï¼Ÿ`)) return;
            const t=read(TASKS_KEY, DEFAULT_TASKS);
            delete t[key]; write(TASKS_KEY, t);
            if(editingTaskKey===key) resetTaskEditState();
            rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
          });
        });
      }
    }

    // åˆä½µåå–®çš„ datalist
    function rebuildEmpUI(){
      const emps = read(EMP_KEY, DEFAULT_EMPS);
      empList.innerHTML = emps.map(n=>`<option value="${n}">`).join('');
    }

    // ä»»å‹™æ–°å¢/æ›´æ–°
    if(addTaskBtn){
      addTaskBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
        const name = (mTaskName.value||'').trim();
        const score = Number(mTaskScore.value);
        if(!name || !Number.isFinite(score) || score<0){ alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»»å‹™åç¨±èˆ‡åˆ†æ•¸'); return; }
        const t = read(TASKS_KEY, DEFAULT_TASKS) || {};
        if(addTaskBtn.dataset.mode==='edit' && editingTaskKey){
          if(editingTaskKey!==name && Object.hasOwn(t, editingTaskKey)) {
            delete t[editingTaskKey];
          }
          t[name] = Math.round(score);
          write(TASKS_KEY, t);
          resetTaskEditState();
        }else{
          t[name] = Math.round(score);
          write(TASKS_KEY, t);
        }
        rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
      });
    }

    // æ¢å¾©é è¨­ä»»å‹™
    if(resetDefaultsBtn){
      resetDefaultsBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
        if(confirm('ç¢ºå®šæ¢å¾©ç‚ºé è¨­ä»»å‹™ï¼Ÿç¾æœ‰ä»»å‹™åˆ†æ•¸å°‡è¢«è¦†è“‹ã€‚')){
          write(TASKS_KEY, DEFAULT_TASKS);
          resetTaskEditState(); rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
        }
      });
    }

    // è¨­å®šè®Šæ›´
    monthEl.addEventListener('change', ()=>{ pillMonth.textContent = monthEl.value; currentPage=1; render(); renderBehaviorOverview(); renderWorklog(); renderCalllog(); });
    filterNameEl.addEventListener('input', ()=>{ currentPage=1; render(); });
    thresholdEl.addEventListener('input', ()=>{
      if(!isAdmin()){ thresholdEl.value = read(THRESHOLD_KEY, 80); alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      write(THRESHOLD_KEY, Number(thresholdEl.value||0)); render();
    });
    onlyUnderEl.addEventListener('change', render);

    // æ–°å¢ç´€éŒ„ï¼ˆæ¥­å‹™ï¼‰
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const orderNo = (orderNoEl.value||'').trim();
      if(!isNoOrder(orderNo)){
        const exists = load().some(r=> (r.orderNo || '').trim() === orderNo);
        if(exists){ alert('æ­¤å–®è™Ÿå·²å­˜åœ¨ï¼Œè«‹ç”¨ã€Œç·¨è¼¯ã€æ›´æ–°ï¼Œç¦æ­¢é‡è¤‡å¡«å¯«ã€‚'); return; }
      }
      const pickedStage = (stageEl.value || 'NOT_STARTED');
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const scorePerItem = tasks[taskEl.value] || 0;
      const qty = Number(qtyEl.value);
      const total = scorePerItem * qty;
      const rec = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        orderNo,
        date: dateEl.value,
        name: nameEl.value.trim(),
        task: taskEl.value,
        qty, scorePerItem, total,
        note: (noteEl.value||'').trim(),
        stage: pickedStage,
        stagePct: (STAGE[pickedStage]?.pct ?? 0)
      };
      const list = load(); list.push(rec); save(list);

      const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(rec.name); write(EMP_KEY, Array.from(set)); rebuildEmpUI(); rebuildTargetsTable();

      form.reset(); dateEl.valueAsDate = new Date(); autoScoreEl.value=''; stageEl.value='NOT_STARTED';
      currentPage=1; render(); alert('å·²å„²å­˜');
    });

    // åˆªé™¤ç´€éŒ„ï¼ˆæ¥­å‹™ï¼‰
    function removeOne(id){
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const rec = load().find(r=>r.id===id);
      const label = rec ? `ï¼ˆå–®è™Ÿï¼š${rec.orderNo || 'ç„¡'}ï½œå§“åï¼š${rec.name || ''}ï½œæ—¥æœŸï¼š${rec.date || ''}ï¼‰` : '';
      if(!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¥­å‹™ç´€éŒ„å—ï¼Ÿ${label}\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
      save(load().filter(r=>r.id!==id));
      currentPage = Math.min(currentPage, getTotalPages(applyFilters(load())) || 1);
      render();
    }

    // åŒ¯å‡º/æ¸…ç©º
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const list = load();
      const header = ['å–®è™Ÿ','æ—¥æœŸ','å§“å','ä»»å‹™','ä»¶æ•¸','å–®ä»¶åˆ†','ç¸½åˆ†','é€²åº¦','é€²åº¦%','å‚™è¨»'];
      const rows = list.map(r=>[
        r.orderNo,r.date,r.name,r.task,r.qty,r.scorePerItem,r.total,
        STAGE[r.stage]?.label || '', STAGE[r.stage]?.pct ?? '',
        (r.note||'').replace(/\n/g,' ')
      ]);
      const csv = [header,...rows].map(a=>a.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='KPI_Export.csv'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰ã€Œæ¥­å‹™ç´€éŒ„ã€è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){
        localStorage.removeItem(KEY);
        currentPage=1; render();
      }
    });

    // ===== è¡Œç‚ºç­‰ç´š/æ—¥èªŒï¼ˆåŸï¼‰ =====
    function getLevel(ym, name){ const all = readBehavior(); return all?.[ym]?.[name] || 'NORMAL'; }
    function setLevel(ym, name, level){ const all = readBehavior(); all[ym] = all[ym] || {}; all[ym][name] = level; writeBehavior(all); }
    function getLogs(ym, name){ const all = readBehaviorLogs(); return all?.[ym]?.[name] || []; }
    function saveLogs(ym, name, arr){ const all = readBehaviorLogs(); all[ym] = all[ym] || {}; all[ym][name] = arr; writeBehaviorLogs(all); }
    function suggestLevel(ym, name){
      const logs = getLogs(ym, name);
      let negSum = 0, negMajor=0, posCount=0;
      logs.forEach(l=>{
        if(NEG_TYPES.has(l.type)){ const imp = Number(l.impact||0); negSum += imp; if(imp===3) negMajor++; }
        else if(POS_TYPES.has(l.type)){ posCount++; }
      });
      const adjusted = Math.max(0, negSum - Math.min(2, posCount));
      if(posCount>=2 && negSum<=2) return 'EXCELLENT';
      if(adjusted>=5 || negMajor>=2) return 'WARN';
      if(adjusted>=3) return 'IMPROVE';
      return 'NORMAL';
    }
    function levelLabel(k){ return LEVEL[k]?.label || ''; }

    let bhvCtx = { ym:'', name:'' };
    function openBehaviorModal(name){
      if(!isAdmin()) return; // ä½¿ç”¨è€…ä¸é–‹æ”¾
      bhvCtx = { ym: monthEl.value, name };
      const { ym } = bhvCtx;
      bhvTitle.textContent = `${name}ï½œ${ym}`;
      bhvDate.valueAsDate = new Date();
      bhvEditingId = null; bhvAdd.textContent = 'æ–°å¢æ—¥èªŒ';
      renderBehaviorTable();
      const sugg = suggestLevel(ym, name);
      bhvSuggest.textContent = `ç³»çµ±å»ºè­°ç­‰ç´šï¼š${levelLabel(sugg)}ï¼ˆå¯æŒ‰ä¸‹æ–¹ã€Œæ¡ç”¨ç³»çµ±å»ºè­°ç­‰ç´šã€å¥—ç”¨ï¼›å¯¦éš›æ¡ç”¨ä»ç”±ä¸»ç®¡æ±ºå®šï¼‰`;
      bhvApplySuggestBtn.disabled = !isAdmin();
      bhvModal.classList.remove('hidden'); bhvModal.setAttribute('aria-hidden','false');
    }
    function closeBehaviorModal(){ bhvModal.classList.add('hidden'); bhvModal.setAttribute('aria-hidden','true'); }

    function renderBehaviorTable(){
      const { ym, name } = bhvCtx;
      const logs = getLogs(ym, name);
      bhvTbody.innerHTML = logs.length ? logs.map(l=>`
        <tr>
          <td>${l.date||''}</td>
          <td>${l.type||''}</td>
          <td>${l.impact||''}</td>
          <td>${(l.order||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(l.sbi||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(l.evidence||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(l.action||'').replace(/</g,'&lt;')}</td>
          <td class="actions" ${isAdmin()?'':'style="display:none"'}>
            <button class="btn-edit btn-s" data-edit="${l.id}">ç·¨è¼¯</button>
            <button class="btn-delete btn-s" data-del="${l.id}">åˆªé™¤</button>
          </td>
        </tr>`).join('') : `<tr><td colspan="8" class="tiny">å°šç„¡æ—¥èªŒ</td></tr>`;

      if(isAdmin()){
        // åˆªé™¤
        bhvTbody.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.del;
            const item = logs.find(x=>x.id===id);
            const label = item ? `ï¼ˆæ—¥æœŸï¼š${item.date||''}ï½œé¡åˆ¥ï¼š${item.type||''}ï¼‰` : '';
            if(!confirm(`ç¢ºå®šåˆªé™¤æ­¤è¡Œç‚ºæ—¥èªŒï¼Ÿ${label}`)) return;
            const arr = getLogs(ym,name).filter(x=>x.id!==id);
            saveLogs(ym,name,arr);
            if(bhvEditingId===id){ bhvEditingId=null; bhvAdd.textContent='æ–°å¢æ—¥èªŒ'; }
            renderBehaviorTable(); render();
          });
        });
        // ç·¨è¼¯
        bhvTbody.querySelectorAll('button[data-edit]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.edit;
            const item = getLogs(ym,name).find(x=>x.id===id);
            if(!item) return;
            bhvEditingId = id;
            bhvDate.value = item.date || '';
            bhvType.value = item.type || 'éŒ¯èª¤';
            bhvImpact.value = String(item.impact || 1);
            bhvOrder.value = item.order || '';
            bhvSBI.value = item.sbi || '';
            bhvEvidence.value = item.evidence || '';
            bhvAction.value = item.action || '';
            bhvAdd.textContent = 'å„²å­˜ä¿®æ”¹';
          });
        });
      }
    }

    bhvCancel.addEventListener('click', closeBehaviorModal);
    bhvModal.addEventListener('click', (e)=>{ if(e.target===bhvModal) closeBehaviorModal(); });
    bhvAdd.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const { ym, name } = bhvCtx;
      const item = {
        id: bhvEditingId || ((crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())),
        date: bhvDate.value || new Date().toISOString().slice(0,10),
        type: bhvType.value,
        impact: Number(bhvImpact.value||0),
        order: (bhvOrder.value||'').trim(),
        sbi: (bhvSBI.value||'').trim(),
        evidence: (bhvEvidence.value||'').trim(),
        action: (bhvAction.value||'').trim()
      };
      const arr = getLogs(ym, name);
      if(bhvEditingId){
        const idx = arr.findIndex(x=>x.id===bhvEditingId);
        if(idx>=0) arr[idx] = item;
        bhvEditingId = null;
        bhvAdd.textContent = 'æ–°å¢æ—¥èªŒ';
      }else{
        arr.push(item);
      }
      saveLogs(ym, name, arr);
      bhvOrder.value=''; bhvSBI.value=''; bhvEvidence.value=''; bhvAction.value='';
      renderBehaviorTable(); render(); renderBehaviorOverview();
    });
    bhvApplySuggestBtn.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const { ym, name } = bhvCtx;
      const sugg = suggestLevel(ym, name);
      setLevel(ym, name, sugg);
      render();
      alert(`å·²å¥—ç”¨ç³»çµ±å»ºè­°ï¼š${levelLabel(sugg)}`);
    });

    // è¡Œç‚ºç¸½è¦½åˆ†é ï¼šæ¸²æŸ“
    function renderBehaviorOverview(){
      const ym = bhvMonthInput.value || monthEl.value;
      const name = (bhvNameFilter.value||'').trim();
      const all = readBehaviorLogs();
      const ymObj = all?.[ym] || {};
      const rows = [];
      if(name){
        const arr = ymObj?.[name] || [];
        arr.forEach(l=> rows.push({name, ...l}));
      }else{
        Object.entries(ymObj).forEach(([nm, arr])=>{
          (arr||[]).forEach(l=> rows.push({name:nm, ...l}));
        });
      }
      rows.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
      bhvOverviewTbody.innerHTML = rows.length
        ? rows.map(l=> `<tr><td>${l.date||''}</td><td>${l.name}</td><td>${l.type||''}</td><td>${l.impact||''}</td><td>${(l.order||'').replace(/</g,'&lt;')}</td><td style="text-align:left;">${(l.sbi||'').replace(/</g,'&lt;')}</td></tr>`).join('')
        : `<tr><td colspan="6" class="tiny">æœ¬æœˆå°šç„¡ç¬¦åˆè³‡æ–™</td></tr>`;
    }
    bhvMonthInput.addEventListener('change', renderBehaviorOverview);
    bhvNameFilter.addEventListener('input', renderBehaviorOverview);
    bhvOpenModalBtn.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const n = (bhvNameFilter.value||'').trim();
      if(!n){ alert('è«‹å…ˆé¸æ“‡å§“å'); return; }
      bhvCtx = { ym: bhvMonthInput.value || monthEl.value, name: n };
      openBehaviorModal(n);
    });

    // ç¯©é¸ï¼ˆæ¥­å‹™æ˜ç´°ï¼‰
    function applyFilters(list){
      let out = list.slice();
      const ym = monthEl.value;
      if(ym){ out = out.filter(r=> (r.date||'').startsWith(ym)); }
      const kw = (filterNameEl.value||'').trim();
      if(kw){ out = out.filter(r=> r.name.includes(kw)); }
      return out;
    }

    // åˆ†é ï¼ˆæ¥­å‹™æ˜ç´°ï¼‰
    function getTotalPages(list){ return Math.max(1, Math.ceil(list.length / PAGE_SIZE)); }
    function updatePager(totalPages){
      pageInfoEl.textContent = `ç¬¬ ${totalPages ? currentPage : 1} / ${totalPages} é `;
      prevPageBtn.disabled = (currentPage <= 1);
      nextPageBtn.disabled = (currentPage >= totalPages);
    }
    prevPageBtn.addEventListener('click', ()=>{ if(currentPage > 1){ currentPage--; render(); } });
    nextPageBtn.addEventListener('click', ()=>{
      const totalPages = getTotalPages(applyFilters(load()));
      if(currentPage < totalPages){ currentPage++; render(); }
    });

    // åœ–è¡¨
    let chartByPerson, chartByTask;
    function drawCharts(list){
      const byPerson={}, byTask={};
      list.forEach(r=>{ byPerson[r.name]=(byPerson[r.name]||0)+r.total; byTask[r.task]=(byTask[r.task]||0)+r.total; });
      const ctx1=document.getElementById('chartByPerson');
      const ctx2=document.getElementById('chartByTask');
      if(chartByPerson) chartByPerson.destroy();
      if(chartByTask) chartByTask.destroy();
      chartByPerson = new Chart(ctx1,{
        type:'bar',
        data:{labels:Object.keys(byPerson),datasets:[{label:'ç¸½åˆ†',data:Object.values(byPerson)}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false},title:{display:true,text:'å„äººç¸½åˆ†'}}}
      });
      chartByTask = new Chart(ctx2,{
        type:'pie',
        data:{labels:Object.keys(byTask),datasets:[{data:Object.values(byTask)}]},
        options:{responsive:true,plugins:{title:{display:true,text:'ä»»å‹™åˆ†æ•¸åˆ†å¸ƒ'}}}
      });
    }

    // ç›®æ¨™/åå–®
    const loadTargets = () => read(TARGETS_KEY, {}) || {};
    const saveTargets = (obj) => write(TARGETS_KEY, obj);

    function rebuildTargetsTable(){
      const targets = loadTargets();
      const emps = new Set(read(EMP_KEY, DEFAULT_EMPS));
      Object.keys(targets).forEach(n=> emps.add(n));

      const rows = Array.from(emps).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
      if(!tbodyTargets) return;
      tbodyTargets.innerHTML = rows.length
        ? rows.map(n=>{
            const obj = targets[n] || {};
            const hasTarget = obj.points != null && Number.isFinite(obj.points);
            return `
              <tr>
                <td>${n}</td>
                <td>${hasTarget ? obj.points : ''}</td>
                <td style="text-align:left">${(obj.note||'').replace(/</g,'&lt;')}</td>
                <td class="actions">
                  <button class="btn-edit btn-s" data-fill="${n}">å¸¶å…¥</button>
                  ${hasTarget ? `<button class="btn-delete btn-s" data-del-target="${n}" data-admin-action>åˆªç›®æ¨™</button>` : ``}
                  <button class="btn-delete btn-s" data-del-emp="${n}" data-admin-action>åˆªå“¡å·¥</button>
                </td>
              </tr>`;
          }).join('')
        : `<tr><td colspan="4" class="tiny">åå–®å°šç„¡å“¡å·¥</td></tr>`;

      tbodyTargets.querySelectorAll('button[data-fill]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const n=b.dataset.fill;
          const t = loadTargets()[n] || {};
          tName.value = n;
          tPoints.value = t.points ?? '';
          tNote.value = t.note || '';
          tName.focus();
        });
      });
      tbodyTargets.querySelectorAll('button[data-del-target]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
          const n=b.dataset.delTarget;
          if(!confirm(`ç¢ºå®šåˆªé™¤ ${n} çš„ç›®æ¨™è¨­å®šï¼Ÿ`)) return;
          const all = loadTargets();
          if(all[n]){
            delete all[n];
            saveTargets(all);
            rebuildTargetsTable();
            render();
          }
        });
      });
      tbodyTargets.querySelectorAll('button[data-del-emp]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
          const n=b.dataset.delEmp;
          if(!confirm(`ç¢ºå®šåˆªé™¤å“¡å·¥ ${n}ï¼Ÿï¼ˆåŒæ™‚æœƒåˆªé™¤å…¶ç›®æ¨™è¨­å®šï¼›æ—¢æœ‰ç´€éŒ„ä¸å—å½±éŸ¿ï¼‰`)) return;
          let list=read(EMP_KEY, DEFAULT_EMPS).filter(x=>x!==n);
          write(EMP_KEY, list);
          const all = loadTargets(); if(all[n]){ delete all[n]; saveTargets(all); }
          rebuildEmpUI(); rebuildTargetsTable(); render();
        });
      });
    }

    // KPI æ¨™ç±¤
    function statusTag(score, th){
      if(score >= th*1.333) return '<span class="tag ok">å„ªç§€</span>';
      if(score >= th) return '<span class="tag warn">é”æ¨™</span>';
      return '<span class="tag bad">æœªé”æ¨™</span>';
    }

    // ç·¨è¼¯ç´€éŒ„ï¼ˆæ¥­å‹™ï¼‰
    function openEditModal(rec){
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      editId.value = rec.id;
      editOrderNo.value = rec.orderNo || '';
      editDate.value = rec.date || '';
      editName.value = rec.name || '';
      editTask.value = rec.task || '';
      editQty.value = rec.qty || 1;
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const spi = Number.isFinite(tasks[rec.task]) ? tasks[rec.task] : (rec.scorePerItem||0);
      editScorePerItem.value = spi;
      editNote.value = rec.note || '';
      editStage.value = rec.stage || 'NOT_STARTED';
      editModal.classList.remove('hidden'); editModal.setAttribute('aria-hidden','false');
    }
    function closeEditModal(){ editModal.classList.add('hidden'); editModal.setAttribute('aria-hidden','true'); }
    document.getElementById('edit-task').addEventListener('change', ()=>{
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      editScorePerItem.value = tasks[document.getElementById('edit-task').value] || 0;
    });
    editCancel.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeEditModal(); });
    editForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const id = editId.value;
      let list = load();
      const idx = list.findIndex(r=>r.id===id);
      if(idx<0){ alert('æ‰¾ä¸åˆ°è©²ç­†ç´€éŒ„'); closeEditModal(); return; }
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const newTask = document.getElementById('edit-task').value;
      const newQty = Number(editQty.value)||0;
      const newScorePerItem = Number.isFinite(tasks[newTask]) ? tasks[newTask] : (list[idx].scorePerItem||0);
      const newTotal = newScorePerItem * newQty;

      const newOrder = (editOrderNo.value||'').trim();
      if(!isNoOrder(newOrder) && newOrder !== list[idx].orderNo){
        const dup = list.some((r,i)=> i!==idx && (r.orderNo||'').trim()===newOrder);
        if(dup){ alert('æ­¤å–®è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å–®è™Ÿ'); return; }
      }

      const newStageKey = editStage.value || 'NOT_STARTED';
      list[idx] = { ...list[idx],
        orderNo: newOrder, date: editDate.value, name: (editName.value||'').trim(),
        task: newTask, qty: newQty, scorePerItem: newScorePerItem, total: newTotal,
        note: (editNote.value||'').trim(), stage: newStageKey, stagePct: STAGE[newStageKey]?.pct ?? 0
      };
      save(list);

      const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(list[idx].name); write(EMP_KEY, Array.from(set)); rebuildEmpUI(); rebuildTargetsTable();
      closeEditModal(); render(); alert('å·²æ›´æ–°');
    });

    // æ¸²æŸ“ï¼ˆç¸½è¦½/æ¥­å‹™ï¼‰
    function render(){
      const admin = isAdmin();
      let list = load();

      // å…¼å®¹èˆŠè³‡æ–™ï¼šè£œ stage
      let patched = false;
      list.forEach(r=>{ if(!r.stage){ r.stage = 'NOT_STARTED'; r.stagePct = 0; patched = true; } });
      if(patched) save(list);

      const filtered = applyFilters(list);
      const totalPages = getTotalPages(filtered);
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageList = filtered.slice(start, end);

      // æ˜ç´°è¡¨ï¼ˆæ¥­å‹™ç´€éŒ„åˆ†é ï¼‰
      tbody.innerHTML = pageList.map(r=>{
        const stageKey = r.stage || 'NOT_STARTED';
        const stageText = (STAGE[stageKey]?.label || '');
        const stagePct = (STAGE[stageKey]?.pct ?? 0);
        return `
        <tr data-stage="${stageKey}">
          <td>${r.orderNo||''}</td><td>${r.date||''}</td><td>${r.name||''}</td><td>${r.task||''}</td>
          <td>${r.qty||''}</td><td>${r.scorePerItem||''}</td><td>${r.total||''}</td>
          <td>${stageText}ï¼ˆ${stagePct}%ï¼‰</td><td>${(r.note||'').replace(/</g,'&lt;')}</td>
          ${admin ? `<td class="actions"><button class="btn-edit btn-s" data-edit-id="${r.id}" data-admin-action>ç·¨è¼¯</button><button class="btn-delete btn-s" data-id="${r.id}" data-admin-action>åˆªé™¤</button></td>` : ``}
        </tr>`;
      }).join('') || `<tr><td colspan="${admin?10:9}" class="tiny">æœ¬æœˆå°šç„¡è³‡æ–™</td></tr>`;

      if (admin){
        tbody.querySelectorAll('button[data-id]').forEach(btn=> btn.addEventListener('click', ()=> removeOne(btn.dataset.id)));
        tbody.querySelectorAll('button[data-edit-id]').forEach(btn=> btn.addEventListener('click', ()=>{
          const id = btn.dataset.editId;
          const rec = load().find(x=>x.id===id);
          if(rec) openEditModal(rec);
        }));
      }

      // ç•¶é åˆè¨ˆ
      const totals = pageList.reduce((acc, r) => { acc.qty += Number(r.qty)||0; acc.score += Number(r.total)||0; return acc; }, {qty:0, score:0});
      if(pageList.length){
        tfoot.innerHTML = admin
          ? `<tr><td colspan="4" style="text-align:right;">ç•¶é åˆè¨ˆ</td><td>${totals.qty}</td><td></td><td>${totals.score}</td><td></td><td></td><td></td></tr>`
          : `<tr><td colspan="4" style="text-align:right;">ç•¶é åˆè¨ˆ</td><td>${totals.qty}</td><td></td><td>${totals.score}</td><td></td><td></td></tr>`;
      }else tfoot.innerHTML = '';

      // åˆ†é è³‡è¨Š
      updatePager(totalPages);

      // åœ–è¡¨ï¼ˆç¸½è¦½ï¼‰
      drawCharts(filtered);

      // æ¯æœˆç¸½è¡¨ï¼ˆæ­£è¦åŒ– + è¡Œç‚ºèª¿æ•´ï¼‰
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const sumTask = Object.values(tasks).reduce((a,b)=>a+b,0);

      const normSumByName = {};
      if(sumTask > 0){
        filtered.forEach(r=>{
          const unitNorm = (r.scorePerItem || 0) / sumTask * 100;
          const add = unitNorm * (Number(r.qty)||0);
          normSumByName[r.name] = (normSumByName[r.name]||0) + add;
        });
      }else{
        filtered.forEach(r=>{ normSumByName[r.name] = 0; });
      }

      const allNames = new Set(read(EMP_KEY, DEFAULT_EMPS));
      Object.keys(normSumByName).forEach(n=> allNames.add(n));

      const targets = read(TARGETS_KEY, {}) || {};
      function personTargetPercent(name){
        if(sumTask <= 0) return 100;
        const targetPoints = targets[name]?.points;
        if(targetPoints == null || !Number.isFinite(targetPoints)) return 100;
        return Math.max(0, (targetPoints / sumTask) * 100);
      }

      const th = read(THRESHOLD_KEY, 80);
      const ym = monthEl.value;

      let rows = Array.from(allNames).map(n=>{
        const normTotal = normSumByName[n] || 0;
        const targetPct = personTargetPercent(n) || 1;
        const kpiPct = Math.min(100, Math.round(normTotal / targetPct * 100));
        const lv = getLevel(ym, n);
        const adj = LEVEL[lv]?.adjust ?? 0;
        const finalPct = clamp(Math.round(kpiPct * (1 + adj)), 0, 200);
        const tag = statusTag(finalPct, th);
        const isUnder = finalPct < th;
        return { n, base: kpiPct, lv, finalPct, tag, isUnder };
      });

      if (onlyUnderEl.checked) rows = rows.filter(r=> r.isUnder);
      rows.sort((a,b)=> b.finalPct - a.finalPct);
      tbodyUnder.innerHTML = rows.length
        ? rows.map(r=>{
            const lvOpt = Object.entries(LEVEL).map(([k,v])=>`<option value="${k}" ${r.lv===k?'selected':''}>${v.label}</option>`).join('');
            return `<tr>
              <td>${r.n}</td>
              <td>${r.base}%</td>
              <td>
                <select class="bhv-level" data-name="${r.n}" ${isAdmin()?'':'disabled'} style="padding:6px 8px;border:1px solid var(--border);border-radius:8px;">
                  ${lvOpt}
                </select>
              </td>
              <td>${r.finalPct}%</td>
              <td>${r.tag}</td>
              <td class="col-log"><button class="btn-outline btn-s" data-bhv="${r.n}" ${isAdmin()?'':'disabled'}>ğŸ“ æ—¥èªŒ</button></td>
            </tr>`;
          }).join('')
        : `<tr><td colspan="6" class="tiny">${onlyUnderEl.checked ? 'ç•¶æœˆç„¡æœªé”æ¨™äººå“¡' : 'æœ¬æœˆå°šç„¡è³‡æ–™'}</td></tr>`;

      // ç¶å®šç­‰ç´šåˆ‡æ› & æ—¥èªŒ
      tbodyUnder.querySelectorAll('select.bhv-level').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); sel.value = getLevel(ym, sel.dataset.name); return; }
          setLevel(ym, sel.dataset.name, sel.value); render();
        });
      });
      tbodyUnder.querySelectorAll('button[data-bhv]').forEach(btn=> btn.addEventListener('click', ()=> openBehaviorModal(btn.dataset.bhv)));
    }

    // ===== å·¥ä½œæ—¥èªŒ =====
    function readWorklog(){ return read(WORKLOG_KEY, []); }
    function writeWorklog(list){ write(WORKLOG_KEY, list); }
    wlForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const item = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        date: wlDate.value,
        name: (wlName.value||'').trim(),
        hours: Number(wlHours.value||0),
        content: (wlContent.value||'').trim(),
        note: (wlNote.value||'').trim()
      };
      const list = readWorklog(); list.push(item); writeWorklog(list);
      wlForm.reset(); wlDate.valueAsDate = new Date();
      renderWorklog(); alert('å·²æ–°å¢å·¥ä½œæ—¥èªŒ');
    });

    function openWLEdit(item){
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      wlEditId.value = item.id;
      wlEditDate.value = item.date || '';
      wlEditName.value = item.name || '';
      wlEditHours.value = Number(item.hours||0);
      wlEditNote.value = item.note || '';
      wlEditContent.value = item.content || '';
      wlEditModal.classList.remove('hidden'); wlEditModal.setAttribute('aria-hidden','false');
    }
    function closeWLEdit(){ wlEditModal.classList.add('hidden'); wlEditModal.setAttribute('aria-hidden','true'); }
    wlEditCancel.addEventListener('click', closeWLEdit);
    wlEditModal.addEventListener('click', (e)=>{ if(e.target===wlEditModal) closeWLEdit(); });
    wlEditForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const id = wlEditId.value;
      const list = readWorklog();
      const idx = list.findIndex(x=>x.id===id);
      if(idx<0){ alert('æ‰¾ä¸åˆ°è©²ç­†å·¥ä½œæ—¥èªŒ'); closeWLEdit(); return; }
      list[idx] = {
        ...list[idx],
        date: wlEditDate.value,
        name: (wlEditName.value||'').trim(),
        hours: Number(wlEditHours.value||0),
        note: (wlEditNote.value||'').trim(),
        content: (wlEditContent.value||'').trim()
      };
      writeWorklog(list);
      closeWLEdit(); renderWorklog(); alert('å·²æ›´æ–°å·¥ä½œæ—¥èªŒ');
    });

    function renderWorklog(){
      const ym = wlMonth.value;
      const nm = (wlFilterName.value||'').trim();
      const list = readWorklog().filter(x=>{
        const okMonth = ym ? (x.date||'').startsWith(ym) : true;
        const okName = nm ? (x.name||'').includes(nm) : true;
        return okMonth && okName;
      }).sort((a,b)=> String(a.date).localeCompare(String(b.date)));
      const admin = isAdmin();
      wlTbody.innerHTML = list.length ? list.map(x=>`
        <tr>
          <td>${x.date||''}</td>
          <td>${x.name||''}</td>
          <td>${Number(x.hours||0)}</td>
          <td style="text-align:left;">${(x.content||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(x.note||'').replace(/</g,'&lt;')}</td>
          <td class="actions">
            ${admin ? `<button class="btn-edit btn-s" data-wl-edit="${x.id}">ç·¨è¼¯</button>` : ``}
            ${admin ? `<button class="btn-delete btn-s" data-wl-del="${x.id}">åˆªé™¤</button>` : ``}
          </td>
        </tr>
      `).join('') : `<tr><td colspan="6" class="tiny">å°šç„¡è³‡æ–™</td></tr>`;
      // ç¶äº‹ä»¶
      if (admin){
        wlTbody.querySelectorAll('button[data-wl-edit]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.wlEdit;
            const item = readWorklog().find(x=> x.id===id);
            if(item) openWLEdit(item);
          });
        });
        wlTbody.querySelectorAll('button[data-wl-del]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.wlDel;
            const item = readWorklog().find(x=>x.id===id);
            const label = item ? `ï¼ˆ${item.date||''}ï½œ${item.name||''}ï½œ${(item.content||'').slice(0,20)}â€¦ï¼‰` : '';
            if(!confirm(`ç¢ºå®šåˆªé™¤æ­¤å·¥ä½œæ—¥èªŒï¼Ÿ${label}`)) return;
            const list2 = readWorklog().filter(x=> x.id!==id);
            writeWorklog(list2);
            renderWorklog();
          });
        });
      }
    }
    wlMonth.addEventListener('change', renderWorklog);
    wlFilterName.addEventListener('input', renderWorklog);
    wlClearFilter.addEventListener('click', ()=>{
      wlMonth.value = monthEl.value; wlFilterName.value=''; renderWorklog();
    });

    // ===== é€šè¯ç´€éŒ„ =====
    function readCalllog(){ return read(CALLLOG_KEY, []); }
    function writeCalllog(list){ writeCalllog._re = (writeCalllog._re||0); localStorage.setItem(CALLLOG_KEY, JSON.stringify(list)); } // ä¿ç•™
    // æ”¹å¯«ç‚ºèˆ‡å…¶ä»–ä¸€è‡´
    function _writeCalllog(list){ localStorage.setItem(CALLLOG_KEY, JSON.stringify(list)); }

    clForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const item = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        dt: clDT.value,
        contact: (clContact.value||'').trim(),
        type: clType.value,
        ext: (clExt.value||'').trim(),
        summary: (clSummary.value||'').trim(),
        status: clStatus.value,
        note: (clNote.value||'').trim()
      };
      const list = readCalllog(); list.push(item); _writeCalllog(list);
      clForm.reset(); clDT.value = new Date().toISOString().slice(0,16);
      renderCalllog(); alert('å·²æ–°å¢é€šè¯');
    });

    function openCLEdit(item){
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      clEditId.value = item.id;
      clEditDT.value = item.dt || '';
      clEditContact.value = item.contact || '';
      clEditType.value = item.type || 'ä¾†é›»';
      clEditExt.value = item.ext || '';
      clEditSummary.value = item.summary || '';
      clEditStatus.value = item.status || 'æœªè™•ç†';
      clEditNote.value = item.note || '';
      clEditModal.classList.remove('hidden'); clEditModal.setAttribute('aria-hidden','false');
    }
    function closeCLEdit(){ clEditModal.classList.add('hidden'); clEditModal.setAttribute('aria-hidden','true'); }
    clEditCancel.addEventListener('click', closeCLEdit);
    clEditModal.addEventListener('click', (e)=>{ if(e.target===clEditModal) closeCLEdit(); });
    clEditForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const id = clEditId.value;
      const list = readCalllog();
      const idx = list.findIndex(x=>x.id===id);
      if(idx<0){ alert('æ‰¾ä¸åˆ°è©²ç­†é€šè¯ç´€éŒ„'); closeCLEdit(); return; }
      list[idx] = {
        ...list[idx],
        dt: clEditDT.value,
        contact: (clEditContact.value||'').trim(),
        type: clEditType.value,
        ext: (clEditExt.value||'').trim(),
        summary: (clEditSummary.value||'').trim(),
        status: clEditStatus.value,
        note: (clEditNote.value||'').trim()
      };
      _writeCalllog(list);
      closeCLEdit(); renderCalllog(); alert('å·²æ›´æ–°é€šè¯ç´€éŒ„');
    });

    function renderCalllog(){
      const ym = clMonth.value;
      const kw = (clKW.value||'').trim();
      const list = readCalllog().filter(x=>{
        const okMonth = ym ? (x.dt||'').slice(0,7)===ym : true;
        const hay = `${x.contact} ${x.summary} ${x.note}`.toLowerCase();
        const okKW = kw ? hay.includes(kw.toLowerCase()) : true;
        return okMonth && okKW;
      }).sort((a,b)=> String(a.dt).localeCompare(String(b.dt)));
      const admin = isAdmin();
      clTbody.innerHTML = list.length ? list.map(x=>`
        <tr>
          <td>${x.dt?.replace('T',' ')||''}</td>
          <td>${(x.contact||'').replace(/</g,'&lt;')}</td>
          <td>${x.type||''}</td>
          <td>${(x.ext||'')}</td>
          <td>${(x.summary||'').replace(/</g,'&lt;')}</td>
          <td>${x.status||''}</td>
          <td style="text-align:left;">${(x.note||'').replace(/</g,'&lt;')}</td>
          <td class="actions">
            ${admin ? `<button class="btn-edit btn-s" data-cl-edit="${x.id}">ç·¨è¼¯</button>` : ``}
            ${admin ? `<button class="btn-delete btn-s" data-cl-del="${x.id}">åˆªé™¤</button>` : ``}
          </td>
        </tr>
      `).join('') : `<tr><td colspan="8" class="tiny">å°šç„¡è³‡æ–™</td></tr>`;
      if (admin){
        clTbody.querySelectorAll('button[data-cl-edit]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.clEdit;
            const item = readCalllog().find(x=> x.id===id);
            if(item) openCLEdit(item);
          });
        });
        clTbody.querySelectorAll('button[data-cl-del]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.clDel;
            const item = readCalllog().find(x=>x.id===id);
            const label = item ? `ï¼ˆ${(item.dt||'').replace('T',' ')}ï½œ${item.contact||''}ï½œ${(item.summary||'').slice(0,20)}â€¦ï¼‰` : '';
            if(!confirm(`ç¢ºå®šåˆªé™¤æ­¤é€šè¯ç´€éŒ„ï¼Ÿ${label}`)) return;
            const list2 = readCalllog().filter(x=> x.id!==id);
            _writeCalllog(list2);
            renderCalllog();
          });
        });
      }
    }
    clMonth.addEventListener('change', renderCalllog);
    clKW.addEventListener('input', renderCalllog);
    clClearFilter.addEventListener('click', ()=>{
      clMonth.value = monthEl.value; clKW.value=''; renderCalllog();
    });

    // äº‹ä»¶ï¼šç¸½è¦½æ§åˆ¶
    document.getElementById('kpi-cancel')?.addEventListener('click', ()=> {
      document.getElementById('kpi-login-modal').classList.add('hidden');
    });

    // å•Ÿå‹•
    function boot(){
      setupTabs();
      setRole(getRole());
      rebuildTaskUI(); rebuildEmpUI(); rebuildTargetsTable();
      updateAutoScore();
      renderBehaviorOverview(); renderWorklog(); renderCalllog();
    }
    boot();
  </script>
</body>
</html>
