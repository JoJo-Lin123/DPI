<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI 填報與視覺化總表（本機版）</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #1e88e5;
      --primary-600: #1565c0;
      --border: #e5e7eb;

      --row-amber: #fffbeb;
      --row-blue:  #e8f4fd;
      --row-green: #e6f4ea;

      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;

      --chip: #e3f2fd;
      --banner-bg: linear-gradient(90deg,#e0f2fe, #f0f9ff);
      --banner-fg: #075985;
    }
    body[data-role="admin"]{
      --primary:#818cf8;
      --primary-600:#6366f1;
      --bg:#eef2ff;
      --banner-bg: linear-gradient(90deg,#e0e7ff,#f3e8ff);
      --banner-fg:#3730a3;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); line-height: 1.6; transition: background .25s ease; }
    .wrap { max-width: 1220px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:12px; }
    h1 { font-size: 24px; margin: 0; color: var(--primary); transition: color .25s ease; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .btn, .btn-secondary, .btn-ghost, .btn-outline, .btn-danger, .btn-login{
      border-radius:10px; padding:10px 14px; font-weight:600; border:1px solid transparent; cursor:pointer; outline:none; box-shadow:none;
      transition: background .2s, color .2s, transform .05s, opacity .2s, filter .2s, border-color .2s;
    }
    .btn, .btn:focus, .btn:focus-visible,
    .btn-secondary, .btn-secondary:focus, .btn-secondary:focus-visible,
    .btn-ghost, .btn-ghost:focus, .btn-ghost:focus-visible,
    .btn-outline, .btn-outline:focus, .btn-outline:focus-visible,
    .btn-danger, .btn-danger:focus, .btn-danger:focus-visible,
    .btn-login, .btn-login:focus, .btn-login:focus-visible { outline:none; box-shadow:none; }

    .btn { background: var(--primary); color:#fff; }
    .btn:hover{ background: var(--primary-600); }
    .btn:active{ transform: translateY(1px); }

    .btn-secondary{ background:#eef2ff; color:#4f46e5; }
    .btn-secondary:hover{ filter: brightness(.96); }

    .btn-ghost{ background:#ffffff; color:#374151; border:1px solid var(--border); }
    .btn-ghost:hover{ filter: brightness(.98); }

    .btn-outline{ background:#fff; color:#4f46e5; border:1px solid #c7d2fe; }
    .btn-outline:hover{ border-color:#a78bfa; }

    .btn-danger{ background:#ef5350; color:#fff; }
    .btn-danger:hover{ background:#d32f2f; }

    .btn-login{
      border-radius:999px; padding:8px 14px; font-weight:800;
      background: linear-gradient(#fff,#fff) padding-box, linear-gradient(90deg,#93c5fd,#c4b5fd) border-box;
      color:#334155; border:1px solid transparent;
    }
    .btn-login:hover{ filter: brightness(.98); }
    .btn-login:active{ transform: translateY(0); }
    body[data-role="admin"] .btn-login{ background: linear-gradient(90deg,#818cf8,#a78bfa); color:#fff; }

    .btn-s{ height:32px; padding:0 10px; font-size:12px; border-radius:10px; border:1px solid transparent; outline:none; box-shadow:none; }
    .btn-edit{ background:#fff; color: var(--primary); border:1px solid #c7d2fe; }
    .btn-edit:hover{ color: var(--primary-600); border-color:#a78bfa; background:#fff; }
    .btn-delete{ background:#fff; color:#c2185b; border:1px solid #f8bbd0; }
    .btn-delete:hover{ color:#ad1457; border-color:#f48fb1; background:#fff; }

    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 1080px){ .grid-2 { grid-template-columns: 1.1fr 1fr; } .grid-3 { grid-template-columns: 1.1fr 1fr 1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; }
    .card h2 { margin: 0 0 12px; font-size:18px; color:#111827; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:#fff; }
    textarea{ min-height:72px; }
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 720px){ .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 1fr 1fr 1fr; } .row-4 { grid-template-columns: repeat(4,1fr); } }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom: 1px solid var(--border); text-align:center; }
    thead th { background:#f8fafc; font-size:13px; color:#374151; font-weight:600; }
    tbody td { font-size:14px; font-weight:400; }
    tbody tr:not([data-stage]):hover { background:#f9fafb; }
    tfoot td { background:#f8fafc; font-weight:700; }

    .tag { padding:4px 8px; border-radius:8px; font-weight:600; font-size:12px; }
    .tag.ok{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .tag.warn{ background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .tag.bad{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    .actions { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .tiny { font-size:12px; color:#6b7280; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#f3f4f6; border:1px solid var(--border); border-radius:999px; }

    .scroll-area{ max-height: 320px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; }
    .scroll-area thead th{ position: sticky; top: 0; z-index: 1; background: #f8fafc; box-shadow: 0 1px 0 var(--border); }

    #chips { display: none; }

    /* 權限 */
    body[data-role="user"] [data-admin-action] { display: none !important; }
    body[data-role="user"] #threshold { opacity:.6; pointer-events:none; }
    body[data-role="user"] [data-admin-section] { display:none !important; }
    body[data-role="user"] .col-log { display:none; }

    .login-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid var(--primary); color:var(--primary-600); border-radius:999px; }
    body[data-role="admin"] .login-pill{ background:linear-gradient(90deg,#e0e7ff,#f3e8ff); color:#3730a3; border-color:#a78bfa; }

    .role-banner { display:none; position:sticky; top:0; z-index:50; padding:8px 16px; text-align:center; font-weight:800; letter-spacing:.5px; background: var(--banner-bg); color: var(--banner-fg); border-bottom:1px solid var(--border); }
    body[data-role="admin"] .role-banner{ display:block; }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px; }
    .tab-btn { background:#fff; border:1px solid var(--border); color:#374151; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; }
    .tab-btn.active { background: var(--primary); color:#fff; border-color: transparent; }
    .tab { display:none; gap:16px; }
    .tab.active { display:block; }

    /* Modal */
    .kpi-modal.hidden { display:none; }
    .kpi-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; padding:16px; }
    .kpi-modal .panel { background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; width:min(780px,92vw); }
    .kpi-modal h3{ margin:0 0 14px; font-size:20px; color:#111827; }
    .kpi-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    /* 明細列底色 */
    tbody tr[data-stage="NOT_STARTED"] { background-color: transparent; color: inherit; }
    tbody tr[data-stage="IN_PROGRESS"] { background-color: var(--row-blue);  color: #1565c0; }
    tbody tr[data-stage="DONE"]        { background-color: var(--row-green); color: #2e7d32; }

    #chartByTask{ display:block; margin:0 auto; transform: scale(0.85); transform-origin: top center; }
  </style>
</head>
<body>
  <div class="role-banner">目前為「管理者模式」</div>

  <div class="wrap">
    <header>
      <h1>KPI 填報與視覺化總表</h1>
      <div class="toolbar">
        <span id="roleBadge" class="login-pill">角色：使用者</span>
        <button class="btn-login" id="loginBtn">🔐 登入</button>
        <button class="btn" id="exportCsv" data-admin-action>匯出 CSV</button>
        <button class="btn-danger" id="clearAll" data-admin-action>清除全部資料</button>
      </div>
    </header>

    <!-- Tabs 導覽 -->
    <nav class="tabs" id="tabs">
      <button class="tab-btn active" data-tab-target="tab-dashboard">總覽</button>
      <button class="tab-btn" data-tab-target="tab-business">業務紀錄</button>
      <button class="tab-btn" data-tab-target="tab-behavior">行為日誌</button>
      <button class="tab-btn" data-tab-target="tab-worklog">工作日誌</button>
      <button class="tab-btn" data-tab-target="tab-calllog">通聯紀錄</button>
    </nav>

    <!-- 總覽 -->
    <section id="tab-dashboard" class="tab active">
      <div class="grid grid-2">
        <section class="card">
          <h2>視覺化總覽</h2>
          <div class="row row-2" style="margin-bottom:8px;">
            <div>
              <label for="month">月份</label>
              <input type="month" id="month" />
            </div>
            <div>
              <label for="filterName">姓名</label>
              <input type="text" id="filterName" placeholder="篩選姓名（可留空）" />
            </div>
          </div>
          <canvas id="chartByPerson" height="140"></canvas>
          <canvas id="chartByTask" height="140"></canvas>
        </section>

        <section class="card">
          <h2>每月總表（依人彙總）與設定</h2>
          <div class="row row-2">
            <div>
              <label>達標門檻（%）</label>
              <input type="number" id="threshold" min="0" max="100" step="1" />
              <div class="tiny">優秀 ≥ 門檻×1.333；達標 ≥ 門檻；其餘未達標。</div>
            </div>
            <div>
              <label>快速操作</label>
              <div class="pill"><span>當前月份：</span><span id="pillMonth">—</span></div>
              <div style="margin-top:8px;">
                <input type="checkbox" id="onlyUnder" />
                <label for="onlyUnder">只顯示未達標（以「最終%」判斷）</label>
              </div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <table>
              <thead id="thead-under">
                <tr>
                  <th>姓名</th>
                  <th>完成率</th>
                  <th>行為等級</th>
                  <th>最終%</th>
                  <th>狀態</th>
                  <th class="col-log">日誌</th>
                </tr>
              </thead>
              <tbody id="tbody-under"></tbody>
            </table>
            <div class="tiny" style="margin-top:6px;">行為等級：優(+5%)／正常(0%)／待改善(-5%)／警示(-10%)；每月歸零。</div>
          </div>
        </section>
      </div>

      <!-- 任務管理 -->
      <section class="card" style="margin-top:16px;" data-admin-section>
        <h2>任務類型管理</h2>
        <div class="row row-3">
          <div><label>任務名稱</label><input type="text" id="mTaskName" placeholder="例如：影片剪輯" /></div>
          <div><label>單件分數</label><input type="number" id="mTaskScore" min="0" step="1" placeholder="例如：30" /></div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="btn" id="addTask" data-admin-action>新增 / 更新任務</button>
            <button class="btn-outline" id="resetDefaults" data-admin-action>恢復預設任務</button>
          </div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>任務</th><th>分數</th><th>操作</th></tr></thead>
            <tbody id="tbody-tasks"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:8px;">正規化僅用於 KPI 計算；圖表與明細仍顯示原始分。</div>
      </section>

      <!-- 員工 & 目標（合併一份名單） -->
      <section class="card" style="margin-top:16px;" data-admin-section>
        <h2>員工與目標設定（單一名單）</h2>
        <div class="row row-3">
          <div><label>員工姓名</label><input type="text" id="tName" list="empList" placeholder="輸入或選擇既有姓名" /></div>
          <div><label>每月目標分</label><input type="number" id="tPoints" min="0" step="1" placeholder="例如：300" /></div>
          <div><label>角色說明（選填）</label><input type="text" id="tNote" placeholder="例如：剪輯主力、件數少難度高" /></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button class="btn" id="saveTarget" data-admin-action>儲存 / 更新</button>
          <button class="btn-delete btn-s" id="deleteTarget" data-admin-action>刪除該員工目標</button>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>姓名</th><th>目標分</th><th>角色說明</th><th>操作</th></tr></thead>
            <tbody id="tbody-targets"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:8px;">說明：此表即為唯一名單。未設定目標者之「目標%」= 100%（等於以任務分總和作為目標）。</div>
      </section>
    </section>

    <!-- 業務紀錄 -->
    <section id="tab-business" class="tab">
      <section class="card">
        <h2>新增紀錄</h2>
        <form id="form">
          <div class="row row-4">
            <div><label>單號</label><input type="text" id="orderNo" placeholder="可留空或輸入「無」" /></div>
            <div><label>日期</label><input type="date" id="date" required /></div>
            <div><label>姓名</label><input type="text" id="name" list="empList" placeholder="例如：員工A" required /><datalist id="empList"></datalist></div>
            <div><label>任務類型</label><select id="task" required></select></div>
          </div>
          <div class="row row-4">
            <div><label>件數</label><input type="number" id="qty" min="1" value="1" required /></div>
            <div><label>自動得分</label><input type="text" id="autoScore" readonly placeholder="系統計算" /></div>
            <div>
              <label>進度</label>
              <select id="stage" required>
                <option value="NOT_STARTED">未開始（0%）</option>
                <option value="IN_PROGRESS">進行中（50%）</option>
                <option value="DONE">已完成（100%）</option>
              </select>
            </div>
            <div><label>備註</label><input type="text" id="note" placeholder="可留空" /></div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <div class="tiny">KPI% 以「任務分數正規化（總和=100）」計算；個人目標亦換算為百分比（未設定者視為 100%）。</div>
            <div id="chips" class="chips"></div>
            <button class="btn" type="submit">儲存紀錄</button>
          </div>
        </form>
      </section>

      <section class="card" style="margin-top:16px;">
        <h2>紀錄明細</h2>
        <table>
          <thead id="thead-records">
            <tr>
              <th>單號</th><th>日期</th><th>姓名</th><th>任務</th><th>件數</th><th>單件分</th><th>總分</th><th>進度</th><th>備註</th><th data-admin-action>操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
        <div id="pager" style="display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:8px;">
          <button id="prevPage" class="btn-outline btn-s">上一頁</button>
          <span id="pageInfo" class="tiny">第 1 / 1 頁</span>
          <button id="nextPage" class="btn-outline btn-s">下一頁</button>
        </div>
      </section>
    </section>

    <!-- 行為日誌（總覽面板 + 原有 Modal） -->
    <section id="tab-behavior" class="tab">
      <section class="card">
        <h2>行為日誌總覽</h2>
        <div class="row row-3">
          <div>
            <label>月份</label>
            <input type="month" id="bhv-month" />
          </div>
          <div>
            <label>姓名</label>
            <input type="text" id="bhv-name-filter" list="empList" placeholder="選擇或輸入姓名" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="btn-outline" id="bhv-open-modal" data-admin-action>開啟該人之日誌編輯窗</button>
          </div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>日期</th><th>姓名</th><th>類別</th><th>影響</th><th>單號/任務</th><th style="text-align:left;">SBI 描述</th></tr></thead>
            <tbody id="bhv-overview-tbody"></tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:6px;">提示：欲新增/編輯，請先於上方選擇姓名，點「開啟…」將使用原有 Modal 完整管理。</div>
      </section>
    </section>

    <!-- 工作日誌 -->
    <section id="tab-worklog" class="tab">
      <section class="card">
        <h2>工作日誌</h2>
        <form id="worklog-form">
          <div class="row row-4">
            <div><label>日期</label><input type="date" id="wl-date" required /></div>
            <div><label>姓名</label><input type="text" id="wl-name" list="empList" required /></div>
            <div><label>時數</label><input type="number" id="wl-hours" min="0" step="0.5" placeholder="例如 2 或 0.5" /></div>
            <div><label>備註</label><input type="text" id="wl-note" placeholder="可留空" /></div>
          </div>
          <div class="row">
            <div><label>內容 / 重點</label><textarea id="wl-content" placeholder="今天完成了哪些事項、進度要點…"></textarea></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button class="btn" type="submit">新增日誌</button>
          </div>
        </form>
      </section>

      <section class="card" style="margin-top:16px;">
        <h2>工作日誌清單</h2>
        <div class="row row-3">
          <div><label>月份</label><input type="month" id="wl-month" /></div>
          <div><label>姓名</label><input type="text" id="wl-filter-name" list="empList" /></div>
          <div style="display:flex; align-items:flex-end;"><button id="wl-clear-filter" class="btn-ghost btn-s">清除篩選</button></div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>日期</th><th>姓名</th><th>時數</th><th style="text-align:left;">內容</th><th style="text-align:left;">備註</th><th>操作</th></tr></thead>
            <tbody id="wl-tbody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- 通聯紀錄 -->
    <section id="tab-calllog" class="tab">
      <section class="card">
        <h2>通聯紀錄</h2>
        <form id="call-form">
          <div class="row row-4">
            <div><label>日期時間</label><input type="datetime-local" id="cl-dt" required /></div>
            <div><label>聯絡者</label><input type="text" id="cl-contact" placeholder="姓名或單位" required /></div>
            <div>
              <label>來電/去電</label>
              <select id="cl-type">
                <option value="來電">來電</option>
                <option value="去電">去電</option>
              </select>
            </div>
            <div><label>分機</label><input type="text" id="cl-ext" placeholder="可留空" /></div>
          </div>
          <div class="row row-2">
            <div><label>事項 / 摘要</label><input type="text" id="cl-summary" placeholder="重點摘要" /></div>
            <div>
              <label>處理狀態</label>
              <select id="cl-status">
                <option>未處理</option>
                <option>處理中</option>
                <option>已完成</option>
                <option>暫緩</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>備註</label><textarea id="cl-note" placeholder="可留空"></textarea></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button class="btn" type="submit">新增通聯</button>
          </div>
        </form>
      </section>

      <section class="card" style="margin-top:16px;">
        <h2>通聯清單</h2>
        <div class="row row-3">
          <div><label>月份</label><input type="month" id="cl-month" /></div>
          <div><label>關鍵字</label><input type="text" id="cl-kw" placeholder="聯絡者/摘要/備註" /></div>
          <div style="display:flex; align-items:flex-end;"><button id="cl-clear-filter" class="btn-ghost btn-s">清除篩選</button></div>
        </div>
        <div class="scroll-area" style="margin-top:12px;">
          <table>
            <thead><tr><th>日期時間</th><th>聯絡者</th><th>來/去</th><th>分機</th><th>摘要</th><th>狀態</th><th style="text-align:left;">備註</th><th>操作</th></tr></thead>
            <tbody id="cl-tbody"></tbody>
          </table>
        </div>
      </section>
    </section>
  </div>

  <!-- 登入 Modal -->
  <div id="kpi-login-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="登入">
      <h3>登入</h3>
      <div style="display:flex; gap:6px; background:#f3f4f6; padding:6px; border-radius:12px;">
        <label style="flex:1; position:relative;">
          <input type="radio" name="kpi-role" value="user" checked style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
          <div class="opt" style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; border-radius:10px; font-weight:800; color:#374151; border:1px solid transparent;">👤 使用者</div>
        </label>
        <label style="flex:1; position:relative;">
          <input type="radio" name="kpi-role" value="admin" style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
          <div class="opt" style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; border-radius:10px; font-weight:800; color:#374151; border:1px solid transparent;">🛠️ 管理者</div>
        </label>
      </div>
      <div class="kpi-row" id="kpi-pass-row" style="display:none;">
        <input id="kpi-admin-pass" type="password" placeholder="管理者密碼（預設：123）" />
      </div>
      <div class="tiny" style="margin-top:4px;">管理者擁有：任務／員工／目標維護、行為日誌、編輯/刪除紀錄、匯出與清除資料等權限。</div>
      <div class="kpi-actions">
        <button id="kpi-cancel" class="btn-ghost">取消</button>
        <button id="kpi-confirm" class="btn">登入</button>
      </div>
    </div>
  </div>

  <!-- 編輯紀錄 Modal（業務：原） -->
  <div id="edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="編輯紀錄">
      <h3>編輯紀錄</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-id" />
        <div class="row row-2">
          <div><label>單號</label><input type="text" id="edit-orderNo" placeholder="可留空或輸入「無」" /></div>
          <div><label>日期</label><input type="date" id="edit-date" required /></div>
        </div>
        <div class="row row-2">
          <div><label>姓名</label><input type="text" id="edit-name" list="empList" required /></div>
          <div><label>任務類型</label><select id="edit-task" required></select></div>
        </div>
        <div class="row row-3">
          <div><label>件數</label><input type="number" id="edit-qty" min="1" required /></div>
          <div><label>單件分（依任務）</label><input type="text" id="edit-scorePerItem" readonly /></div>
          <div><label>備註</label><input type="text" id="edit-note" /></div>
        </div>
        <div class="row row-2">
          <div>
            <label>進度</label>
            <select id="edit-stage" required>
              <option value="NOT_STARTED">未開始（0%）</option>
              <option value="IN_PROGRESS">進行中（50%）</option>
              <option value="DONE">已完成（100%）</option>
            </select>
          </div>
        </div>
        <div class="kpi-actions">
          <button type="button" id="edit-cancel" class="btn-ghost">取消</button>
          <button type="submit" class="btn">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 行為日誌 Modal（原） -->
  <div id="bhv-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="行為日誌">
      <h3>📎 行為日誌｜<span id="bhv-title"></span></h3>
      <div class="tiny" id="bhv-suggest" style="margin-bottom:8px;"></div>

      <div class="row row-4">
        <div><label>日期</label><input type="date" id="bhv-date" /></div>
        <div>
          <label>類別</label>
          <select id="bhv-type">
            <option value="錯誤">錯誤</option><option value="遲到">遲到</option><option value="離位">離位</option>
            <option value="未依流程">未依流程</option><option value="溝通不良">溝通不良</option>
            <option value="主動支援">主動支援（正向）</option><option value="流程優化">流程優化（正向）</option><option value="跨部救援">跨部救援（正向）</option>
          </select>
        </div>
        <div>
          <label>影響等級</label>
          <select id="bhv-impact">
            <option value="1">輕微=1</option><option value="2">中=2</option><option value="3">重大=3</option>
          </select>
        </div>
        <div><label>單號/任務</label><input type="text" id="bhv-order" placeholder="可留空或「無」" /></div>
      </div>
      <div class="row">
        <div><label>SBI 描述（事實／行為／影響）</label><textarea id="bhv-sbi" placeholder="例：S: 交付前審查；B: 未更新日期；I: 客訴1次，返工2hr"></textarea></div>
      </div>
      <div class="row row-2">
        <div><label>佐證（連結或說明，可留空）</label><input type="text" id="bhv-evidence" /></div>
        <div><label>採取行動</label><input type="text" id="bhv-action" placeholder="提醒/訓練/調整流程…" /></div>
      </div>
      <div class="kpi-actions">
        <button id="bhv-cancel" class="btn-ghost">關閉</button>
        <button id="bhv-add" class="btn" data-admin-action>新增日誌</button>
        <button id="bhv-apply-suggest" class="btn-outline" data-admin-action>採用系統建議等級</button>
      </div>

      <div class="scroll-area" style="margin-top:12px;">
        <table>
          <thead><tr><th>日期</th><th>類別</th><th>影響</th><th>單號</th><th style="text-align:left;">SBI 描述</th><th style="text-align:left;">佐證</th><th style="text-align:left;">行動</th><th data-admin-action>操作</th></tr></thead>
          <tbody id="bhv-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 新增：工作日誌編輯 Modal -->
  <div id="wl-edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="編輯工作日誌">
      <h3>編輯工作日誌</h3>
      <form id="wl-edit-form">
        <input type="hidden" id="wl-edit-id" />
        <div class="row row-4">
          <div><label>日期</label><input type="date" id="wl-edit-date" required /></div>
          <div><label>姓名</label><input type="text" id="wl-edit-name" list="empList" required /></div>
          <div><label>時數</label><input type="number" id="wl-edit-hours" min="0" step="0.5" /></div>
          <div><label>備註</label><input type="text" id="wl-edit-note" /></div>
        </div>
        <div class="row">
          <div><label>內容 / 重點</label><textarea id="wl-edit-content"></textarea></div>
        </div>
        <div class="kpi-actions">
          <button type="button" id="wl-edit-cancel" class="btn-ghost">取消</button>
          <button type="submit" class="btn">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 新增：通聯紀錄編輯 Modal -->
  <div id="cl-edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="編輯通聯紀錄">
      <h3>編輯通聯紀錄</h3>
      <form id="cl-edit-form">
        <input type="hidden" id="cl-edit-id" />
        <div class="row row-4">
          <div><label>日期時間</label><input type="datetime-local" id="cl-edit-dt" required /></div>
          <div><label>聯絡者</label><input type="text" id="cl-edit-contact" required /></div>
          <div>
            <label>來電/去電</label>
            <select id="cl-edit-type">
              <option value="來電">來電</option>
              <option value="去電">去電</option>
            </select>
          </div>
          <div><label>分機</label><input type="text" id="cl-edit-ext" /></div>
        </div>
        <div class="row row-2">
          <div><label>事項 / 摘要</label><input type="text" id="cl-edit-summary" /></div>
          <div>
            <label>處理狀態</label>
            <select id="cl-edit-status">
              <option>未處理</option>
              <option>處理中</option>
              <option>已完成</option>
              <option>暫緩</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label>備註</label><textarea id="cl-edit-note"></textarea></div>
        </div>
        <div class="kpi-actions">
          <button type="button" id="cl-edit-cancel" class="btn-ghost">取消</button>
          <button type="submit" class="btn">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ===== Safari/舊版相容補丁：若無 Object.hasOwn，改用 hasOwnProperty ===== */
    if (!Object.hasOwn) { Object.hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key); }

    // ===== keys =====
    const KEY = "kpiRecords_v1";
    const TASKS_KEY = "kpiTasks_v1";
    const THRESHOLD_KEY = "kpiThreshold_v1";
    const EMP_KEY = "kpiEmployees_v1";
    const TARGETS_KEY = "kpiTargets_v1";
    const BEHAVIOR_KEY = "kpiBehavior_v1";
    const BEHAVIOR_LOG_KEY = "kpiBehaviorLog_v1";
    // 新增：工作日誌/通聯紀錄
    const WORKLOG_KEY = "kpiWorklog_v1";
    const CALLLOG_KEY = "kpiCalllog_v1";

    const STAGE = {
      NOT_STARTED: { idx: 0, pct: 0,   label: '未開始' },
      IN_PROGRESS: { idx: 1, pct: 50,  label: '進行中' },
      DONE:        { idx: 2, pct: 100, label: '已完成' }
    };

    const LEVEL = {
      EXCELLENT: { label:'優(+5%)', adjust:  0.05 },
      NORMAL:    { label:'正常(0%)', adjust:  0.00 },
      IMPROVE:   { label:'待改善(-5%)', adjust: -0.05 },
      WARN:      { label:'警示(-10%)', adjust: -0.10 },
    };
    const NEG_TYPES = new Set(['錯誤','遲到','離位','未依流程','溝通不良']);
    const POS_TYPES = new Set(['主動支援','流程優化','跨部救援']);

    const DEFAULT_TASKS = {
      "影片剪輯": 30, "海報設計": 10, "衛教單張": 5,
      "Podcast錄音剪輯": 20, "網頁維護": 10, "會議室管理": 5, "拍照/拍攝支援": 15
    };
    const DEFAULT_EMPS = ["員工A","員工B","員工C"];

    // DOM 取用（原）
    const form = document.getElementById('form');
    const orderNoEl = document.getElementById('orderNo');
    const dateEl = document.getElementById('date');
    const nameEl = document.getElementById('name');
    const taskEl = document.getElementById('task');
    const qtyEl = document.getElementById('qty');
    const noteEl = document.getElementById('note');
    const autoScoreEl = document.getElementById('autoScore');
    const stageEl = document.getElementById('stage');

    const tbody = document.getElementById('tbody');
    const tfoot = document.getElementById('tfoot');
    const theadRecords = document.getElementById('thead-records');
    const monthEl = document.getElementById('month');
    const filterNameEl = document.getElementById('filterName');
    const chips = document.getElementById('chips');

    const thresholdEl = document.getElementById('threshold');
    const tbodyUnder = document.getElementById('tbody-under');
    const pillMonth = document.getElementById('pillMonth');
    const onlyUnderEl = document.getElementById('onlyUnder');

    // 任務管理
    const mTaskName = document.getElementById('mTaskName');
    const mTaskScore = document.getElementById('mTaskScore');
    const addTaskBtn = document.getElementById('addTask');
    const resetDefaultsBtn = document.getElementById('resetDefaults');
    const tbodyTasks = document.getElementById('tbody-tasks');

    // 合併名單/目標
    const empList = document.getElementById('empList');
    const tName = document.getElementById('tName');
    const tPoints = document.getElementById('tPoints');
    const tNote = document.getElementById('tNote');
    const tbodyTargets = document.getElementById('tbody-targets');

    // 登入/角色
    const ADMIN_PASS = '123';
    const ROLE_KEY = 'kpi_role_v2';
    const roleBadge = document.getElementById('roleBadge');
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('kpi-login-modal');
    const passRow = document.getElementById('kpi-pass-row');
    const passInput = document.getElementById('kpi-admin-pass');
    const modalConfirm = document.getElementById('kpi-confirm');

    // 編輯紀錄（業務：原）
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editId = document.getElementById('edit-id');
    const editOrderNo = document.getElementById('edit-orderNo');
    const editDate = document.getElementById('edit-date');
    const editName = document.getElementById('edit-name');
    const editTask = document.getElementById('edit-task');
    const editQty = document.getElementById('edit-qty');
    const editScorePerItem = document.getElementById('edit-scorePerItem');
    const editNote = document.getElementById('edit-note');
    const editStage = document.getElementById('edit-stage');
    const editCancel = document.getElementById('edit-cancel');

    // 行為日誌（Modal 既有）
    const bhvModal = document.getElementById('bhv-modal');
    const bhvTitle = document.getElementById('bhv-title');
    const bhvSuggest = document.getElementById('bhv-suggest');
    const bhvApplySuggestBtn = document.getElementById('bhv-apply-suggest');
    const bhvDate = document.getElementById('bhv-date');
    const bhvType = document.getElementById('bhv-type');
    const bhvImpact = document.getElementById('bhv-impact');
    const bhvOrder = document.getElementById('bhv-order');
    const bhvSBI = document.getElementById('bhv-sbi');
    const bhvEvidence = document.getElementById('bhv-evidence');
    const bhvAction = document.getElementById('bhv-action');
    const bhvAdd = document.getElementById('bhv-add');
    const bhvCancel = document.getElementById('bhv-cancel');
    const bhvTbody = document.getElementById('bhv-tbody');
    let bhvEditingId = null; // 編輯中 id

    // 行為日誌（總覽分頁）
    const bhvMonthInput = document.getElementById('bhv-month');
    const bhvNameFilter = document.getElementById('bhv-name-filter');
    const bhvOpenModalBtn = document.getElementById('bhv-open-modal');
    const bhvOverviewTbody = document.getElementById('bhv-overview-tbody');

    // 分頁（業務紀錄）
    const PAGE_SIZE = 20;
    let currentPage = 1;
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoEl = document.getElementById('pageInfo');

    // 工作日誌 DOM
    const wlForm = document.getElementById('worklog-form');
    const wlDate = document.getElementById('wl-date');
    const wlName = document.getElementById('wl-name');
    const wlHours = document.getElementById('wl-hours');
    const wlNote = document.getElementById('wl-note');
    const wlContent = document.getElementById('wl-content');
    const wlMonth = document.getElementById('wl-month');
    const wlFilterName = document.getElementById('wl-filter-name');
    const wlClearFilter = document.getElementById('wl-clear-filter');
    const wlTbody = document.getElementById('wl-tbody');

    // 通聯紀錄 DOM
    const clForm = document.getElementById('call-form');
    const clDT = document.getElementById('cl-dt');
    const clContact = document.getElementById('cl-contact');
    const clType = document.getElementById('cl-type');
    const clExt = document.getElementById('cl-ext');
    const clSummary = document.getElementById('cl-summary');
    const clStatus = document.getElementById('cl-status');
    const clNote = document.getElementById('cl-note');
    const clMonth = document.getElementById('cl-month');
    const clKW = document.getElementById('cl-kw');
    const clClearFilter = document.getElementById('cl-clear-filter');
    const clTbody = document.getElementById('cl-tbody');

    // 新增：工作日誌編輯 Modal 元件
    const wlEditModal = document.getElementById('wl-edit-modal');
    const wlEditForm = document.getElementById('wl-edit-form');
    const wlEditId = document.getElementById('wl-edit-id');
    const wlEditDate = document.getElementById('wl-edit-date');
    const wlEditName = document.getElementById('wl-edit-name');
    const wlEditHours = document.getElementById('wl-edit-hours');
    const wlEditNote = document.getElementById('wl-edit-note');
    const wlEditContent = document.getElementById('wl-edit-content');
    const wlEditCancel = document.getElementById('wl-edit-cancel');

    // 新增：通聯紀錄編輯 Modal 元件
    const clEditModal = document.getElementById('cl-edit-modal');
    const clEditForm = document.getElementById('cl-edit-form');
    const clEditId = document.getElementById('cl-edit-id');
    const clEditDT = document.getElementById('cl-edit-dt');
    const clEditContact = document.getElementById('cl-edit-contact');
    const clEditType = document.getElementById('cl-edit-type');
    const clEditExt = document.getElementById('cl-edit-ext');
    const clEditSummary = document.getElementById('cl-edit-summary');
    const clEditStatus = document.getElementById('cl-edit-status');
    const clEditNote = document.getElementById('cl-edit-note');
    const clEditCancel = document.getElementById('cl-edit-cancel');

    // 工具
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const read = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const load = ()=> read(KEY, []);
    const save = list => write(KEY, list);
    const readBehavior = ()=> read(BEHAVIOR_KEY, {}) || {};
    const writeBehavior = (obj)=> write(BEHAVIOR_KEY, obj);
    const readBehaviorLogs = ()=> read(BEHAVIOR_LOG_KEY, {}) || {};
    const writeBehaviorLogs = (obj)=> write(BEHAVIOR_LOG_KEY, obj);
    const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
    function isNoOrder(v){ const s=(v||'').trim(); return s==='' || s==='無' || s==='无'; }

    // Tabs 切換
    function setupTabs(){
      const buttons = $$('#tabs .tab-btn');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const target = btn.dataset.tabTarget;
          document.querySelectorAll('.tab').forEach(p=> p.classList.remove('active'));
          document.getElementById(target).classList.add('active');
          buttons.forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          if(target==='tab-dashboard'){ render(); }
          if(target==='tab-business'){ render(); }
          if(target==='tab-behavior'){ renderBehaviorOverview(); }
          if(target==='tab-worklog'){ renderWorklog(); }
          if(target==='tab-calllog'){ renderCalllog(); }
        });
      });
    }

    // 初始化
    function ensureInit(){
      const t = read(TASKS_KEY);
      if(!t || typeof t!=='object' || Object.keys(t).length===0) write(TASKS_KEY, DEFAULT_TASKS);
      if(read(THRESHOLD_KEY) == null) write(THRESHOLD_KEY, 80);
      const e = read(EMP_KEY);
      if(!Array.isArray(e) || e.length===0) write(EMP_KEY, DEFAULT_EMPS);
      if(!read(TARGETS_KEY)) write(TARGETS_KEY, {});
      if(!read(BEHAVIOR_KEY)) write(BEHAVIOR_KEY, {});
      if(!read(BEHAVIOR_LOG_KEY)) write(BEHAVIOR_LOG_KEY, {});
      if(!read(WORKLOG_KEY)) write(WORKLOG_KEY, []);
      if(!read(CALLLOG_KEY)) write(CALLLOG_KEY, []);
    }
    ensureInit();

    // 初值
    (function initDefaults(){
      monthEl.value = new Date().toISOString().slice(0,7);
      thresholdEl.value = read(THRESHOLD_KEY, 80);
      pillMonth.textContent = monthEl.value;
      dateEl.valueAsDate = new Date();
      stageEl.value = 'NOT_STARTED';
      bhvMonthInput.value = monthEl.value;
      wlDate.valueAsDate = new Date();
      wlMonth.value = monthEl.value;
      clDT.value = new Date().toISOString().slice(0,16);
      clMonth.value = monthEl.value;
    })();

    // 角色
    function getRole(){ return sessionStorage.getItem(ROLE_KEY) || 'user'; }
    function isAdmin(){ return getRole()==='admin'; }
    function applyRoleGate(){ thresholdEl.disabled = !isAdmin(); }
    function renderRecordsHead(){
      if(!theadRecords) return;
      theadRecords.innerHTML = `
        <tr>
          <th>單號</th><th>日期</th><th>姓名</th><th>任務</th><th>件數</th><th>單件分</th><th>總分</th><th>進度</th><th>備註</th>
          ${isAdmin() ? '<th>操作</th>' : ''}
        </tr>`;
    }
    function setRole(role){
      sessionStorage.setItem(ROLE_KEY, role);
      document.body.setAttribute('data-role', role);
      roleBadge.textContent = '角色：' + (role==='admin'?'管理者':'使用者');
      loginBtn.innerHTML = (role==='admin' ? '🚪 登出' : '🔐 登入');
      applyRoleGate(); renderRecordsHead(); currentPage = 1; render(); renderBehaviorOverview(); renderWorklog(); renderCalllog();
    }

    // 登入 UI
    function openLogin(){
      loginModal.classList.remove('hidden'); loginModal.setAttribute('aria-hidden','false');
      const current = getRole();
      $$('input[name="kpi-role"]').forEach(r=> r.checked = (r.value===current) );
      document.getElementById('kpi-pass-row').style.display = (current==='admin') ? 'block' : 'none';
      if (current==='admin') document.getElementById('kpi-admin-pass').focus();
    }
    function closeLogin(){ loginModal.classList.add('hidden'); loginModal.setAttribute('aria-hidden','true'); document.getElementById('kpi-admin-pass').value=''; }
    $$('input[name="kpi-role"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        document.getElementById('kpi-pass-row').style.display = (r.value==='admin')?'block':'none';
        if(r.value==='admin') document.getElementById('kpi-admin-pass').focus();
      });
    });
    loginBtn.addEventListener('click', ()=>{
      if(isAdmin()){ setRole('user'); return; }
      openLogin();
    });
    document.getElementById('kpi-cancel').addEventListener('click', closeLogin);
    loginModal.addEventListener('click', (e)=>{ if(e.target===loginModal) closeLogin(); });
    modalConfirm.addEventListener('click', ()=>{
      const picked = ($$('input[name="kpi-role"]').find(x=>x.checked)||{}).value || 'user';
      if(picked==='admin' && document.getElementById('kpi-admin-pass').value!=='123'){ alert('管理者密碼錯誤'); return; }
      setRole(picked); closeLogin();
    });

    // 自動得分顯示
    function updateAutoScore(){
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const s = tasks[taskEl.value] || 0;
      const q = Number(qtyEl.value || 0);
      autoScoreEl.value = (s && q) ? (s*q) : '';
    }
    taskEl.addEventListener('change', updateAutoScore);
    qtyEl.addEventListener('input', updateAutoScore);

    // 任務 UI
    let editingTaskKey = null;
    function resetTaskEditState(){
      editingTaskKey = null;
      if(mTaskName) mTaskName.value = '';
      if(mTaskScore) mTaskScore.value = '';
      if(addTaskBtn){ addTaskBtn.textContent = '新增 / 更新任務'; delete addTaskBtn.dataset.mode; }
    }
    function rebuildTaskUI(){
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      taskEl.innerHTML = '<option value="" disabled selected>請選擇</option>' +
        Object.entries(tasks).map(([k,v])=>`<option value="${k}">${k}</option>`).join('');
      const editTaskEl = document.getElementById('edit-task');
      if (editTaskEl){
        editTaskEl.innerHTML = '<option value="" disabled selected>請選擇</option>' +
          Object.entries(tasks).map(([k,v])=>`<option value="${k}">${k}</option>`).join('');
      }
      chips.innerHTML = Object.entries(tasks).map(([k,v])=>`<span class="chip">${k} ${v}</span>`).join('');
      if(tbodyTasks){
        tbodyTasks.innerHTML = Object.entries(tasks).map(([k,v])=>`
          <tr>
            <td>${k}</td><td>${v}</td>
            <td class="actions">
              <button class="btn-edit btn-s" data-edit="${k}" data-admin-action>編輯</button>
              <button class="btn-delete btn-s" data-del="${k}" data-admin-action>刪除</button>
            </td>
          </tr>`).join('');
        tbodyTasks.querySelectorAll('button[data-edit]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('請先登入管理者'); return; }
            const t = read(TASKS_KEY, DEFAULT_TASKS);
            editingTaskKey = b.dataset.edit;
            mTaskName.value = editingTaskKey;
            mTaskScore.value = t[editingTaskKey];
            addTaskBtn.textContent = '更新任務';
            addTaskBtn.dataset.mode = 'edit';
            mTaskName.focus();
          });
        });
        tbodyTasks.querySelectorAll('button[data-del]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('請先登入管理者'); return; }
            const key=b.dataset.del;
            if(!confirm(`確定刪除任務「${key}」？`)) return;
            const t=read(TASKS_KEY, DEFAULT_TASKS);
            delete t[key]; write(TASKS_KEY, t);
            if(editingTaskKey===key) resetTaskEditState();
            rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
          });
        });
      }
    }

    // 合併名單的 datalist
    function rebuildEmpUI(){
      const emps = read(EMP_KEY, DEFAULT_EMPS);
      empList.innerHTML = emps.map(n=>`<option value="${n}">`).join('');
    }

    // 任務新增/更新
    if(addTaskBtn){
      addTaskBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('請先登入管理者'); return; }
        const name = (mTaskName.value||'').trim();
        const score = Number(mTaskScore.value);
        if(!name || !Number.isFinite(score) || score<0){ alert('請輸入有效的任務名稱與分數'); return; }
        const t = read(TASKS_KEY, DEFAULT_TASKS) || {};
        if(addTaskBtn.dataset.mode==='edit' && editingTaskKey){
          if(editingTaskKey!==name && Object.hasOwn(t, editingTaskKey)) {
            delete t[editingTaskKey];
          }
          t[name] = Math.round(score);
          write(TASKS_KEY, t);
          resetTaskEditState();
        }else{
          t[name] = Math.round(score);
          write(TASKS_KEY, t);
        }
        rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
      });
    }

    // 恢復預設任務
    if(resetDefaultsBtn){
      resetDefaultsBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('請先登入管理者'); return; }
        if(confirm('確定恢復為預設任務？現有任務分數將被覆蓋。')){
          write(TASKS_KEY, DEFAULT_TASKS);
          resetTaskEditState(); rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
        }
      });
    }

    // 設定變更
    monthEl.addEventListener('change', ()=>{ pillMonth.textContent = monthEl.value; currentPage=1; render(); renderBehaviorOverview(); renderWorklog(); renderCalllog(); });
    filterNameEl.addEventListener('input', ()=>{ currentPage=1; render(); });
    thresholdEl.addEventListener('input', ()=>{
      if(!isAdmin()){ thresholdEl.value = read(THRESHOLD_KEY, 80); alert('請先登入管理者'); return; }
      write(THRESHOLD_KEY, Number(thresholdEl.value||0)); render();
    });
    onlyUnderEl.addEventListener('change', render);

    // 新增紀錄（業務）
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const orderNo = (orderNoEl.value||'').trim();
      if(!isNoOrder(orderNo)){
        const exists = load().some(r=> (r.orderNo || '').trim() === orderNo);
        if(exists){ alert('此單號已存在，請用「編輯」更新，禁止重複填寫。'); return; }
      }
      const pickedStage = (stageEl.value || 'NOT_STARTED');
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const scorePerItem = tasks[taskEl.value] || 0;
      const qty = Number(qtyEl.value);
      const total = scorePerItem * qty;
      const rec = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        orderNo,
        date: dateEl.value,
        name: nameEl.value.trim(),
        task: taskEl.value,
        qty, scorePerItem, total,
        note: (noteEl.value||'').trim(),
        stage: pickedStage,
        stagePct: (STAGE[pickedStage]?.pct ?? 0)
      };
      const list = load(); list.push(rec); save(list);

      const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(rec.name); write(EMP_KEY, Array.from(set)); rebuildEmpUI(); rebuildTargetsTable();

      form.reset(); dateEl.valueAsDate = new Date(); autoScoreEl.value=''; stageEl.value='NOT_STARTED';
      currentPage=1; render(); alert('已儲存');
    });

    // 刪除紀錄（業務）
    function removeOne(id){
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const rec = load().find(r=>r.id===id);
      const label = rec ? `（單號：${rec.orderNo || '無'}｜姓名：${rec.name || ''}｜日期：${rec.date || ''}）` : '';
      if(!confirm(`確定要刪除這筆業務紀錄嗎？${label}\n此動作無法復原。`)) return;
      save(load().filter(r=>r.id!==id));
      currentPage = Math.min(currentPage, getTotalPages(applyFilters(load())) || 1);
      render();
    }

    // 匯出/清空
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const list = load();
      const header = ['單號','日期','姓名','任務','件數','單件分','總分','進度','進度%','備註'];
      const rows = list.map(r=>[
        r.orderNo,r.date,r.name,r.task,r.qty,r.scorePerItem,r.total,
        STAGE[r.stage]?.label || '', STAGE[r.stage]?.pct ?? '',
        (r.note||'').replace(/\n/g,' ')
      ]);
      const csv = [header,...rows].map(a=>a.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='KPI_Export.csv'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      if(confirm('確定清除所有「業務紀錄」資料？此動作無法復原。')){
        localStorage.removeItem(KEY);
        currentPage=1; render();
      }
    });

    // ===== 行為等級/日誌（原） =====
    function getLevel(ym, name){ const all = readBehavior(); return all?.[ym]?.[name] || 'NORMAL'; }
    function setLevel(ym, name, level){ const all = readBehavior(); all[ym] = all[ym] || {}; all[ym][name] = level; writeBehavior(all); }
    function getLogs(ym, name){ const all = readBehaviorLogs(); return all?.[ym]?.[name] || []; }
    function saveLogs(ym, name, arr){ const all = readBehaviorLogs(); all[ym] = all[ym] || {}; all[ym][name] = arr; writeBehaviorLogs(all); }
    function suggestLevel(ym, name){
      const logs = getLogs(ym, name);
      let negSum = 0, negMajor=0, posCount=0;
      logs.forEach(l=>{
        if(NEG_TYPES.has(l.type)){ const imp = Number(l.impact||0); negSum += imp; if(imp===3) negMajor++; }
        else if(POS_TYPES.has(l.type)){ posCount++; }
      });
      const adjusted = Math.max(0, negSum - Math.min(2, posCount));
      if(posCount>=2 && negSum<=2) return 'EXCELLENT';
      if(adjusted>=5 || negMajor>=2) return 'WARN';
      if(adjusted>=3) return 'IMPROVE';
      return 'NORMAL';
    }
    function levelLabel(k){ return LEVEL[k]?.label || ''; }

    let bhvCtx = { ym:'', name:'' };
    function openBehaviorModal(name){
      if(!isAdmin()) return; // 使用者不開放
      bhvCtx = { ym: monthEl.value, name };
      const { ym } = bhvCtx;
      bhvTitle.textContent = `${name}｜${ym}`;
      bhvDate.valueAsDate = new Date();
      bhvEditingId = null; bhvAdd.textContent = '新增日誌';
      renderBehaviorTable();
      const sugg = suggestLevel(ym, name);
      bhvSuggest.textContent = `系統建議等級：${levelLabel(sugg)}（可按下方「採用系統建議等級」套用；實際採用仍由主管決定）`;
      bhvApplySuggestBtn.disabled = !isAdmin();
      bhvModal.classList.remove('hidden'); bhvModal.setAttribute('aria-hidden','false');
    }
    function closeBehaviorModal(){ bhvModal.classList.add('hidden'); bhvModal.setAttribute('aria-hidden','true'); }

    function renderBehaviorTable(){
      const { ym, name } = bhvCtx;
      const logs = getLogs(ym, name);
      bhvTbody.innerHTML = logs.length ? logs.map(l=>`
        <tr>
          <td>${l.date||''}</td>
          <td>${l.type||''}</td>
          <td>${l.impact||''}</td>
          <td>${(l.order||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(l.sbi||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(l.evidence||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(l.action||'').replace(/</g,'&lt;')}</td>
          <td class="actions" ${isAdmin()?'':'style="display:none"'}>
            <button class="btn-edit btn-s" data-edit="${l.id}">編輯</button>
            <button class="btn-delete btn-s" data-del="${l.id}">刪除</button>
          </td>
        </tr>`).join('') : `<tr><td colspan="8" class="tiny">尚無日誌</td></tr>`;

      if(isAdmin()){
        // 刪除
        bhvTbody.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.del;
            const item = logs.find(x=>x.id===id);
            const label = item ? `（日期：${item.date||''}｜類別：${item.type||''}）` : '';
            if(!confirm(`確定刪除此行為日誌？${label}`)) return;
            const arr = getLogs(ym,name).filter(x=>x.id!==id);
            saveLogs(ym,name,arr);
            if(bhvEditingId===id){ bhvEditingId=null; bhvAdd.textContent='新增日誌'; }
            renderBehaviorTable(); render();
          });
        });
        // 編輯
        bhvTbody.querySelectorAll('button[data-edit]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.edit;
            const item = getLogs(ym,name).find(x=>x.id===id);
            if(!item) return;
            bhvEditingId = id;
            bhvDate.value = item.date || '';
            bhvType.value = item.type || '錯誤';
            bhvImpact.value = String(item.impact || 1);
            bhvOrder.value = item.order || '';
            bhvSBI.value = item.sbi || '';
            bhvEvidence.value = item.evidence || '';
            bhvAction.value = item.action || '';
            bhvAdd.textContent = '儲存修改';
          });
        });
      }
    }

    bhvCancel.addEventListener('click', closeBehaviorModal);
    bhvModal.addEventListener('click', (e)=>{ if(e.target===bhvModal) closeBehaviorModal(); });
    bhvAdd.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const { ym, name } = bhvCtx;
      const item = {
        id: bhvEditingId || ((crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())),
        date: bhvDate.value || new Date().toISOString().slice(0,10),
        type: bhvType.value,
        impact: Number(bhvImpact.value||0),
        order: (bhvOrder.value||'').trim(),
        sbi: (bhvSBI.value||'').trim(),
        evidence: (bhvEvidence.value||'').trim(),
        action: (bhvAction.value||'').trim()
      };
      const arr = getLogs(ym, name);
      if(bhvEditingId){
        const idx = arr.findIndex(x=>x.id===bhvEditingId);
        if(idx>=0) arr[idx] = item;
        bhvEditingId = null;
        bhvAdd.textContent = '新增日誌';
      }else{
        arr.push(item);
      }
      saveLogs(ym, name, arr);
      bhvOrder.value=''; bhvSBI.value=''; bhvEvidence.value=''; bhvAction.value='';
      renderBehaviorTable(); render(); renderBehaviorOverview();
    });
    bhvApplySuggestBtn.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const { ym, name } = bhvCtx;
      const sugg = suggestLevel(ym, name);
      setLevel(ym, name, sugg);
      render();
      alert(`已套用系統建議：${levelLabel(sugg)}`);
    });

    // 行為總覽分頁：渲染
    function renderBehaviorOverview(){
      const ym = bhvMonthInput.value || monthEl.value;
      const name = (bhvNameFilter.value||'').trim();
      const all = readBehaviorLogs();
      const ymObj = all?.[ym] || {};
      const rows = [];
      if(name){
        const arr = ymObj?.[name] || [];
        arr.forEach(l=> rows.push({name, ...l}));
      }else{
        Object.entries(ymObj).forEach(([nm, arr])=>{
          (arr||[]).forEach(l=> rows.push({name:nm, ...l}));
        });
      }
      rows.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
      bhvOverviewTbody.innerHTML = rows.length
        ? rows.map(l=> `<tr><td>${l.date||''}</td><td>${l.name}</td><td>${l.type||''}</td><td>${l.impact||''}</td><td>${(l.order||'').replace(/</g,'&lt;')}</td><td style="text-align:left;">${(l.sbi||'').replace(/</g,'&lt;')}</td></tr>`).join('')
        : `<tr><td colspan="6" class="tiny">本月尚無符合資料</td></tr>`;
    }
    bhvMonthInput.addEventListener('change', renderBehaviorOverview);
    bhvNameFilter.addEventListener('input', renderBehaviorOverview);
    bhvOpenModalBtn.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const n = (bhvNameFilter.value||'').trim();
      if(!n){ alert('請先選擇姓名'); return; }
      bhvCtx = { ym: bhvMonthInput.value || monthEl.value, name: n };
      openBehaviorModal(n);
    });

    // 篩選（業務明細）
    function applyFilters(list){
      let out = list.slice();
      const ym = monthEl.value;
      if(ym){ out = out.filter(r=> (r.date||'').startsWith(ym)); }
      const kw = (filterNameEl.value||'').trim();
      if(kw){ out = out.filter(r=> r.name.includes(kw)); }
      return out;
    }

    // 分頁（業務明細）
    function getTotalPages(list){ return Math.max(1, Math.ceil(list.length / PAGE_SIZE)); }
    function updatePager(totalPages){
      pageInfoEl.textContent = `第 ${totalPages ? currentPage : 1} / ${totalPages} 頁`;
      prevPageBtn.disabled = (currentPage <= 1);
      nextPageBtn.disabled = (currentPage >= totalPages);
    }
    prevPageBtn.addEventListener('click', ()=>{ if(currentPage > 1){ currentPage--; render(); } });
    nextPageBtn.addEventListener('click', ()=>{
      const totalPages = getTotalPages(applyFilters(load()));
      if(currentPage < totalPages){ currentPage++; render(); }
    });

    // 圖表
    let chartByPerson, chartByTask;
    function drawCharts(list){
      const byPerson={}, byTask={};
      list.forEach(r=>{ byPerson[r.name]=(byPerson[r.name]||0)+r.total; byTask[r.task]=(byTask[r.task]||0)+r.total; });
      const ctx1=document.getElementById('chartByPerson');
      const ctx2=document.getElementById('chartByTask');
      if(chartByPerson) chartByPerson.destroy();
      if(chartByTask) chartByTask.destroy();
      chartByPerson = new Chart(ctx1,{
        type:'bar',
        data:{labels:Object.keys(byPerson),datasets:[{label:'總分',data:Object.values(byPerson)}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false},title:{display:true,text:'各人總分'}}}
      });
      chartByTask = new Chart(ctx2,{
        type:'pie',
        data:{labels:Object.keys(byTask),datasets:[{data:Object.values(byTask)}]},
        options:{responsive:true,plugins:{title:{display:true,text:'任務分數分布'}}}
      });
    }

    // 目標/名單
    const loadTargets = () => read(TARGETS_KEY, {}) || {};
    const saveTargets = (obj) => write(TARGETS_KEY, obj);

    function rebuildTargetsTable(){
      const targets = loadTargets();
      const emps = new Set(read(EMP_KEY, DEFAULT_EMPS));
      Object.keys(targets).forEach(n=> emps.add(n));

      const rows = Array.from(emps).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
      if(!tbodyTargets) return;
      tbodyTargets.innerHTML = rows.length
        ? rows.map(n=>{
            const obj = targets[n] || {};
            const hasTarget = obj.points != null && Number.isFinite(obj.points);
            return `
              <tr>
                <td>${n}</td>
                <td>${hasTarget ? obj.points : ''}</td>
                <td style="text-align:left">${(obj.note||'').replace(/</g,'&lt;')}</td>
                <td class="actions">
                  <button class="btn-edit btn-s" data-fill="${n}">帶入</button>
                  ${hasTarget ? `<button class="btn-delete btn-s" data-del-target="${n}" data-admin-action>刪目標</button>` : ``}
                  <button class="btn-delete btn-s" data-del-emp="${n}" data-admin-action>刪員工</button>
                </td>
              </tr>`;
          }).join('')
        : `<tr><td colspan="4" class="tiny">名單尚無員工</td></tr>`;

      tbodyTargets.querySelectorAll('button[data-fill]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const n=b.dataset.fill;
          const t = loadTargets()[n] || {};
          tName.value = n;
          tPoints.value = t.points ?? '';
          tNote.value = t.note || '';
          tName.focus();
        });
      });
      tbodyTargets.querySelectorAll('button[data-del-target]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!isAdmin()){ alert('請先登入管理者'); return; }
          const n=b.dataset.delTarget;
          if(!confirm(`確定刪除 ${n} 的目標設定？`)) return;
          const all = loadTargets();
          if(all[n]){
            delete all[n];
            saveTargets(all);
            rebuildTargetsTable();
            render();
          }
        });
      });
      tbodyTargets.querySelectorAll('button[data-del-emp]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!isAdmin()){ alert('請先登入管理者'); return; }
          const n=b.dataset.delEmp;
          if(!confirm(`確定刪除員工 ${n}？（同時會刪除其目標設定；既有紀錄不受影響）`)) return;
          let list=read(EMP_KEY, DEFAULT_EMPS).filter(x=>x!==n);
          write(EMP_KEY, list);
          const all = loadTargets(); if(all[n]){ delete all[n]; saveTargets(all); }
          rebuildEmpUI(); rebuildTargetsTable(); render();
        });
      });
    }

    // KPI 標籤
    function statusTag(score, th){
      if(score >= th*1.333) return '<span class="tag ok">優秀</span>';
      if(score >= th) return '<span class="tag warn">達標</span>';
      return '<span class="tag bad">未達標</span>';
    }

    // 編輯紀錄（業務）
    function openEditModal(rec){
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      editId.value = rec.id;
      editOrderNo.value = rec.orderNo || '';
      editDate.value = rec.date || '';
      editName.value = rec.name || '';
      editTask.value = rec.task || '';
      editQty.value = rec.qty || 1;
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const spi = Number.isFinite(tasks[rec.task]) ? tasks[rec.task] : (rec.scorePerItem||0);
      editScorePerItem.value = spi;
      editNote.value = rec.note || '';
      editStage.value = rec.stage || 'NOT_STARTED';
      editModal.classList.remove('hidden'); editModal.setAttribute('aria-hidden','false');
    }
    function closeEditModal(){ editModal.classList.add('hidden'); editModal.setAttribute('aria-hidden','true'); }
    document.getElementById('edit-task').addEventListener('change', ()=>{
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      editScorePerItem.value = tasks[document.getElementById('edit-task').value] || 0;
    });
    editCancel.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeEditModal(); });
    editForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const id = editId.value;
      let list = load();
      const idx = list.findIndex(r=>r.id===id);
      if(idx<0){ alert('找不到該筆紀錄'); closeEditModal(); return; }
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const newTask = document.getElementById('edit-task').value;
      const newQty = Number(editQty.value)||0;
      const newScorePerItem = Number.isFinite(tasks[newTask]) ? tasks[newTask] : (list[idx].scorePerItem||0);
      const newTotal = newScorePerItem * newQty;

      const newOrder = (editOrderNo.value||'').trim();
      if(!isNoOrder(newOrder) && newOrder !== list[idx].orderNo){
        const dup = list.some((r,i)=> i!==idx && (r.orderNo||'').trim()===newOrder);
        if(dup){ alert('此單號已存在，請使用其他單號'); return; }
      }

      const newStageKey = editStage.value || 'NOT_STARTED';
      list[idx] = { ...list[idx],
        orderNo: newOrder, date: editDate.value, name: (editName.value||'').trim(),
        task: newTask, qty: newQty, scorePerItem: newScorePerItem, total: newTotal,
        note: (editNote.value||'').trim(), stage: newStageKey, stagePct: STAGE[newStageKey]?.pct ?? 0
      };
      save(list);

      const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(list[idx].name); write(EMP_KEY, Array.from(set)); rebuildEmpUI(); rebuildTargetsTable();
      closeEditModal(); render(); alert('已更新');
    });

    // 渲染（總覽/業務）
    function render(){
      const admin = isAdmin();
      let list = load();

      // 兼容舊資料：補 stage
      let patched = false;
      list.forEach(r=>{ if(!r.stage){ r.stage = 'NOT_STARTED'; r.stagePct = 0; patched = true; } });
      if(patched) save(list);

      const filtered = applyFilters(list);
      const totalPages = getTotalPages(filtered);
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageList = filtered.slice(start, end);

      // 明細表（業務紀錄分頁）
      tbody.innerHTML = pageList.map(r=>{
        const stageKey = r.stage || 'NOT_STARTED';
        const stageText = (STAGE[stageKey]?.label || '');
        const stagePct = (STAGE[stageKey]?.pct ?? 0);
        return `
        <tr data-stage="${stageKey}">
          <td>${r.orderNo||''}</td><td>${r.date||''}</td><td>${r.name||''}</td><td>${r.task||''}</td>
          <td>${r.qty||''}</td><td>${r.scorePerItem||''}</td><td>${r.total||''}</td>
          <td>${stageText}（${stagePct}%）</td><td>${(r.note||'').replace(/</g,'&lt;')}</td>
          ${admin ? `<td class="actions"><button class="btn-edit btn-s" data-edit-id="${r.id}" data-admin-action>編輯</button><button class="btn-delete btn-s" data-id="${r.id}" data-admin-action>刪除</button></td>` : ``}
        </tr>`;
      }).join('') || `<tr><td colspan="${admin?10:9}" class="tiny">本月尚無資料</td></tr>`;

      if (admin){
        tbody.querySelectorAll('button[data-id]').forEach(btn=> btn.addEventListener('click', ()=> removeOne(btn.dataset.id)));
        tbody.querySelectorAll('button[data-edit-id]').forEach(btn=> btn.addEventListener('click', ()=>{
          const id = btn.dataset.editId;
          const rec = load().find(x=>x.id===id);
          if(rec) openEditModal(rec);
        }));
      }

      // 當頁合計
      const totals = pageList.reduce((acc, r) => { acc.qty += Number(r.qty)||0; acc.score += Number(r.total)||0; return acc; }, {qty:0, score:0});
      if(pageList.length){
        tfoot.innerHTML = admin
          ? `<tr><td colspan="4" style="text-align:right;">當頁合計</td><td>${totals.qty}</td><td></td><td>${totals.score}</td><td></td><td></td><td></td></tr>`
          : `<tr><td colspan="4" style="text-align:right;">當頁合計</td><td>${totals.qty}</td><td></td><td>${totals.score}</td><td></td><td></td></tr>`;
      }else tfoot.innerHTML = '';

      // 分頁資訊
      updatePager(totalPages);

      // 圖表（總覽）
      drawCharts(filtered);

      // 每月總表（正規化 + 行為調整）
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const sumTask = Object.values(tasks).reduce((a,b)=>a+b,0);

      const normSumByName = {};
      if(sumTask > 0){
        filtered.forEach(r=>{
          const unitNorm = (r.scorePerItem || 0) / sumTask * 100;
          const add = unitNorm * (Number(r.qty)||0);
          normSumByName[r.name] = (normSumByName[r.name]||0) + add;
        });
      }else{
        filtered.forEach(r=>{ normSumByName[r.name] = 0; });
      }

      const allNames = new Set(read(EMP_KEY, DEFAULT_EMPS));
      Object.keys(normSumByName).forEach(n=> allNames.add(n));

      const targets = read(TARGETS_KEY, {}) || {};
      function personTargetPercent(name){
        if(sumTask <= 0) return 100;
        const targetPoints = targets[name]?.points;
        if(targetPoints == null || !Number.isFinite(targetPoints)) return 100;
        return Math.max(0, (targetPoints / sumTask) * 100);
      }

      const th = read(THRESHOLD_KEY, 80);
      const ym = monthEl.value;

      let rows = Array.from(allNames).map(n=>{
        const normTotal = normSumByName[n] || 0;
        const targetPct = personTargetPercent(n) || 1;
        const kpiPct = Math.min(100, Math.round(normTotal / targetPct * 100));
        const lv = getLevel(ym, n);
        const adj = LEVEL[lv]?.adjust ?? 0;
        const finalPct = clamp(Math.round(kpiPct * (1 + adj)), 0, 200);
        const tag = statusTag(finalPct, th);
        const isUnder = finalPct < th;
        return { n, base: kpiPct, lv, finalPct, tag, isUnder };
      });

      if (onlyUnderEl.checked) rows = rows.filter(r=> r.isUnder);
      rows.sort((a,b)=> b.finalPct - a.finalPct);
      tbodyUnder.innerHTML = rows.length
        ? rows.map(r=>{
            const lvOpt = Object.entries(LEVEL).map(([k,v])=>`<option value="${k}" ${r.lv===k?'selected':''}>${v.label}</option>`).join('');
            return `<tr>
              <td>${r.n}</td>
              <td>${r.base}%</td>
              <td>
                <select class="bhv-level" data-name="${r.n}" ${isAdmin()?'':'disabled'} style="padding:6px 8px;border:1px solid var(--border);border-radius:8px;">
                  ${lvOpt}
                </select>
              </td>
              <td>${r.finalPct}%</td>
              <td>${r.tag}</td>
              <td class="col-log"><button class="btn-outline btn-s" data-bhv="${r.n}" ${isAdmin()?'':'disabled'}>📎 日誌</button></td>
            </tr>`;
          }).join('')
        : `<tr><td colspan="6" class="tiny">${onlyUnderEl.checked ? '當月無未達標人員' : '本月尚無資料'}</td></tr>`;

      // 綁定等級切換 & 日誌
      tbodyUnder.querySelectorAll('select.bhv-level').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          if(!isAdmin()){ alert('請先登入管理者'); sel.value = getLevel(ym, sel.dataset.name); return; }
          setLevel(ym, sel.dataset.name, sel.value); render();
        });
      });
      tbodyUnder.querySelectorAll('button[data-bhv]').forEach(btn=> btn.addEventListener('click', ()=> openBehaviorModal(btn.dataset.bhv)));
    }

    // ===== 工作日誌 =====
    function readWorklog(){ return read(WORKLOG_KEY, []); }
    function writeWorklog(list){ write(WORKLOG_KEY, list); }
    wlForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const item = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        date: wlDate.value,
        name: (wlName.value||'').trim(),
        hours: Number(wlHours.value||0),
        content: (wlContent.value||'').trim(),
        note: (wlNote.value||'').trim()
      };
      const list = readWorklog(); list.push(item); writeWorklog(list);
      wlForm.reset(); wlDate.valueAsDate = new Date();
      renderWorklog(); alert('已新增工作日誌');
    });

    function openWLEdit(item){
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      wlEditId.value = item.id;
      wlEditDate.value = item.date || '';
      wlEditName.value = item.name || '';
      wlEditHours.value = Number(item.hours||0);
      wlEditNote.value = item.note || '';
      wlEditContent.value = item.content || '';
      wlEditModal.classList.remove('hidden'); wlEditModal.setAttribute('aria-hidden','false');
    }
    function closeWLEdit(){ wlEditModal.classList.add('hidden'); wlEditModal.setAttribute('aria-hidden','true'); }
    wlEditCancel.addEventListener('click', closeWLEdit);
    wlEditModal.addEventListener('click', (e)=>{ if(e.target===wlEditModal) closeWLEdit(); });
    wlEditForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const id = wlEditId.value;
      const list = readWorklog();
      const idx = list.findIndex(x=>x.id===id);
      if(idx<0){ alert('找不到該筆工作日誌'); closeWLEdit(); return; }
      list[idx] = {
        ...list[idx],
        date: wlEditDate.value,
        name: (wlEditName.value||'').trim(),
        hours: Number(wlEditHours.value||0),
        note: (wlEditNote.value||'').trim(),
        content: (wlEditContent.value||'').trim()
      };
      writeWorklog(list);
      closeWLEdit(); renderWorklog(); alert('已更新工作日誌');
    });

    function renderWorklog(){
      const ym = wlMonth.value;
      const nm = (wlFilterName.value||'').trim();
      const list = readWorklog().filter(x=>{
        const okMonth = ym ? (x.date||'').startsWith(ym) : true;
        const okName = nm ? (x.name||'').includes(nm) : true;
        return okMonth && okName;
      }).sort((a,b)=> String(a.date).localeCompare(String(b.date)));
      const admin = isAdmin();
      wlTbody.innerHTML = list.length ? list.map(x=>`
        <tr>
          <td>${x.date||''}</td>
          <td>${x.name||''}</td>
          <td>${Number(x.hours||0)}</td>
          <td style="text-align:left;">${(x.content||'').replace(/</g,'&lt;')}</td>
          <td style="text-align:left;">${(x.note||'').replace(/</g,'&lt;')}</td>
          <td class="actions">
            ${admin ? `<button class="btn-edit btn-s" data-wl-edit="${x.id}">編輯</button>` : ``}
            ${admin ? `<button class="btn-delete btn-s" data-wl-del="${x.id}">刪除</button>` : ``}
          </td>
        </tr>
      `).join('') : `<tr><td colspan="6" class="tiny">尚無資料</td></tr>`;
      // 綁事件
      if (admin){
        wlTbody.querySelectorAll('button[data-wl-edit]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.wlEdit;
            const item = readWorklog().find(x=> x.id===id);
            if(item) openWLEdit(item);
          });
        });
        wlTbody.querySelectorAll('button[data-wl-del]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.wlDel;
            const item = readWorklog().find(x=>x.id===id);
            const label = item ? `（${item.date||''}｜${item.name||''}｜${(item.content||'').slice(0,20)}…）` : '';
            if(!confirm(`確定刪除此工作日誌？${label}`)) return;
            const list2 = readWorklog().filter(x=> x.id!==id);
            writeWorklog(list2);
            renderWorklog();
          });
        });
      }
    }
    wlMonth.addEventListener('change', renderWorklog);
    wlFilterName.addEventListener('input', renderWorklog);
    wlClearFilter.addEventListener('click', ()=>{
      wlMonth.value = monthEl.value; wlFilterName.value=''; renderWorklog();
    });

    // ===== 通聯紀錄 =====
    function readCalllog(){ return read(CALLLOG_KEY, []); }
    function writeCalllog(list){ writeCalllog._re = (writeCalllog._re||0); localStorage.setItem(CALLLOG_KEY, JSON.stringify(list)); } // 保留
    // 改寫為與其他一致
    function _writeCalllog(list){ localStorage.setItem(CALLLOG_KEY, JSON.stringify(list)); }

    clForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const item = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        dt: clDT.value,
        contact: (clContact.value||'').trim(),
        type: clType.value,
        ext: (clExt.value||'').trim(),
        summary: (clSummary.value||'').trim(),
        status: clStatus.value,
        note: (clNote.value||'').trim()
      };
      const list = readCalllog(); list.push(item); _writeCalllog(list);
      clForm.reset(); clDT.value = new Date().toISOString().slice(0,16);
      renderCalllog(); alert('已新增通聯');
    });

    function openCLEdit(item){
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      clEditId.value = item.id;
      clEditDT.value = item.dt || '';
      clEditContact.value = item.contact || '';
      clEditType.value = item.type || '來電';
      clEditExt.value = item.ext || '';
      clEditSummary.value = item.summary || '';
      clEditStatus.value = item.status || '未處理';
      clEditNote.value = item.note || '';
      clEditModal.classList.remove('hidden'); clEditModal.setAttribute('aria-hidden','false');
    }
    function closeCLEdit(){ clEditModal.classList.add('hidden'); clEditModal.setAttribute('aria-hidden','true'); }
    clEditCancel.addEventListener('click', closeCLEdit);
    clEditModal.addEventListener('click', (e)=>{ if(e.target===clEditModal) closeCLEdit(); });
    clEditForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('請先登入管理者'); return; }
      const id = clEditId.value;
      const list = readCalllog();
      const idx = list.findIndex(x=>x.id===id);
      if(idx<0){ alert('找不到該筆通聯紀錄'); closeCLEdit(); return; }
      list[idx] = {
        ...list[idx],
        dt: clEditDT.value,
        contact: (clEditContact.value||'').trim(),
        type: clEditType.value,
        ext: (clEditExt.value||'').trim(),
        summary: (clEditSummary.value||'').trim(),
        status: clEditStatus.value,
        note: (clEditNote.value||'').trim()
      };
      _writeCalllog(list);
      closeCLEdit(); renderCalllog(); alert('已更新通聯紀錄');
    });

    function renderCalllog(){
      const ym = clMonth.value;
      const kw = (clKW.value||'').trim();
      const list = readCalllog().filter(x=>{
        const okMonth = ym ? (x.dt||'').slice(0,7)===ym : true;
        const hay = `${x.contact} ${x.summary} ${x.note}`.toLowerCase();
        const okKW = kw ? hay.includes(kw.toLowerCase()) : true;
        return okMonth && okKW;
      }).sort((a,b)=> String(a.dt).localeCompare(String(b.dt)));
      const admin = isAdmin();
      clTbody.innerHTML = list.length ? list.map(x=>`
        <tr>
          <td>${x.dt?.replace('T',' ')||''}</td>
          <td>${(x.contact||'').replace(/</g,'&lt;')}</td>
          <td>${x.type||''}</td>
          <td>${(x.ext||'')}</td>
          <td>${(x.summary||'').replace(/</g,'&lt;')}</td>
          <td>${x.status||''}</td>
          <td style="text-align:left;">${(x.note||'').replace(/</g,'&lt;')}</td>
          <td class="actions">
            ${admin ? `<button class="btn-edit btn-s" data-cl-edit="${x.id}">編輯</button>` : ``}
            ${admin ? `<button class="btn-delete btn-s" data-cl-del="${x.id}">刪除</button>` : ``}
          </td>
        </tr>
      `).join('') : `<tr><td colspan="8" class="tiny">尚無資料</td></tr>`;
      if (admin){
        clTbody.querySelectorAll('button[data-cl-edit]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.clEdit;
            const item = readCalllog().find(x=> x.id===id);
            if(item) openCLEdit(item);
          });
        });
        clTbody.querySelectorAll('button[data-cl-del]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.clDel;
            const item = readCalllog().find(x=>x.id===id);
            const label = item ? `（${(item.dt||'').replace('T',' ')}｜${item.contact||''}｜${(item.summary||'').slice(0,20)}…）` : '';
            if(!confirm(`確定刪除此通聯紀錄？${label}`)) return;
            const list2 = readCalllog().filter(x=> x.id!==id);
            _writeCalllog(list2);
            renderCalllog();
          });
        });
      }
    }
    clMonth.addEventListener('change', renderCalllog);
    clKW.addEventListener('input', renderCalllog);
    clClearFilter.addEventListener('click', ()=>{
      clMonth.value = monthEl.value; clKW.value=''; renderCalllog();
    });

    // 事件：總覽控制
    document.getElementById('kpi-cancel')?.addEventListener('click', ()=> {
      document.getElementById('kpi-login-modal').classList.add('hidden');
    });

    // 啟動
    function boot(){
      setupTabs();
      setRole(getRole());
      rebuildTaskUI(); rebuildEmpUI(); rebuildTargetsTable();
      updateAutoScore();
      renderBehaviorOverview(); renderWorklog(); renderCalllog();
    }
    boot();
  </script>
</body>
</html>
