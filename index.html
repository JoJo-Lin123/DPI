<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI å¡«å ±èˆ‡è¦–è¦ºåŒ–ç¸½è¡¨ï¼ˆæœ¬æ©Ÿç‰ˆï¼‰</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #1e88e5;      /* ä½¿ç”¨è€…ä¸»è‰²ï¼ˆè—ï¼‰ */
      --primary-600: #1565c0;
      --border: #e5e7eb;

      /* æç¤ºè‰²ï¼ˆæŸ”å’Œï¼‰ */
      --row-amber: #fffbeb;    /* æœªé–‹å§‹ï¼ˆç›®å‰æœªä¸Šè‰²ç”¨ï¼‰ */
      --row-blue:  #e8f4fd;    /* é€²è¡Œä¸­ */
      --row-green: #e6f4ea;    /* å·²å®Œæˆï¼ˆæ¸…æ–°ï¼‰ */

      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;

      --chip: #e3f2fd;
      --banner-bg: linear-gradient(90deg,#e0f2fe, #f0f9ff);
      --banner-fg: #075985;
    }
    /* ç®¡ç†è€…ä¸»é¡Œï¼šè—ç´«è‰²ç³»ï¼ˆè¼ƒæ·¡ï¼‰ */
    body[data-role="admin"]{
      --primary:#818cf8;       /* indigo-400 */
      --primary-600:#6366f1;   /* indigo-500 */
      --bg:#eef2ff;            /* indigo-50 */
      --banner-bg: linear-gradient(90deg,#e0e7ff,#f3e8ff);
      --banner-fg:#3730a3;     /* indigo-800 */
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); line-height: 1.6; transition: background .25s ease; }
    .wrap { max-width: 1220px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    h1 { font-size: 24px; margin: 0; color: var(--primary); transition: color .25s ease; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    /* ===== æŒ‰éˆ•ç³»çµ±ï¼ˆç„¡é™°å½±ã€ç„¡å¤–æ¡†ï¼›ä»¥æŸ”å’Œé‚Šç·š/å–®è‰²ç‚ºä¸»ï¼‰ ===== */
    .btn,
    .btn-secondary,
    .btn-ghost,
    .btn-outline,
    .btn-danger,
    .btn-login{
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      border:1px solid transparent;
      cursor:pointer;
      outline:none;
      box-shadow:none;
      transition: background .2s ease, color .2s ease, transform .05s ease, opacity .2s ease, filter .2s ease, border-color .2s ease;
    }
    .btn:focus,.btn-secondary:focus,.btn-ghost:focus,.btn-outline:focus,.btn-danger:focus,.btn-login:focus,
    .btn:focus-visible,.btn-secondary:focus-visible,.btn-ghost:focus-visible,.btn-outline:focus-visible,.btn-danger:focus-visible,.btn-login:focus-visible{ outline:none; box-shadow:none; }

    .btn { background: var(--primary); color:#fff; }
    .btn:hover{ background: var(--primary-600); }
    .btn:active{ transform: translateY(1px); }

    .btn-secondary{ background:#eef2ff; color:#4f46e5; }
    .btn-secondary:hover{ filter: brightness(.96); }

    .btn-ghost{ background:#ffffff; color:#374151; border:1px solid var(--border); }
    .btn-ghost:hover{ filter: brightness(.98); }

    .btn-outline{
      background:#fff; color:#4f46e5;
      border:1px solid #c7d2fe;
    }
    .btn-outline:hover{ border-color:#a78bfa; }

    .btn-danger{ background: #ef5350; color:#fff; }
    .btn-danger:hover{ background:#d32f2f; }

    .btn-login{
      border-radius:999px;
      padding:8px 14px;
      font-weight:800;
      background:
        linear-gradient(#fff,#fff) padding-box,
        linear-gradient(90deg,#93c5fd,#c4b5fd) border-box;
      color:#334155;
      border:1px solid transparent;
    }
    .btn-login:hover{ filter: brightness(.98); }
    .btn-login:active{ transform: translateY(0); }
    body[data-role="admin"] .btn-login{
      background: linear-gradient(90deg,#818cf8,#a78bfa); color:#fff;
    }

    /* è¡¨æ ¼å…§å°æŒ‰éˆ•ï¼ˆèˆ‡ btn-outline åŒé¢¨æ ¼ï¼›ç„¡é™°å½±ï¼‰ */
    .btn-s{ height:32px; padding:0 10px; font-size:12px; border-radius:10px; border:1px solid transparent; outline:none; box-shadow:none; }
    .btn-edit{
      background:#fff; color: var(--primary);
      border:1px solid #c7d2fe;      /* æ·¡è—é‚Šç·š */
    }
    .btn-edit:hover{
      color: var(--primary-600);
      border-color:#a78bfa;
      background:#fff;
    }
    .btn-delete{
      background:#fff; color:#c2185b;  /* æ¸…æ–°è“ç²‰ */
      border:1px solid #f8bbd0;       /* æ·¡ç²‰é‚Šç·š */
    }
    .btn-delete:hover{
      color:#ad1457;
      border-color:#f48fb1;
      background:#fff;
    }

    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 1080px){ .grid-3 { grid-template-columns: 1.1fr 1fr 1fr; } .grid-2 { grid-template-columns: 1.1fr 1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; }
    .card h2 { margin: 0 0 12px; font-size:18px; color:#111827; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:#fff; }
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 720px){ .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 1fr 1fr 1fr; } }
    .hint { color: var(--muted); font-size: 13px; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .chip { background:var(--chip); color:#0f4c81; border-radius:999px; padding:4px 10px; font-size:12px; border:1px solid #bbdefb; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom: 1px solid var(--border); text-align:center; }
    thead th { background:#f8fafc; font-size:13px; color:#374151; font-weight:600; }
    tbody td { font-size:14px; font-weight:400; } /* æ˜ç´°ï¼šå­—ç´šè¼ƒå¤§ã€ä¸åŠ ç²— */
    tbody tr:not([data-stage]):hover { background:#f9fafb; }
    tfoot td { background:#f8fafc; font-weight:700; }

    .tag { padding:4px 8px; border-radius:8px; font-weight:600; font-size:12px; }
    .tag.ok{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .tag.warn{ background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .tag.bad{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    .actions { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .tiny { font-size:12px; color:var(--muted); }
    .footer { margin-top:16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .input-inline { display:flex; gap:8px; align-items:center; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#f3f4f6; border:1px solid var(--border); border-radius:999px; }
    .switch { display:inline-flex; align-items:center; gap:8px; user-select:none; }
    .switch label{ font-size:14px; font-weight:500; white-space:nowrap; }

    .scroll-area{
      max-height: 320px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .scroll-area table{ margin: 0; border-collapse: separate; border-spacing: 0; }
    .scroll-area thead th{
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f8fafc;
      box-shadow: 0 1px 0 var(--border);
    }

    #chips { display: none; }

    /* ===== è§’è‰²é¡¯ç¤º/æ¬Šé™ ===== */
    body[data-role="user"] [data-admin-action] { display: none !important; }
    body[data-role="user"] button[data-id] { display:none !important; }
    body[data-role="user"] #threshold { opacity:.6; pointer-events:none; }
    body[data-role="user"] [data-admin-section] { display:none !important; }

    .login-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid var(--primary); color:var(--primary-600); border-radius:999px; transition: all .25s ease; }
    body[data-role="admin"] .login-pill{ background:linear-gradient(90deg,#e0e7ff,#f3e8ff); color:#3730a3; border-color:#a78bfa; }

    .role-banner { display:none; position:sticky; top:0; z-index:50; padding:8px 16px; text-align:center; font-weight:800; letter-spacing:.5px; background: var(--banner-bg); color: var(--banner-fg); border-bottom:1px solid var(--border); }
    body[data-role="admin"] .role-banner{ display:block; }

    /* ===== Modal ===== */
    .kpi-modal.hidden { display:none; }
    .kpi-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; padding:16px; }
    .kpi-modal .panel { background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; width:min(520px,92vw); }
    .kpi-modal h3{ margin:0 0 14px; font-size:20px; color:#111827; }
    .kpi-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .seg { display:flex; gap:6px; background:#f3f4f6; padding:6px; border-radius:12px; }
    .seg label{ flex:1; position:relative; }
    .seg input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .seg .opt{ display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; border-radius:10px; font-weight:800; color:#374151; border:1px solid transparent; transition: all .15s; }
    .seg input:checked + .opt{ background:#fff; border-color:var(--primary); color:var(--primary-600); }

    /* ===== ç´€éŒ„æ˜ç´°ï¼šä¾é€²åº¦æ•´åˆ—ä¸Šè‰²ï¼ˆæŸ”å’Œ & ä¸åŠ ç²—ï¼‰ ===== */
    tbody tr[data-stage="NOT_STARTED"] { background-color: transparent; color: inherit; }
    tbody tr[data-stage="IN_PROGRESS"] { background-color: var(--row-blue);  color: #1565c0; font-weight: 400; }
    tbody tr[data-stage="DONE"]        { background-color: var(--row-green); color: #2e7d32; font-weight: 400; }
    tbody tr[data-stage]:hover { filter: brightness(0.985); }

    /* ===== åœ“é¤…åœ–ç¸®å°ç´„ 85% ===== */
    #chartByTask{ display:block; margin:0 auto; transform: scale(0.85); transform-origin: top center; }
  </style>
</head>
<body>
  <div class="role-banner">ç›®å‰ç‚ºã€Œç®¡ç†è€…æ¨¡å¼ã€</div>

  <div class="wrap">
    <header>
      <h1>KPI å¡«å ±èˆ‡è¦–è¦ºåŒ–ç¸½è¡¨</h1>
      <div class="toolbar">
        <span id="roleBadge" class="login-pill">è§’è‰²ï¼šä½¿ç”¨è€…</span>
        <button class="btn-login" id="loginBtn">ğŸ” ç™»å…¥</button>
        <button class="btn" id="exportCsv" data-admin-action>åŒ¯å‡º CSV</button>
        <button class="btn-danger" id="clearAll" data-admin-action>æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
      </div>
    </header>

    <!-- æ–°å¢ç´€éŒ„ -->
    <section class="card" style="margin-bottom:16px;">
      <h2>æ–°å¢ç´€éŒ„</h2>
      <form id="form">
        <div class="row row-2">
          <div>
            <label>å–®è™Ÿ</label>
            <input type="text" id="orderNo" required placeholder="è«‹è¼¸å…¥å–®è™Ÿ" />
          </div>
          <div>
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" required />
          </div>
        </div>

        <div class="row row-2">
          <div>
            <label>å§“å</label>
            <input type="text" id="name" list="empList" placeholder="ä¾‹å¦‚ï¼šå“¡å·¥A" required />
            <datalist id="empList"></datalist>
          </div>
          <div>
            <label>ä»»å‹™é¡å‹</label>
            <select id="task" required></select>
            <div id="chips" class="chips"></div>
          </div>
        </div>

        <div class="row row-3">
          <div>
            <label>ä»¶æ•¸</label>
            <input type="number" id="qty" min="1" value="1" required />
          </div>
          <div>
            <label>è‡ªå‹•å¾—åˆ†</label>
            <input type="text" id="autoScore" readonly placeholder="ç³»çµ±è¨ˆç®—" />
          </div>
          <div>
            <label>å‚™è¨»</label>
            <input type="text" id="note" placeholder="å¯ç•™ç©º" />
          </div>
        </div>

        <!-- é€²åº¦ä¸‰éšæ®µï¼ˆå…è¨±ä»»æ„é¸æ“‡ï¼‰ -->
        <div class="row row-2">
          <div>
            <label>é€²åº¦</label>
            <select id="stage" required>
              <option value="NOT_STARTED">æœªé–‹å§‹ï¼ˆ0%ï¼‰</option>
              <option value="IN_PROGRESS">é€²è¡Œä¸­ï¼ˆ50%ï¼‰</option>
              <option value="DONE">å·²å®Œæˆï¼ˆ100%ï¼‰</option>
            </select>
            <div class="tiny">å¯ç›´æ¥é¸æ“‡ä»»ä½•éšæ®µï¼ˆä¾‹å¦‚äº‹å¾Œä¸€æ¬¡å¡«å¯«å·²å®Œæˆï¼‰ã€‚</div>
          </div>
        </div>

        <div class="footer">
          <div class="tiny">KPI% ä»¥ã€Œä»»å‹™åˆ†æ•¸è‡ªå‹•æ­£è¦åŒ–ï¼ˆç¸½å’Œ=100ï¼‰ã€è¨ˆç®—ï¼›å€‹äººç›®æ¨™äº¦æ›ç®—ç‚ºç™¾åˆ†æ¯”ï¼ˆæœªè¨­å®šè€…è¦–ç‚º 100%ï¼‰ã€‚</div>
          <button class="btn" type="submit">å„²å­˜ç´€éŒ„</button>
        </div>
      </form>
    </section>

    <!-- è¦–è¦ºåŒ– + æ¯æœˆç¸½è¡¨ -->
    <div class="grid grid-2">
      <section class="card">
        <h2>è¦–è¦ºåŒ–ç¸½è¦½</h2>
        <div class="row row-2" style="margin-bottom:8px;">
          <div class="input-inline">
            <label for="month">æœˆä»½</label>
            <input type="month" id="month" />
          </div>
          <div class="input-inline">
            <label for="filterName">å§“å</label>
            <input type="text" id="filterName" placeholder="ç¯©é¸å§“åï¼ˆå¯ç•™ç©ºï¼‰" />
          </div>
        </div>
        <canvas id="chartByPerson" height="140"></canvas>
        <canvas id="chartByTask" height="140"></canvas>
      </section>

      <section class="card">
        <h2>æ¯æœˆç¸½è¡¨ï¼ˆä¾äººå½™ç¸½ï¼‰èˆ‡è¨­å®š</h2>
        <div class="row row-2">
          <div>
            <label>é”æ¨™é–€æª»ï¼ˆ%ï¼‰</label>
            <input type="number" id="threshold" min="0" max="100" step="1" />
            <div class="tiny">å„ªç§€ â‰¥ é–€æª»Ã—1.333ï¼›é”æ¨™ â‰¥ é–€æª»ï¼›å…¶é¤˜æœªé”æ¨™ã€‚</div>
          </div>
          <div>
            <label>å¿«é€Ÿæ“ä½œ</label>
            <div class="pill"><span>ç•¶å‰æœˆä»½ï¼š</span><span id="pillMonth">â€”</span></div>
            <div class="switch" style="margin-top:8px;">
              <input type="checkbox" id="onlyUnder" />
              <label for="onlyUnder">åªé¡¯ç¤ºæœªé”æ¨™</label>
            </div>
          </div>
        </div>
        <div style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>å§“å</th>
                <th>å®Œæˆç‡</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="tbody-under"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ä»»å‹™ç®¡ç†ï¼ˆåƒ…ç®¡ç†è€…ï¼‰ -->
    <section class="card" style="margin-top:16px;" data-admin-section>
      <h2>ä»»å‹™é¡å‹ç®¡ç†</h2>
      <div class="row row-3">
        <div>
          <label>ä»»å‹™åç¨±</label>
          <input type="text" id="mTaskName" placeholder="ä¾‹å¦‚ï¼šå½±ç‰‡å‰ªè¼¯" />
        </div>
        <div>
          <label>å–®ä»¶åˆ†æ•¸</label>
          <input type="number" id="mTaskScore" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š30" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button class="btn" id="addTask" data-admin-action>æ–°å¢ / æ›´æ–°ä»»å‹™</button>
          <button class="btn-outline" id="resetDefaults" data-admin-action>æ¢å¾©é è¨­ä»»å‹™</button>
        </div>
      </div>
      <div class="scroll-area" style="margin-top:12px;">
        <table>
          <thead><tr><th>ä»»å‹™</th><th>åˆ†æ•¸</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="tbody-tasks"></tbody>
        </table>
      </div>
      <div class="tiny" style="margin-top:8px;">æ­£è¦åŒ–åƒ…ç”¨æ–¼ KPI è¨ˆç®—ï¼›åœ–è¡¨èˆ‡æ˜ç´°ä»é¡¯ç¤ºåŸå§‹åˆ†ã€‚</div>
    </section>

    <!-- å“¡å·¥ç›®æ¨™è¨­å®šï¼ˆåƒ…ç®¡ç†è€…ï¼‰ -->
    <section class="card" style="margin-top:16px;" data-admin-section>
      <h2>å“¡å·¥ç›®æ¨™è¨­å®šï¼ˆæ¯æœˆç›®æ¨™åˆ†ï¼‰</h2>
      <div class="row row-3">
        <div>
          <label>å“¡å·¥å§“å</label>
          <input type="text" id="tName" list="empList" placeholder="è¼¸å…¥æˆ–é¸æ“‡æ—¢æœ‰å§“å" />
        </div>
        <div>
          <label>æ¯æœˆç›®æ¨™åˆ†</label>
          <input type="number" id="tPoints" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š300" />
        </div>
        <div>
          <label>è§’è‰²èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="tNote" placeholder="ä¾‹å¦‚ï¼šå‰ªè¼¯ä¸»åŠ›ã€ä»¶æ•¸å°‘é›£åº¦é«˜" />
        </div>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="saveTarget" data-admin-action>å„²å­˜ / æ›´æ–°ç›®æ¨™</button>
        <button class="btn-delete btn-s" id="deleteTarget" data-admin-action>åˆªé™¤è©²å“¡å·¥ç›®æ¨™</button>
      </div>
      <div class="scroll-area" style="margin-top:12px;">
        <table>
          <thead><tr><th>å§“å</th><th>ç›®æ¨™åˆ†</th><th>è§’è‰²èªªæ˜</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="tbody-targets"></tbody>
        </table>
      </div>
      <div class="tiny" style="margin-top:8px;">æœªè¨­å®šè€…ä¹‹ã€Œç›®æ¨™%ã€= 100%ï¼ˆç­‰æ–¼ä»¥ä»»å‹™åˆ†ç¸½å’Œä½œç‚ºç›®æ¨™ï¼‰ã€‚</div>
    </section>

    <!-- å“¡å·¥ç®¡ç†ï¼ˆåƒ…ç®¡ç†è€…ï¼‰ -->
    <section class="card" style="margin-top:16px;" data-admin-section>
      <h2>å“¡å·¥ç®¡ç†</h2>
      <div class="row row-2">
        <div>
          <label>å“¡å·¥å§“å</label>
          <input type="text" id="mEmpName" placeholder="ä¾‹å¦‚ï¼šå“¡å·¥A" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button class="btn" id="addEmp" data-admin-action>æ–°å¢ / æ›´æ–°å“¡å·¥</button>
          <button class="btn-outline" id="clearEmp" data-admin-action>æ¸…ç©ºåå–®</button>
        </div>
      </div>
      <div class="scroll-area" style="margin-top:12px;">
        <table>
          <thead><tr><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="tbody-emp"></tbody>
        </table>
      </div>
      <div class="tiny">å¡«å ±è¡¨å–®çš„ã€Œå§“åã€æ¬„æœƒé¡¯ç¤ºæ­¤åå–®åšç‚ºè‡ªå‹•å®Œæˆå»ºè­°ã€‚</div>
    </section>

    <!-- ç´€éŒ„æ˜ç´° -->
    <section class="card" style="margin-top:16px;">
      <h2>ç´€éŒ„æ˜ç´°</h2>
      <table>
        <thead id="thead-records">
          <tr>
            <th>å–®è™Ÿ</th>
            <th>æ—¥æœŸ</th>
            <th>å§“å</th>
            <th>ä»»å‹™</th>
            <th>ä»¶æ•¸</th>
            <th>å–®ä»¶åˆ†</th>
            <th>ç¸½åˆ†</th>
            <th>é€²åº¦</th>
            <th>å‚™è¨»</th>
            <th data-admin-action>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
      <!-- åˆ†é æ§åˆ¶ -->
      <div id="pager" style="display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button id="prevPage" class="btn-outline btn-s">ä¸Šä¸€é </button>
        <span id="pageInfo" class="tiny">ç¬¬ 1 / 1 é </span>
        <button id="nextPage" class="btn-outline btn-s">ä¸‹ä¸€é </button>
      </div>
    </section>
  </div>

  <!-- ç™»å…¥ Modal -->
  <div id="kpi-login-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="ç™»å…¥">
      <h3>ç™»å…¥</h3>
      <div class="seg" role="radiogroup" aria-label="é¸æ“‡è§’è‰²">
        <label>
          <input type="radio" name="kpi-role" value="user" checked />
          <div class="opt">ğŸ‘¤ ä½¿ç”¨è€…</div>
        </label>
        <label>
          <input type="radio" name="kpi-role" value="admin" />
          <div class="opt">ğŸ› ï¸ ç®¡ç†è€…</div>
        </label>
      </div>
      <div class="kpi-row" id="kpi-pass-row" style="display:none;">
        <input id="kpi-admin-pass" type="password" placeholder="ç®¡ç†è€…å¯†ç¢¼ï¼ˆé è¨­ï¼š123ï¼‰" />
      </div>
      <div class="tiny" style="margin-top:4px;">ç®¡ç†è€…æ“æœ‰ï¼šä»»å‹™ï¼å“¡å·¥ï¼ç›®æ¨™ç¶­è­·ã€ç·¨è¼¯/åˆªé™¤ç´€éŒ„ã€åŒ¯å‡ºèˆ‡æ¸…é™¤è³‡æ–™ç­‰æ¬Šé™ã€‚</div>
      <div class="kpi-actions">
        <button id="kpi-cancel" class="btn-ghost">å–æ¶ˆ</button>
        <button id="kpi-confirm" class="btn">ç™»å…¥</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯ç´€éŒ„ Modalï¼ˆç®¡ç†è€…ï¼‰ -->
  <div id="edit-modal" class="kpi-modal hidden" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="ç·¨è¼¯ç´€éŒ„">
      <h3>ç·¨è¼¯ç´€éŒ„</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-id" />
        <div class="row row-2">
          <div>
            <label>å–®è™Ÿ</label>
            <input type="text" id="edit-orderNo" required />
          </div>
          <div>
            <label>æ—¥æœŸ</label>
            <input type="date" id="edit-date" required />
          </div>
        </div>
        <div class="row row-2">
          <div>
            <label>å§“å</label>
            <input type="text" id="edit-name" list="empList" required />
          </div>
          <div>
            <label>ä»»å‹™é¡å‹</label>
            <select id="edit-task" required></select>
          </div>
        </div>
        <div class="row row-3">
          <div>
            <label>ä»¶æ•¸</label>
            <input type="number" id="edit-qty" min="1" required />
          </div>
          <div>
            <label>å–®ä»¶åˆ†ï¼ˆä¾ä»»å‹™ï¼‰</label>
            <input type="text" id="edit-scorePerItem" readonly />
          </div>
          <div>
            <label>å‚™è¨»</label>
            <input type="text" id="edit-note" />
          </div>
        </div>
        <!-- ç·¨è¼¯é€²åº¦ï¼ˆå…è¨±ä»»æ„åˆ‡æ›ï¼‰ -->
        <div class="row row-2">
          <div>
            <label>é€²åº¦</label>
            <select id="edit-stage" required>
              <option value="NOT_STARTED">æœªé–‹å§‹ï¼ˆ0%ï¼‰</option>
              <option value="IN_PROGRESS">é€²è¡Œä¸­ï¼ˆ50%ï¼‰</option>
              <option value="DONE">å·²å®Œæˆï¼ˆ100%ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="kpi-actions">
          <button type="button" id="edit-cancel" class="btn-ghost">å–æ¶ˆ</button>
          <button type="submit" class="btn">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== keys =====
    const KEY = "kpiRecords_v1";
    const TASKS_KEY = "kpiTasks_v1";
    const THRESHOLD_KEY = "kpiThreshold_v1";
    const EMP_KEY = "kpiEmployees_v1";
    const TARGETS_KEY = "kpiTargets_v1";

    // é€²åº¦å¸¸æ•¸
    const STAGE = {
      NOT_STARTED: { idx: 0, pct: 0,   label: 'æœªé–‹å§‹' },
      IN_PROGRESS: { idx: 1, pct: 50,  label: 'é€²è¡Œä¸­' },
      DONE:        { idx: 2, pct: 100, label: 'å·²å®Œæˆ' }
    };

    // é è¨­
    const DEFAULT_TASKS = {
      "å½±ç‰‡å‰ªè¼¯": 30, "æµ·å ±è¨­è¨ˆ": 10, "è¡›æ•™å–®å¼µ": 5,
      "PodcastéŒ„éŸ³å‰ªè¼¯": 20, "ç¶²é ç¶­è­·": 10, "æœƒè­°å®¤ç®¡ç†": 5, "æ‹ç…§/æ‹æ”æ”¯æ´": 15
    };
    const DEFAULT_EMPS = ["å“¡å·¥A","å“¡å·¥B","å“¡å·¥C"];

    // DOM
    const form = document.getElementById('form');
    const orderNoEl = document.getElementById('orderNo');
    const dateEl = document.getElementById('date');
    const nameEl = document.getElementById('name');
    const taskEl = document.getElementById('task');
    const qtyEl = document.getElementById('qty');
    const noteEl = document.getElementById('note');
    const autoScoreEl = document.getElementById('autoScore');
    const stageEl = document.getElementById('stage');

    const tbody = document.getElementById('tbody');
    const tfoot = document.getElementById('tfoot');
    const theadRecords = document.getElementById('thead-records');
    const monthEl = document.getElementById('month');
    const filterNameEl = document.getElementById('filterName');
    const chips = document.getElementById('chips');

    // æ¯æœˆç¸½è¡¨
    const thresholdEl = document.getElementById('threshold');
    const tbodyUnder = document.getElementById('tbody-under');
    const pillMonth = document.getElementById('pillMonth');
    const onlyUnderEl = document.getElementById('onlyUnder');

    // ä»»å‹™ç®¡ç†
    const mTaskName = document.getElementById('mTaskName');
    const mTaskScore = document.getElementById('mTaskScore');
    const addTaskBtn = document.getElementById('addTask');
    const resetDefaultsBtn = document.getElementById('resetDefaults');
    const tbodyTasks = document.getElementById('tbody-tasks');

    // å“¡å·¥ç®¡ç†
    const mEmpName = document.getElementById('mEmpName');
    const addEmpBtn = document.getElementById('addEmp');
    const clearEmpBtn = document.getElementById('clearEmp');
    const tbodyEmp = document.getElementById('tbody-emp');
    const empList = document.getElementById('empList');

    // ç›®æ¨™è¨­å®š
    const tName = document.getElementById('tName');
    const tPoints = document.getElementById('tPoints');
    const tNote = document.getElementById('tNote');
    const tbodyTargets = document.getElementById('tbody-targets');

    // ç™»å…¥/è§’è‰²
    const ADMIN_PASS = '123'; // â† è®Šæ›´å¯†ç¢¼
    const ROLE_KEY = 'kpi_role_v2';
    const roleBadge = document.getElementById('roleBadge');
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('kpi-login-modal');
    const passRow = document.getElementById('kpi-pass-row');
    const passInput = document.getElementById('kpi-admin-pass');
    const modalCancel = document.getElementById('kpi-cancel');
    const modalConfirm = document.getElementById('kpi-confirm');
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // ç·¨è¼¯ç´€éŒ„ Modal
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editId = document.getElementById('edit-id');
    const editOrderNo = document.getElementById('edit-orderNo');
    const editDate = document.getElementById('edit-date');
    const editName = document.getElementById('edit-name');
    const editTask = document.getElementById('edit-task');
    const editQty = document.getElementById('edit-qty');
    const editScorePerItem = document.getElementById('edit-scorePerItem');
    const editNote = document.getElementById('edit-note');
    const editStage = document.getElementById('edit-stage');
    const editCancel = document.getElementById('edit-cancel');

    // åˆ†é 
    const PAGE_SIZE = 20;
    let currentPage = 1;
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoEl = document.getElementById('pageInfo');

    // å·¥å…·
    const read = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const load = ()=> read(KEY, []);
    const save = list => write(KEY, list);

    // åˆå§‹åŒ–
    function ensureInit(){
      if(!read(TASKS_KEY)) write(TASKS_KEY, DEFAULT_TASKS);
      if(read(THRESHOLD_KEY) == null) write(THRESHOLD_KEY, 80);
      if(!Array.isArray(read(EMP_KEY))) write(EMP_KEY, DEFAULT_EMPS);
      if(!read(TARGETS_KEY)) write(TARGETS_KEY, {});
    }
    ensureInit();

    // åˆå€¼
    dateEl.valueAsDate = new Date();
    monthEl.value = new Date().toISOString().slice(0,7);
    thresholdEl.value = read(THRESHOLD_KEY, 80);
    pillMonth.textContent = monthEl.value;
    stageEl.value = 'NOT_STARTED';

    // ===== è§’è‰² =====
    function getRole(){ return sessionStorage.getItem(ROLE_KEY) || 'user'; }
    function isAdmin(){ return getRole()==='admin'; }
    function applyRoleGate(){ thresholdEl.disabled = !isAdmin(); }
    function renderRecordsHead(){
      if(!theadRecords) return;
      theadRecords.innerHTML = `
        <tr>
          <th>å–®è™Ÿ</th>
          <th>æ—¥æœŸ</th>
          <th>å§“å</th>
          <th>ä»»å‹™</th>
          <th>ä»¶æ•¸</th>
          <th>å–®ä»¶åˆ†</th>
          <th>ç¸½åˆ†</th>
          <th>é€²åº¦</th>
          <th>å‚™è¨»</th>
          ${isAdmin() ? '<th>æ“ä½œ</th>' : ''}
        </tr>`;
    }
    function setRole(role){
      sessionStorage.setItem(ROLE_KEY, role);
      document.body.setAttribute('data-role', role);
      roleBadge.textContent = 'è§’è‰²ï¼š' + (role==='admin'?'ç®¡ç†è€…':'ä½¿ç”¨è€…');
      loginBtn.innerHTML = (role==='admin' ? 'ğŸšª ç™»å‡º' : 'ğŸ” ç™»å…¥');
      applyRoleGate(); renderRecordsHead(); currentPage = 1; render();
    }

    // ç™»å…¥ UI
    function openLogin(){
      loginModal.classList.remove('hidden'); loginModal.setAttribute('aria-hidden','false');
      const current = getRole();
      $$('input[name="kpi-role"]').forEach(r=> r.checked = (r.value===current) );
      passRow.style.display = (current==='admin') ? 'block' : 'none';
      if (current==='admin') passInput.focus();
    }
    function closeLogin(){ loginModal.classList.add('hidden'); loginModal.setAttribute('aria-hidden','true'); passInput.value=''; }
    $$('input[name="kpi-role"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        passRow.style.display = (r.value==='admin')?'block':'none';
        if(r.value==='admin') passInput.focus();
      });
    });
    loginBtn.addEventListener('click', ()=>{
      if(isAdmin()){ setRole('user'); return; }
      openLogin();
    });
    modalCancel.addEventListener('click', closeLogin);
    loginModal.addEventListener('click', (e)=>{ if(e.target===loginModal) closeLogin(); });
    modalConfirm.addEventListener('click', ()=>{
      const picked = ($$('input[name="kpi-role"]').find(x=>x.checked)||{}).value || 'user';
      if(picked==='admin' && passInput.value!==ADMIN_PASS){ alert('ç®¡ç†è€…å¯†ç¢¼éŒ¯èª¤'); return; }
      setRole(picked); closeLogin();
    });

    // è‡ªå‹•å¾—åˆ†
    function updateAutoScore(){
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const s = tasks[taskEl.value] || 0;
      const q = Number(qtyEl.value || 0);
      autoScoreEl.value = (s && q) ? (s*q) : '';
    }
    taskEl.addEventListener('change', updateAutoScore);
    qtyEl.addEventListener('input', updateAutoScore);

    // ä»»å‹™ UI
    let editingTaskKey = null;
    function resetTaskEditState(){
      editingTaskKey = null;
      if(mTaskName) mTaskName.value = '';
      if(mTaskScore) mTaskScore.value = '';
      if(addTaskBtn){ addTaskBtn.textContent = 'æ–°å¢ / æ›´æ–°ä»»å‹™'; delete addTaskBtn.dataset.mode; }
    }
    function rebuildTaskUI(){
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      taskEl.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>' +
        Object.entries(tasks).map(([k,v])=>`<option value="${k}">${k}</option>`).join('');
      const editTaskEl = document.getElementById('edit-task');
      if (editTaskEl){
        editTaskEl.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>' +
          Object.entries(tasks).map(([k,v])=>`<option value="${k}">${k}</option>`).join('');
      }
      chips.innerHTML = Object.entries(tasks).map(([k,v])=>`<span class="chip">${k} ${v}</span>`).join('');
      if(tbodyTasks){
        tbodyTasks.innerHTML = Object.entries(tasks).map(([k,v])=>`
          <tr>
            <td>${k}</td>
            <td>${v}</td>
            <td class="actions">
              <button class="btn-edit btn-s" data-edit="${k}" data-admin-action>ç·¨è¼¯</button>
              <button class="btn-delete btn-s" data-del="${k}" data-admin-action>åˆªé™¤</button>
            </td>
          </tr>`).join('');
        tbodyTasks.querySelectorAll('button[data-edit]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
            const t = read(TASKS_KEY, DEFAULT_TASKS);
            editingTaskKey = b.dataset.edit;
            mTaskName.value = editingTaskKey;
            mTaskScore.value = t[editingTaskKey];
            addTaskBtn.textContent = 'æ›´æ–°ä»»å‹™';
            addTaskBtn.dataset.mode = 'edit';
            mTaskName.focus();
          });
        });
        tbodyTasks.querySelectorAll('button[data-del]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
            const key=b.dataset.del;
            const t=read(TASKS_KEY, DEFAULT_TASKS);
            delete t[key]; write(TASKS_KEY, t);
            if(editingTaskKey===key) resetTaskEditState();
            rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
          });
        });
      }
    }

    // å“¡å·¥ UI
    function rebuildEmpUI(){
      const emps = read(EMP_KEY, DEFAULT_EMPS);
      empList.innerHTML = emps.map(n=>`<option value="${n}">`).join('');
      if(tbodyEmp){
        tbodyEmp.innerHTML = emps.map(n=>`
          <tr>
            <td>${n}</td>
            <td class="actions">
              <button class="btn-delete btn-s" data-del-emp="${n}" data-admin-action>åˆªé™¤</button>
            </td>
          </tr>`).join('');
        tbodyEmp.querySelectorAll('button[data-del-emp]').forEach(b=>{
          b.addEventListener('click',()=>{
            if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
            let list=read(EMP_KEY, DEFAULT_EMPS);
            list=list.filter(x=>x!==b.dataset.delEmp);
            write(EMP_KEY, list);
            rebuildEmpUI();
          });
        });
      }
    }

    // ä»»å‹™æ–°å¢/æ›´æ–°
    if(addTaskBtn){
      addTaskBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
        const name = (mTaskName.value||'').trim();
        const score = Number(mTaskScore.value);
        if(!name || !Number.isFinite(score) || score<0){ alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»»å‹™åç¨±èˆ‡åˆ†æ•¸'); return; }
        const t = read(TASKS_KEY, DEFAULT_TASKS) || {};
        if(addTaskBtn.dataset.mode==='edit' && editingTaskKey){
          if(editingTaskKey!==name && Object.hasOwn(t, editingTaskKey)) delete t[editingTaskKey];
          t[name] = Math.round(score);
          write(TASKS_KEY, t);
          resetTaskEditState();
        }else{
          t[name] = Math.round(score);
          write(TASKS_KEY, t);
        }
        rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render();
      });
    }

    // æ¢å¾©é è¨­
    if(resetDefaultsBtn){
      resetDefaultsBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
        if(confirm('ç¢ºå®šæ¢å¾©ç‚ºé è¨­ä»»å‹™ï¼Ÿ')){ write(TASKS_KEY, DEFAULT_TASKS); resetTaskEditState(); rebuildTaskUI(); rebuildTargetsTable(); updateAutoScore(); currentPage=1; render(); }
      });
    }

    // å“¡å·¥æ–°å¢/æ¸…ç©º
    if(addEmpBtn){
      addEmpBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
        const n=(mEmpName.value||'').trim();
        if(!n){ alert('è«‹è¼¸å…¥å“¡å·¥å§“å'); return; }
        const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(n);
        write(EMP_KEY, Array.from(set)); mEmpName.value=''; rebuildEmpUI();
      });
    }
    if(clearEmpBtn){
      clearEmpBtn.addEventListener('click', ()=>{
        if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
        if(confirm('ç¢ºå®šæ¸…ç©ºåå–®ï¼Ÿ')){ write(EMP_KEY, []); rebuildEmpUI(); }
      });
    }

    // è¨­å®šè®Šæ›´
    monthEl.addEventListener('change', ()=>{ pillMonth.textContent = monthEl.value; currentPage=1; render(); });
    filterNameEl.addEventListener('input', ()=>{ currentPage=1; render(); });
    thresholdEl.addEventListener('input', ()=>{
      if(!isAdmin()){ thresholdEl.value = read(THRESHOLD_KEY, 80); alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      write(THRESHOLD_KEY, Number(thresholdEl.value||0)); render();
    });
    onlyUnderEl.addEventListener('change', render);

    // ===== æ–°å¢ç´€éŒ„ï¼ˆå–®è™Ÿå”¯ä¸€ï¼›é€²åº¦å…è¨±ä»»æ„é¸æ“‡ï¼‰ =====
    form.addEventListener('submit', (e)=>{
      e.preventDefault();

      const orderNo = orderNoEl.value.trim();
      if(!orderNo){ alert('è«‹è¼¸å…¥å–®è™Ÿ'); return; }

      // é˜»æ“‹é‡è¤‡å–®è™Ÿ
      const exists = load().some(r=> (r.orderNo || '').trim() === orderNo);
      if(exists){
        alert('æ­¤å–®è™Ÿå·²å­˜åœ¨ï¼Œè«‹ç”¨ã€Œç·¨è¼¯ã€æ›´æ–°ï¼Œç¦æ­¢é‡è¤‡å¡«å¯«ã€‚');
        return;
      }

      const pickedStage = (stageEl.value || 'NOT_STARTED');

      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const scorePerItem = tasks[taskEl.value] || 0;
      const qty = Number(qtyEl.value);
      const total = scorePerItem * qty;

      const rec = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        orderNo,
        date: dateEl.value,
        name: nameEl.value.trim(),
        task: taskEl.value,
        qty, scorePerItem, total,
        note: (noteEl.value||'').trim(),
        stage: pickedStage,
        stagePct: (STAGE[pickedStage]?.pct ?? 0)
      };
      const list = load(); list.push(rec); save(list);

      // åå–®å¸¶å…¥
      const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(rec.name); write(EMP_KEY, Array.from(set)); rebuildEmpUI();

      form.reset(); dateEl.valueAsDate = new Date(); autoScoreEl.value=''; stageEl.value='NOT_STARTED';
      currentPage=1; render(); alert('å·²å„²å­˜');
    });

    // åˆªé™¤ç´€éŒ„
    function removeOne(id){
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      save(load().filter(r=>r.id!==id));
      // è‹¥åˆªåˆ°æœ€å¾Œä¸€é åªå‰©ç©ºï¼Œå¾€å‰ç§»ä¸€é 
      currentPage = Math.min(currentPage, getTotalPages(applyFilters(load())) || 1);
      render();
    }

    // åŒ¯å‡º CSV / æ¸…ç©º
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const list = load();
      const header = ['å–®è™Ÿ','æ—¥æœŸ','å§“å','ä»»å‹™','ä»¶æ•¸','å–®ä»¶åˆ†','ç¸½åˆ†','é€²åº¦','é€²åº¦%','å‚™è¨»'];
      const rows = list.map(r=>[
        r.orderNo,r.date,r.name,r.task,r.qty,r.scorePerItem,r.total,
        STAGE[r.stage]?.label || '', STAGE[r.stage]?.pct ?? '',
        (r.note||'').replace(/\n/g,' ')
      ]);
      const csv = [header,...rows].map(a=>a.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='KPI_Export.csv'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸ')){
        localStorage.removeItem(KEY);
        currentPage=1; render();
      }
    });

    // åœ–è¡¨
    let chartByPerson, chartByTask;
    function drawCharts(list){
      const byPerson={}, byTask={};
      list.forEach(r=>{ byPerson[r.name]=(byPerson[r.name]||0)+r.total; byTask[r.task]=(byTask[r.task]||0)+r.total; });
      const ctx1=document.getElementById('chartByPerson');
      const ctx2=document.getElementById('chartByTask');
      if(chartByPerson) chartByPerson.destroy();
      if(chartByTask) chartByTask.destroy();
      chartByPerson = new Chart(ctx1,{type:'bar',data:{labels:Object.keys(byPerson),datasets:[{label:'ç¸½åˆ†',data:Object.values(byPerson)}]},options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false},title:{display:true,text:'å„äººç¸½åˆ†'}}}});
      chartByTask = new Chart(ctx2,{type:'pie',data:{labels:Object.keys(byTask),datasets:[{data:Object.values(byTask)}]},options:{responsive:true,plugins:{title:{display:true,text:'ä»»å‹™åˆ†æ•¸åˆ†å¸ƒ'}}}});
    }

    // ç›®æ¨™
    const loadTargets = () => read(TARGETS_KEY, {}) || {};
    const saveTargets = (obj) => write(TARGETS_KEY, obj);
    function rebuildTargetsTable(){
      const targets = loadTargets();
      const rows = Object.entries(targets);
      if(!tbodyTargets) return;
      tbodyTargets.innerHTML = rows.length
        ? rows.map(([n, obj])=>`
          <tr>
            <td>${n}</td>
            <td>${obj.points ?? ''}</td>
            <td style="text-align:left">${(obj.note||'').replace(/</g,'&lt;')}</td>
            <td class="actions">
              <button class="btn-edit btn-s" data-fill="${n}">å¸¶å…¥</button>
              <button class="btn-delete btn-s" data-del="${n}" data-admin-action>åˆªé™¤</button>
            </td>
          </tr>`).join('')
        : `<tr><td colspan="4" class="tiny">å°šæœªè¨­å®šä»»ä½•ç›®æ¨™ï¼›æœªè¨­å®šè€…çš„ç›®æ¨™% æœƒè¦–ç‚º 100%ã€‚</td></tr>`;
      tbodyTargets.querySelectorAll('button[data-fill]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const n=b.dataset.fill;
          const t = loadTargets()[n] || {};
          tName.value = n;
          tPoints.value = t.points ?? '';
          tNote.value = t.note || '';
          tName.focus();
        });
      });
      tbodyTargets.querySelectorAll('button[data-del]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
          const n=b.dataset.del;
          const all = loadTargets();
          if(all[n] && confirm(`åˆªé™¤ ${n} çš„ç›®æ¨™è¨­å®šï¼Ÿ`)){
            delete all[n];
            saveTargets(all);
            rebuildTargetsTable();
            render();
          }
        });
      });
    }

    // KPI æ¨™ç±¤
    function statusTag(score, th){
      if(score >= th*1.333) return '<span class="tag ok">å„ªç§€</span>';
      if(score >= th) return '<span class="tag warn">é”æ¨™</span>';
      return '<span class="tag bad">æœªé”æ¨™</span>';
    }

    // ç·¨è¼¯ç´€éŒ„ï¼ˆå…è¨±ä»»æ„åˆ‡æ›ï¼‰
    function openEditModal(rec){
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      editId.value = rec.id;
      editOrderNo.value = rec.orderNo || '';
      editDate.value = rec.date || '';
      editName.value = rec.name || '';
      editTask.value = rec.task || '';
      editQty.value = rec.qty || 1;
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const spi = Number.isFinite(tasks[rec.task]) ? tasks[rec.task] : (rec.scorePerItem||0);
      editScorePerItem.value = spi;
      editNote.value = rec.note || '';
      editStage.value = rec.stage || 'NOT_STARTED';
      editModal.classList.remove('hidden'); editModal.setAttribute('aria-hidden','false');
    }
    function closeEditModal(){ editModal.classList.add('hidden'); editModal.setAttribute('aria-hidden','true'); }
    document.getElementById('edit-task').addEventListener('change', ()=>{
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      editScorePerItem.value = tasks[document.getElementById('edit-task').value] || 0;
    });
    editCancel.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeEditModal(); });
    editForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const id = editId.value;
      let list = load();
      const idx = list.findIndex(r=>r.id===id);
      if(idx<0){ alert('æ‰¾ä¸åˆ°è©²ç­†ç´€éŒ„'); closeEditModal(); return; }

      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const newTask = document.getElementById('edit-task').value;
      const newQty = Number(editQty.value)||0;
      const newScorePerItem = Number.isFinite(tasks[newTask]) ? tasks[newTask] : (list[idx].scorePerItem||0);
      const newTotal = newScorePerItem * newQty;

      // å–®è™Ÿå”¯ä¸€ï¼šè‹¥ä¿®æ”¹å–®è™Ÿï¼Œéœ€ç¢ºèªæ²’æœ‰é‡è¤‡
      const newOrder = (editOrderNo.value||'').trim();
      if(newOrder !== list[idx].orderNo){
        const dup = list.some((r,i)=> i!==idx && (r.orderNo||'').trim()===newOrder);
        if(dup){ alert('æ­¤å–®è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å–®è™Ÿ'); return; }
      }

      const newStageKey = editStage.value || 'NOT_STARTED';

      list[idx] = {
        ...list[idx],
        orderNo: newOrder,
        date: editDate.value,
        name: (editName.value||'').trim(),
        task: newTask,
        qty: newQty,
        scorePerItem: newScorePerItem,
        total: newTotal,
        note: (editNote.value||'').trim(),
        stage: newStageKey,
        stagePct: STAGE[newStageKey]?.pct ?? 0
      };
      save(list);

      const set=new Set(read(EMP_KEY, DEFAULT_EMPS)); set.add(list[idx].name); write(EMP_KEY, Array.from(set)); rebuildEmpUI();
      closeEditModal();
      render();
      alert('å·²æ›´æ–°');
    });

    // ===== ç¯©é¸å™¨ï¼šå›å‚³ä¾æœˆä»½/å§“åéæ¿¾å¾Œçš„æ–°é™£åˆ— =====
    function applyFilters(list){
      let out = list.slice();
      const ym = monthEl.value;
      if(ym){ out = out.filter(r=> (r.date||'').startsWith(ym)); }
      const kw = (filterNameEl.value||'').trim();
      if(kw){ out = out.filter(r=> r.name.includes(kw)); }
      return out;
    }

    // ===== åˆ†é å·¥å…· =====
    function getTotalPages(list){ return Math.max(1, Math.ceil(list.length / PAGE_SIZE)); }
    function updatePager(totalPages){
      pageInfoEl.textContent = `ç¬¬ ${totalPages ? currentPage : 1} / ${totalPages} é `;
      prevPageBtn.disabled = (currentPage <= 1);
      nextPageBtn.disabled = (currentPage >= totalPages);
    }
    prevPageBtn.addEventListener('click', ()=>{
      if(currentPage > 1){ currentPage--; render(); }
    });
    nextPageBtn.addEventListener('click', ()=>{
      const totalPages = getTotalPages(applyFilters(load()));
      if(currentPage < totalPages){ currentPage++; render(); }
    });

    // æ¸²æŸ“
    function render(){
      const admin = isAdmin();
      let list = load();

      // å…¼å®¹èˆŠè³‡æ–™ï¼šè‹¥æ²’æœ‰ stage æ¬„ä½ï¼Œè£œä¸Š NOT_STARTED
      let patched = false;
      list.forEach(r=>{
        if(!r.stage){ r.stage = 'NOT_STARTED'; r.stagePct = 0; patched = true; }
      });
      if(patched) save(list);

      // æ‡‰ç”¨ç¯©é¸å¾Œå†åšåˆ†é 
      const filtered = applyFilters(list);
      const totalPages = getTotalPages(filtered);
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageList = filtered.slice(start, end);

      // ===== æ˜ç´°è¡¨æ ¼ï¼ˆåƒ…æ¸²æŸ“ç•¶é  20 ç­†ï¼‰ =====
      tbody.innerHTML = pageList.map(r=>{
        const stageKey = r.stage || 'NOT_STARTED';
        const stageText = (STAGE[stageKey]?.label || '');
        const stagePct = (STAGE[stageKey]?.pct ?? 0);
        return `
        <tr data-stage="${stageKey}">
          <td>${r.orderNo||''}</td>
          <td>${r.date||''}</td>
          <td>${r.name||''}</td>
          <td>${r.task||''}</td>
          <td>${r.qty||''}</td>
          <td>${r.scorePerItem||''}</td>
          <td>${r.total||''}</td>
          <td>${stageText}ï¼ˆ${stagePct}%ï¼‰</td>
          <td>${(r.note||'').replace(/</g,'&lt;')}</td>
          ${admin ? `<td class="actions">
                       <button class="btn-edit btn-s" data-edit-id="${r.id}" data-admin-action>ç·¨è¼¯</button>
                       <button class="btn-delete btn-s" data-id="${r.id}" data-admin-action>åˆªé™¤</button>
                     </td>` : ``}
        </tr>`;
      }).join('') || `<tr><td colspan="${admin?10:9}" class="tiny">æœ¬æœˆå°šç„¡è³‡æ–™</td></tr>`;

      // ç¶å®šç•¶é æŒ‰éˆ•
      if (admin){
        tbody.querySelectorAll('button[data-id]').forEach(btn=> btn.addEventListener('click', ()=> removeOne(btn.dataset.id)));
        tbody.querySelectorAll('button[data-edit-id]').forEach(btn=> btn.addEventListener('click', ()=>{
          const id = btn.dataset.editId;
          const rec = load().find(x=>x.id===id);
          if(rec) openEditModal(rec);
        }));
      }

      // ç•¶é åˆè¨ˆ
      const totals = pageList.reduce((acc, r) => {
        acc.qty += Number(r.qty)||0;
        acc.score += Number(r.total)||0;
        return acc;
      }, {qty:0, score:0});
      if(pageList.length){
        tfoot.innerHTML = admin
          ? `<tr>
               <td colspan="4" style="text-align:right;">ç•¶é åˆè¨ˆ</td>
               <td>${totals.qty}</td>
               <td></td>
               <td>${totals.score}</td>
               <td></td>
               <td></td>
               <td></td>
             </tr>`
          : `<tr>
               <td colspan="4" style="text-align:right;">ç•¶é åˆè¨ˆ</td>
               <td>${totals.qty}</td>
               <td></td>
               <td>${totals.score}</td>
               <td></td>
               <td></td>
             </tr>`;
      }else{
        tfoot.innerHTML = '';
      }

      // åˆ†é è³‡è¨Š
      updatePager(totalPages);

      // åœ–è¡¨ï¼ˆä»æ¡ç”¨ã€Œç¯©é¸å¾Œçš„å…¨éƒ¨è³‡æ–™ã€ï¼Œéåƒ…ç•¶é ï¼‰
      drawCharts(filtered);

      // ===== æ¯æœˆç¸½è¡¨ï¼ˆæ­£è¦åŒ–ã€é”æ¨™åˆ†é¡ï¼‰ â€” ä»ç”¨ç¯©é¸å¾Œå…¨éƒ¨è³‡æ–™ =====
      const tasks = read(TASKS_KEY, DEFAULT_TASKS);
      const sumTask = Object.values(tasks).reduce((a,b)=>a+b,0);

      const normSumByName = {};
      if(sumTask > 0){
        filtered.forEach(r=>{
          const unitNorm = (r.scorePerItem || 0) / sumTask * 100;
          const add = unitNorm * (Number(r.qty)||0);
          normSumByName[r.name] = (normSumByName[r.name]||0) + add;
        });
      }else{
        filtered.forEach(r=>{ normSumByName[r.name] = 0; });
      }

      const allNames = new Set(read(EMP_KEY, DEFAULT_EMPS));
      Object.keys(normSumByName).forEach(n=> allNames.add(n));

      const targets = read(TARGETS_KEY, {}) || {};
      function personTargetPercent(name){
        if(sumTask <= 0) return 100;
        const targetPoints = targets[name]?.points;
        if(targetPoints == null || !Number.isFinite(targetPoints)) return 100;
        return Math.max(0, (targetPoints / sumTask) * 100);
      }

      const th = read(THRESHOLD_KEY, 80);

      let rows = Array.from(allNames).map(n=>{
        const normTotal = normSumByName[n] || 0;
        const targetPct = personTargetPercent(n) || 1;
        const kpiPct = Math.min(100, Math.round(normTotal / targetPct * 100));
        const tag = statusTag(kpiPct, th);
        const isUnder = kpiPct < th;
        return { n, s: kpiPct, tag, isUnder };
      });

      if (onlyUnderEl.checked) rows = rows.filter(r=> r.isUnder);
      rows.sort((a,b)=> b.s - a.s);
      tbodyUnder.innerHTML = rows.length
        ? rows.map(r=> `<tr><td>${r.n}</td><td>${r.s}%</td><td>${r.tag}</td></tr>`).join('')
        : `<tr><td colspan="3" class="tiny">${onlyUnderEl.checked ? 'ç•¶æœˆç„¡æœªé”æ¨™äººå“¡' : 'æœ¬æœˆå°šç„¡è³‡æ–™'}</td></tr>`;
    }

    // ç›®æ¨™å„²å­˜/åˆªé™¤
    document.getElementById('saveTarget')?.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const n = (tName.value||'').trim();
      const p = Number(tPoints.value);
      const note = (tNote.value||'').trim();
      if(!n || !Number.isFinite(p) || p<0){ alert('è«‹å¡«å§“åèˆ‡æœ‰æ•ˆç›®æ¨™åˆ†'); return; }
      const all = read(TARGETS_KEY, {}) || {}; all[n] = { points: Math.round(p), note }; write(TARGETS_KEY, all);
      rebuildTargetsTable(); render(); alert('å·²å„²å­˜');
    });
    document.getElementById('deleteTarget')?.addEventListener('click', ()=>{
      if(!isAdmin()){ alert('è«‹å…ˆç™»å…¥ç®¡ç†è€…'); return; }
      const n = (tName.value||'').trim();
      if(!n){ alert('è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥è¦åˆªé™¤ä¹‹å§“å'); return; }
      const all = read(TARGETS_KEY, {}) || {};
      if(all[n]){ delete all[n]; write(TARGETS_KEY, all); rebuildTargetsTable(); render(); alert('å·²åˆªé™¤'); }
    });

    function boot(){
      setRole(getRole());
      rebuildTaskUI(); rebuildEmpUI(); rebuildTargetsTable();
      updateAutoScore();
    }
    boot();
  </script>
</body>
</html>
